<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>اتحاد طب بشري كفر الشيخ</title>

<!-- خطوط -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&family=Inter:wght@400;600;800&family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg1:#0f1217; --bg2:#0b0d11; --card:rgba(255,255,255,.05);
  --txt:#eef1f4; --mut:#a6acb3; --bor:rgba(255,255,255,.10);
  --acc:#10b981; --warn:#ef4444; --ok:#22c55e;
  --ring:rgba(16,185,129,.34);
  --r-xl:18px; --r-lg:14px; --r-md:10px;
  --pad:16px; --gap:12px; --blur:10px;
  --fs:16px;
  --shadow:0 10px 28px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.05);
}
:root.light{
  --bg1:#f7f7f9; --bg2:#ffffff; --card:#fff;
  --txt:#171a1f; --mut:#5e646b; --bor:rgba(0,0,0,.08);
  --ring:rgba(17,94,89,.20);
  --shadow:0 10px 24px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.9);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font: var(--fs)/1.7 "Cairo", system-ui, -apple-system, Segoe UI, Roboto;
  color:var(--txt);
  background:
    radial-gradient(1200px 600px at 10% -10%,rgba(59,130,246,.14),transparent),
    linear-gradient(160deg,var(--bg1),var(--bg2)) fixed;
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
}
body.ff-noto{font-family:"Noto Naskh Arabic", system-ui}
body.ff-inter{font-family:"Inter", system-ui}

a{color:#fff;text-decoration:underline 1px rgba(255,255,255,.35)}
a:hover{opacity:.9}

.topbar{
  position:sticky; top:0; z-index:30;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:10px 14px; border-bottom:1px solid var(--bor);
  background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.08));
  backdrop-filter:blur(var(--blur));
}
.brand{display:flex; align-items:center; gap:12px}
.logo{width:38px;height:38px; object-fit:contain; border-radius:50%;
  box-shadow:0 0 0 2px rgba(255,255,255,.08)}
.brand h1{font-size:18px; margin:0}
.role-badge{
  font-size:12px; color:var(--mut); border:1px solid var(--bor); padding:4px 10px;
  border-radius:999px; background:rgba(255,255,255,.05)
}

.container{max-width:980px; margin:0 auto; padding:18px}
.card{
  background:var(--card); border:1px solid var(--bor); border-radius:var(--r-xl);
  padding:var(--pad); box-shadow:var(--shadow); backdrop-filter:blur(var(--blur));
}

.grid{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap)}
@media(max-width:860px){ .grid{grid-template-columns:1fr} }

.row{display:flex; gap:var(--gap); flex-wrap:wrap; align-items:center}
.sep{height:1px; background:var(--bor); border-radius:999px; margin:10px 0}
.mut{color:var(--mut)}

input,select,button,textarea{
  border:1px solid var(--bor); border-radius:var(--r-lg);
  background:rgba(255,255,255,.04); color:var(--txt);
  padding:10px 12px; outline:none; transition:.15s;
}
input:focus,select:focus,textarea:focus{box-shadow:0 0 0 4px var(--ring)}
input.error{border-color:var(--warn); box-shadow:0 0 0 4px rgba(239,68,68,.20)}
label{display:block; margin:2px 2px 6px}

button{
  cursor:pointer; font-weight:700; border-radius:12px;
  background:linear-gradient(135deg,rgba(16,185,129,.98),rgba(245,158,11,.9));
  border:1px solid var(--bor); color:#fff; padding:10px 14px;
  box-shadow:0 10px 25px rgba(0,0,0,.18)
}
button.ghost{background:rgba(255,255,255,.06)}
button.warn{background:linear-gradient(135deg,#ef4444,#b91c1c)}
button.google{background:linear-gradient(135deg,#34a853,#0f9d58)}
button:disabled{opacity:.6; cursor:not-allowed}

.tabs{display:flex; gap:10px; border-bottom:1px dashed var(--bor); margin-bottom:12px}
.tab{padding:10px 14px; border-radius:12px 12px 0 0; cursor:pointer}
.tab.active{background:rgba(255,255,255,.06); box-shadow:var(--shadow)}

.view{display:none}
.view.active{display:block}

.alert{
  display:none; position:sticky; top:10px; z-index:40; margin:0 auto 10px;
  padding:12px 14px; border-radius:14px; border:1px solid rgba(239,68,68,.3);
  background:linear-gradient(180deg,rgba(239,68,68,.20),rgba(239,68,68,.10));
  color:#fee2e2
}
.alert.show{display:block}

.badge-mini{
  font-size:12px; padding:4px 8px; border:1px solid var(--bor);
  border-radius:999px; background:rgba(255,255,255,.05); color:var(--mut)
}

.field{position:relative}
.eye{
  position:absolute; left:10px; top:50%; transform:translateY(-50%);
  cursor:pointer; user-select:none; opacity:.75
}
.helper{font-size:12px; color:var(--mut); margin-top:6px}
.linklike{color:#fff; text-decoration:underline}
.right{display:flex; justify-content:flex-end}
.center{display:flex; align-items:center; justify-content:center}
</style>
</head>

<body>

<header class="topbar">
  <div class="brand">
    <img src="logo.png" alt="شعار" class="logo" onerror="this.style.display='none'">
    <h1>اتحاد طب بشري كفر الشيخ</h1>
  </div>
  <div class="role-badge" id="roleBadge">غير مسجل</div>
</header>

<main class="container">
  <!-- شريط تنبيهات -->
  <div id="globalAlert" class="alert"></div>

  <!-- علامات تبويب تظهر بعد الدخول -->
  <div id="tabs" class="tabs" style="display:none">
    <div class="tab active" data-view="homeView">الرئيسية</div>
    <div class="tab" data-view="profileView">الملف الشخصي</div>
    <div class="tab" data-view="settingsView">الإعدادات</div>
  </div>

  <!-- شاشة الدخول -->
  <section id="authView" class="view active">
    <div class="card">
      <h2 style="margin-top:0">تسجيل الدخول</h2>

      <div class="grid">
        <div class="field">
          <label>البريد الإلكتروني</label>
          <input id="inEmail" type="email" placeholder="you@example.com" autocomplete="email">
        </div>
        <div class="field">
          <label>كلمة السر</label>
          <span class="eye" id="eyeIn">👁️</span>
          <input id="inPass" type="password" placeholder="••••••••" autocomplete="current-password">
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <label>اللغة</label>
          <select id="langSelAuth">
            <option value="ar">العربية</option>
            <option value="en">English</option>
          </select>
        </div>
        <div class="right">
          <button id="btnEmailLogin">دخول بالبريد</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnGoogleLogin" class="google">دخول بحساب Google</button>
      </div>

      <div class="row" style="margin-top:8px; gap:20px">
        <a class="linklike" id="toSignUp">إنشاء حساب جديد</a>
        <a class="linklike" id="forgotLink">نسيت كلمة السر؟</a>
      </div>

      <div class="helper">* يلزم الموافقة على البريد في بعض الأحيان.</div>
    </div>
  </section>

  <!-- شاشة إنشاء حساب -->
  <section id="signupView" class="view">
    <div class="card">
      <h2 style="margin-top:0">إنشاء حساب</h2>
      <div class="grid">
        <div class="field">
          <label>الاسم الأول</label>
          <input id="suFirst" placeholder="مثال: محمود">
        </div>
        <div class="field">
          <label>اسم العائلة</label>
          <input id="suLast" placeholder="مثال: عمارة">
        </div>
        <div class="field">
          <label>البريد الإلكتروني</label>
          <input id="suEmail" type="email" placeholder="you@example.com" autocomplete="email">
        </div>
        <div class="field">
          <label>الموبايل</label>
          <input id="suPhone" inputmode="tel" placeholder="01xxxxxxxxx">
        </div>
        <div class="field">
          <label>الدفعة</label>
          <input id="suBatch" inputmode="numeric" placeholder="12">
        </div>
        <div class="field">
          <label>اللغة</label>
          <select id="langSelSignup">
            <option value="ar">العربية</option>
            <option value="en">English</option>
          </select>
        </div>

        <div class="field">
          <label>كلمة السر</label>
          <span class="eye" id="eyeUp">👁️</span>
          <input id="suPass" type="password" placeholder="8+ حروف/أرقام" autocomplete="new-password">
        </div>
        <div class="field">
          <label>تأكيد كلمة السر</label>
          <input id="suPass2" type="password" placeholder="إعادة كتابة كلمة السر" autocomplete="new-password">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnSignup" style="min-width:180px">إنشاء حساب بالبريد</button>
        <button id="btnGoogleSignup" class="google">إنشاء/إكمال بحساب Google</button>
        <a class="linklike" id="backToLogin">رجوع لتسجيل الدخول</a>
      </div>
    </div>
  </section>

  <!-- الرئيسية -->
  <section id="homeView" class="view">
    <div class="card">
      <h2 style="margin:0 0 8px">مرحبًا، <span id="helloName">عضو</span></h2>
      <div class="row" style="gap:8px">
        <span class="badge-mini">الحالة: <span id="badAuth">—</span></span>
        <span class="badge-mini">الدور: <span id="badRole">—</span></span>
      </div>
      <div class="sep"></div>
      <p class="mut">نسخة أولية — بعد تفعيل الصلاحيات هنضيف البوستات، حضور QR… إلخ.</p>
    </div>
  </section>

  <!-- الملف الشخصي -->
  <section id="profileView" class="view">
    <div class="card">
      <h3 style="margin-top:0">الملف الشخصي</h3>
      <div class="grid">
        <div>
          <label>الاسم الأول</label>
          <input id="pfFirst">
        </div>
        <div>
          <label>اسم العائلة</label>
          <input id="pfLast">
        </div>
        <div>
          <label>البريد</label>
          <input id="pfEmail" disabled>
        </div>
        <div>
          <label>الموبايل</label>
          <input id="pfPhone">
        </div>
        <div>
          <label>الدفعة</label>
          <input id="pfBatch">
        </div>
        <div>
          <label>صورة البروفايل (اختياري – URL)</label>
          <input id="pfPhoto" placeholder="https://…">
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btnSaveProfile">حفظ الملف</button>
      </div>
    </div>
  </section>

  <!-- الإعدادات -->
  <section id="settingsView" class="view">
    <div class="card">
      <h3 style="margin-top:0">الإعدادات</h3>
      <div class="grid">
        <div>
          <label>الثيم</label>
          <div class="row">
            <button id="btnTheme" class="ghost">تبديل ليلي/نهاري 🌙/☀️</button>
          </div>
        </div>
        <div>
          <label>اللغة</label>
          <select id="langSelSettings">
            <option value="ar">العربية</option>
            <option value="en">English</option>
          </select>
        </div>
        <div>
          <label>الخط</label>
          <select id="fontSel">
            <option value="cairo">Cairo (افتراضي)</option>
            <option value="noto">Noto Naskh Arabic</option>
            <option value="inter">Inter</option>
          </select>
        </div>
        <div>
          <label>حجم الخط</label>
          <select id="fsSel">
            <option value="15">صغير</option>
            <option value="16" selected>عادي</option>
            <option value="18">كبير</option>
            <option value="20">أكبر</option>
          </select>
        </div>
      </div>
      <div class="sep"></div>
      <div class="right">
        <button id="btnLogout" class="warn">تسجيل الخروج</button>
      </div>
    </div>
  </section>
</main>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
/* ======= التبليغ عن أي خطأ عام ======= */
window.addEventListener('error', e=>{
  const box = document.getElementById('globalAlert');
  if(!box) return;
  box.textContent = 'خطأ في الصفحة: ' + (e.message||e);
  box.classList.add('show'); box.style.display='block';
});

/* ======= Firebase Config ======= */
const firebaseConfig = {
  apiKey: "AIzaSyDfiO-4J0DIHSKZo_vdBXeS343eJ0x4pYo",
  authDomain: "ittihad-med-kfs.firebaseapp.com",
  projectId: "ittihad-med-kfs",
  appId: "1:323302922960:web:3343605d75d2a5147cdcd5"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* ======= أدوات واجهة ======= */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const on = (sel,ev,fn)=>{ const el=$(sel); if(el) el.addEventListener(ev,fn,{passive:true}); };
const val = el => (el?.value || '').trim();
const setV = (el,v)=>{ if(el) el.value=v??''; };
const showView = id=>{ $$('.view').forEach(v=>v.classList.remove('active')); $('#'+id).classList.add('active'); };
const toast=(m,err=false)=>{ const a=$('#globalAlert'); if(!a) return;
  a.textContent=m; a.style.display=m?'block':'none'; a.classList.toggle('show',!!m);
  a.style.background = err ? 'linear-gradient(180deg,rgba(239,68,68,.20),rgba(239,68,68,.10))'
                           : 'linear-gradient(180deg,rgba(34,197,94,.20),rgba(34,197,94,.10))';
};
const OWNER_EMAILS = ["dr.emara10@gmail.com"];

/* ======= تفضيلات ======= */
function applyTheme(t){ document.documentElement.classList.toggle('light', t==='light'); }
function applyFont(f){ document.body.classList.remove('ff-noto','ff-inter'); if(f==='noto') document.body.classList.add('ff-noto'); if(f==='inter') document.body.classList.add('ff-inter'); }
function applyFs(sz){ document.documentElement.style.setProperty('--fs', (sz||16)+'px'); }
function applyLang(l){ document.documentElement.lang=l; document.documentElement.dir = (l==='ar'?'rtl':'ltr');
  ['#langSelAuth','#langSelSignup','#langSelSettings'].forEach(s=>{const e=$(s); if(e) e.value=l;});
}
(function boot(){
  applyTheme(localStorage.getItem('theme')||'dark');
  applyFont(localStorage.getItem('font')||'cairo');
  applyFs(+localStorage.getItem('fs')||16);
  applyLang(localStorage.getItem('lang')||'ar');
})();

/* تبويبات */
$$('.tab').forEach(t=> t.addEventListener('click',()=>{ $$('.tab').forEach(x=>x.classList.toggle('active',x===t)); showView(t.dataset.view); }));

/* إظهار/إخفاء كلمة السر */
on('#eyeIn','click', ()=>{ const f=$('#inPass'); if(f) f.type = f.type==='password'?'text':'password'; });
on('#eyeUp','click', ()=>{ const f=$('#suPass'); if(f) f.type = f.type==='password'?'text':'password'; });

/* إعدادات */
on('#btnTheme','click', ()=>{ const light=document.documentElement.classList.toggle('light'); localStorage.setItem('theme', light?'light':'dark'); });
on('#fontSel','change', e=>{ localStorage.setItem('font', e.target.value); applyFont(e.target.value); });
on('#fsSel','change',   e=>{ localStorage.setItem('fs', e.target.value); applyFs(+e.target.value); });
['#langSelAuth','#langSelSignup','#langSelSettings'].forEach(id=>{
  on(id,'change', e=>{ localStorage.setItem('lang', e.target.value); applyLang(e.target.value); });
});

/* تنقل بين شاشات auth/signup */
on('#toSignUp','click',   ()=> showView('signupView'));
on('#backToLogin','click',()=> showView('authView'));

/* تحققات */
const okEmail = e => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e||'');
const min = (s,n)=> (s||'').trim().length>=n;
const mark = (el,ok)=>{ if(!el) return ok; el.classList.toggle('error', !ok); return ok; };

/* كتابة/قراءة users */
async function writeUserDoc(u,data){
  const role = OWNER_EMAILS.includes((u.email||'').toLowerCase())?'owner':'member';
  await db.collection('users').doc(u.uid).set({
    uid:u.uid,
    email:u.email||'',
    emailLower:(u.email||'').toLowerCase(),
    first:data.first||'',
    last:data.last||'',
    displayName:`${data.first||''} ${data.last||''}`.trim(),
    phone:data.phone||'',
    batch:data.batch||'',
    photoURL:data.photoURL||u.photoURL||'',
    role,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});
  return role;
}
async function loadUserDoc(uid){
  const s=await db.collection('users').doc(uid).get();
  return s.exists ? s.data() : null;
}

/* Google */
const googleProvider = new firebase.auth.GoogleAuthProvider();

/* دخول بالبريد */
on('#btnEmailLogin','click', async ()=>{
  const email=val($('#inEmail')), pass=val($('#inPass'));
  if(!okEmail(email)) { mark($('#inEmail'),false); return toast('إيميل غير صالح.',true); }
  $('#btnEmailLogin').disabled = true;
  try{
    const cred = await auth.signInWithEmailAndPassword(email,pass);
    const doc  = await loadUserDoc(cred.user.uid);
    const role = doc?.role || (OWNER_EMAILS.includes(email.toLowerCase())?'owner':'member');
    if(!doc) await writeUserDoc(cred.user,{});
    toast('');
    afterLogin(cred.user, role);
  }catch(e){
    const c=e.code||'';
    if(c.includes('invalid-credential')||c.includes('wrong-password')){ mark($('#inPass'),false); toast('الإيميل أو كلمة السر غير صحيحة.',true); }
    else toast('فشل الدخول: '+(e.message||e),true);
  }finally{ $('#btnEmailLogin').disabled = false; }
});

/* دخول Google */
on('#btnGoogleLogin','click', async ()=>{
  $('#btnGoogleLogin').disabled = true;
  try{
    const cred = await auth.signInWithPopup(googleProvider);
    const doc  = await loadUserDoc(cred.user.uid);
    const role = doc?.role || (OWNER_EMAILS.includes((cred.user.email||'').toLowerCase())?'owner':'member');
    if(!doc) await writeUserDoc(cred.user,{ first:(cred.user.displayName||'').split(' ')[0]||'' });
    toast('');
    afterLogin(cred.user, role);
  }catch(e){ toast('إلغاء/خطأ Google: '+(e.message||e),true); }
  finally{ $('#btnGoogleLogin').disabled = false; }
});

/* إنشاء حساب */
on('#btnSignup','click', async ()=>{
  const first=val($('#suFirst')), last=val($('#suLast'));
  const email=val($('#suEmail')), phone=val($('#suPhone'));
  const batch=val($('#suBatch')), pass=val($('#suPass')), pass2=val($('#suPass2'));
  const ok = [
    mark($('#suFirst'),min(first,2)),
    mark($('#suLast'), min(last,2)),
    mark($('#suEmail'),okEmail(email)),
    mark($('#suPhone'),min(phone,7)),
    mark($('#suBatch'),min(batch,1)),
    mark($('#suPass'), min(pass,8)),
    mark($('#suPass2'),pass===pass2)
  ].every(Boolean);
  if(!ok) return toast('راجع الحقول الحمراء.',true);

  $('#btnSignup').disabled = true;
  try{
    const cred = await auth.createUserWithEmailAndPassword(email,pass);
    const role = await writeUserDoc(cred.user,{first,last,phone,batch});
    localStorage.setItem('lang',$('#langSelSignup').value);
    applyLang($('#langSelSignup').value);
    toast('تم إنشاء الحساب ✅');
    afterLogin(cred.user, role);
  }catch(e){ toast('فشل إنشاء الحساب: '+(e.message||e),true); }
  finally{ $('#btnSignup').disabled = false; }
});

/* إنشاء/إكمال بحساب Google (في شاشة الإنشاء) */
on('#btnGoogleSignup','click', async ()=>{
  $('#btnGoogleSignup').disabled = true;
  try{
    const cred = await auth.signInWithPopup(googleProvider);
    const doc  = await loadUserDoc(cred.user.uid);
    if(!doc){
      const parts=(cred.user.displayName||'').split(' ');
      setV($('#suEmail'), cred.user.email||'');
      setV($('#suFirst'), parts[0]||'');
      setV($('#suLast'), parts.slice(1).join(' ')||'');
      showView('signupView');
      toast('أكمل البيانات ثم اضغط "إنشاء حساب بالبريد".');
    }else{
      afterLogin(cred.user, doc.role||'member');
    }
  }catch(e){ toast('إلغاء/خطأ Google: '+(e.message||e),true); }
  finally{ $('#btnGoogleSignup').disabled = false; }
});

/* نسيت كلمة السر */
on('#forgotLink','click', async ()=>{
  const email=val($('#inEmail'));
  if(!okEmail(email)) { mark($('#inEmail'),false); return toast('اكتب بريدًا صالحًا أولاً.',true); }
  try{ await auth.sendPasswordResetEmail(email); toast('تم إرسال رابط إعادة تعيين كلمة السر.'); }
  catch(e){ toast('تعذّر الإرسال: '+(e.message||e),true); }
});

/* حفظ الملف */
on('#btnSaveProfile','click', async ()=>{
  const u=auth.curr
