<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>اتحاد طب بشري كفر الشيخ</title>

<!-- ====== Favicon / OpenGraph ====== -->
<link rel="icon" type="image/png" href="logo.png" sizes="32x32">
<link rel="apple-touch-icon" href="logo.png">
<meta property="og:title" content="اتحاد طب بشري كفر الشيخ">
<meta property="og:image" content="logo.png">
<meta name="theme-color" content="#0b1320">

<!-- ====== Manifest (يُنشأ ديناميكياً أيضاً من JS) ====== -->
<link rel="manifest" id="man">
<style>
/* =======================
   تصميم عام Modern Glass
   ======================= */
:root{
  --bg1:#0b1320; --bg2:#0e1627; --card:rgba(255,255,255,.06);
  --txt:#e9eef6; --mut:#a6b2c6; --bor:rgba(255,255,255,.12);
  --ring:rgba(16,185,129,.35); --accent:#10b981; --accent2:#f59e0b;
  --err:#ef4444; --ok:#22c55e; --warn:#f59e0b;
  --shadow:0 10px 30px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.05);
  --radius-xl:18px; --radius-lg:14px; --radius-md:12px; --pad:14px; --gap:12px; --blur:12px;
}
:root.light{
  --bg1:#f6f8fb; --bg2:#ffffff; --card:rgba(255,255,255,.9);
  --txt:#0f172a; --mut:#677389; --bor:rgba(0,0,0,.08);
  --ring:rgba(37,99,235,.25); --accent:#0ea5e9; --accent2:#f59e0b;
  --shadow:0 12px 26px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.9);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font:15.5px/1.75 ui-rounded,system-ui,"Tajawal",Segoe UI,Arial;
  color:var(--txt);
  background:radial-gradient(1200px 600px at 20% -10%, #0f1c35 20%, transparent 60%),
             radial-gradient(1200px 600px at 90% 10%, #09203a 25%, transparent 65%),
             linear-gradient(160deg,var(--bg1),var(--bg2)) fixed;
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
}

/* ===== Topbar ===== */
.topbar{position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:12px;justify-content:space-between;
  padding:12px 16px;background:linear-gradient(160deg,rgba(0,0,0,.35),rgba(0,0,0,.18));
  backdrop-filter:blur(var(--blur));border-bottom:1px solid var(--bor)}
.brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
.brand img{width:38px;height:38px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.45));border-radius:9px}
.badge{border:1px solid var(--bor);border-radius:999px;padding:5px 10px;background:rgba(255,255,255,.06);color:var(--mut);font-size:12px;white-space:nowrap}

/* ===== Layout ===== */
.container{max-width:1080px;margin:0 auto;padding:18px}
.view{display:none}
.view.active{display:block}
.card{background:var(--card);border:1px solid var(--bor);border-radius:var(--radius-xl);
  padding:var(--pad);box-shadow:var(--shadow);backdrop-filter:blur(var(--blur));transition:transform .12s}
.card:hover{transform:translateY(-1px)}
.grid{display:grid;gap:var(--gap)}
@media(min-width:800px){.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:repeat(3,1fr)}}
.separator{height:1px;background:var(--bor);margin:10px 0;border-radius:999px}

/* ===== Inputs / Buttons ===== */
label{display:block;margin:2px 0 6px;color:var(--mut)}
input,select,button,textarea{border:1px solid var(--bor);border-radius:var(--radius-md);
  background:rgba(0,0,0,.22);color:var(--txt);padding:10px 12px;outline:none;transition:.15s}
input:focus,select:focus,textarea:focus{border-color:color-mix(in srgb,var(--accent) 45%,#000);box-shadow:0 0 0 4px var(--ring)}
input.err{border-color:var(--err) !important;box-shadow:0 0 0 3px color-mix(in srgb,var(--err) 40%, transparent)}
.hint{font-size:12.5px;color:var(--mut)}
.err-txt{color:var(--err);font-size:13px;margin-top:5px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{cursor:pointer;border-radius:12px;font-weight:700;letter-spacing:.3px;
  background:linear-gradient(135deg,color-mix(in srgb,var(--accent) 60%,transparent),color-mix(in srgb,var(--accent2) 40%,transparent));
  color:#fff;border:1px solid var(--bor);padding:12px 14px;box-shadow:0 8px 22px rgba(0,0,0,.18)}
.btn.ghost{background:rgba(255,255,255,.05);color:var(--txt)}
.btn.red{background:linear-gradient(135deg,#ef4444,#b91c1c)}
.btn.green{background:linear-gradient(135deg,#22c55e,#16a34a)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.right{float:inline-start}
.center{text-align:center}
.small{font-size:12px}

/* ===== Forms ===== */
.form{max-width:520px;margin:24px auto}
.field{margin-bottom:12px}
.flex2{display:grid;gap:12px}
@media(min-width:640px){.flex2{grid-template-columns:1fr 1fr}}
.pwd-wrap{position:relative}
.eye{position:absolute;top:50%;inset-inline-end:10px;transform:translateY(-50%);cursor:pointer;opacity:.9}

/* ===== Bottom Nav ===== */
.bottom{position:sticky;bottom:0;z-index:15;display:flex;justify-content:space-around;gap:10px;padding:12px;
  background:linear-gradient(0deg,rgba(0,0,0,.35),rgba(0,0,0,.12));border-top:1px solid var(--bor);backdrop-filter:blur(var(--blur))}
.bottom .tab{flex:1;text-align:center}
.bottom .tab.active{box-shadow:0 0 0 3px var(--ring) inset;border-radius:12px}

/* ===== Toast / Alert ===== */
.toast{position:fixed;inset-inline:16px;bottom:90px;z-index:9999;background:#111827;border:1px solid var(--bor);
  color:#fff;border-radius:12px;padding:10px 12px;display:none}
.toast.show{display:block}
.toast.ok{background:#063a2f} .toast.err{background:#3b0d0d}

/* ===== Profile ===== */
.avatar{width:86px;height:86px;border-radius:50%;border:2px solid var(--bor);object-fit:cover;background:#0b1220}
.owner{color:#7dd3fc;font-weight:800;white-space:nowrap}

/* ===== Tables / Lists ===== */
.kv{display:grid;grid-template-columns:150px 1fr;gap:8px;align-items:center}
.kv div{padding:6px 10px;background:rgba(255,255,255,.04);border:1px solid var(--bor);border-radius:10px}
kbd{background:#111827;border:1px solid var(--bor);border-radius:6px;padding:2px 6px;font:12px/1 system-ui}

/* ===== Helper badges ===== */
.badge-mini{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border:1px solid var(--bor);border-radius:999px;background:rgba(255,255,255,.06);font-size:12px;color:var(--mut)}
</style>
</head>
<body>

<header class="topbar">
  <div class="brand">
    <img src="logo.png" alt="شعار">
    <div>
      <div style="font-weight:800">اتحاد طب بشري كفر الشيخ</div>
      <div class="small" id="userChip" aria-live="polite" style="color:var(--mut)"></div>
    </div>
  </div>
  <div class="badge" id="statusBadge">…</div>
</header>

<main class="container">

  <!-- ========= صفحة الدخول ========= -->
  <section id="page-login" class="view active">
    <div class="card form">
      <h2 class="center">تسجيل الدخول</h2>
      <div class="field">
        <label>البريد الإلكتروني</label>
        <input id="loginEmail" type="email" inputmode="email" autocomplete="email" placeholder="you@example.com">
        <div class="err-txt" id="loginEmailErr"></div>
      </div>
      <div class="field pwd-wrap">
        <label>كلمة السر</label>
        <input id="loginPass" type="password" autocomplete="current-password" placeholder="••••••••">
        <span class="eye" data-eye="loginPass">👁️</span>
        <div class="err-txt" id="loginPassErr"></div>
      </div>
      <div class="field">
        <label>اللغة</label>
        <select id="loginLang">
          <option value="ar">العربية</option>
          <option value="en">English</option>
        </select>
      </div>
      <button class="btn green" id="btnLoginEmail">دخول بالبريد</button>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <a href="#" id="goReset" class="small">نسيت كلمة السر؟</a>
        <a href="#" id="goRegister" class="small">إنشاء حساب جديد</a>
      </div>
      <div class="separator"></div>
      <button class="btn" id="btnGoogle">دخول بحساب Google</button>
      <p class="hint center" style="margin-top:10px">* يلزم الموافقة على البريد في بعض الأحيان.</p>
    </div>
  </section>

  <!-- ========= صفحة إنشاء حساب ========= -->
  <section id="page-register" class="view">
    <div class="card form">
      <h2 class="center">إنشاء حساب</h2>

      <div class="flex2">
        <div class="field">
          <label>الاسم الأول + اسم العائلة</label>
          <input id="regName" placeholder="الاسم الكامل (≥ 4 حروف)">
          <div class="err-txt" id="regNameErr"></div>
        </div>
        <div class="field">
          <label>الموبايل</label>
          <input id="regPhone" inputmode="numeric" placeholder="01xxxxxxxxx">
          <div class="err-txt" id="regPhoneErr"></div>
        </div>
      </div>

      <div class="flex2">
        <div class="field">
          <label>الدفعة</label>
          <input id="regBatch" inputmode="numeric" placeholder="مثال: 12">
          <div class="err-txt" id="regBatchErr"></div>
        </div>
        <div class="field">
          <label>اللغة</label>
          <select id="regLang"><option value="ar">العربية</option><option value="en">English</option></select>
        </div>
      </div>

      <div class="field">
        <label>البريد الإلكتروني</label>
        <input id="regEmail" type="email" autocomplete="email" placeholder="you@example.com">
        <div class="err-txt" id="regEmailErr"></div>
      </div>

      <div class="flex2">
        <div class="field pwd-wrap">
          <label>كلمة السر</label>
          <input id="regPass" type="password" autocomplete="new-password" placeholder="••••••••">
          <span class="eye" data-eye="regPass">👁️</span>
          <div class="err-txt" id="regPassErr"></div>
        </div>
        <div class="field pwd-wrap">
          <label>تأكيد كلمة السر</label>
          <input id="regPass2" type="password" autocomplete="new-password" placeholder="••••••••">
          <span class="eye" data-eye="regPass2">👁️</span>
          <div class="err-txt" id="regPass2Err"></div>
        </div>
      </div>

      <button class="btn green" id="btnRegister">تسجيل</button>
      <div class="row" style="justify-content:space-between;margin-top:10px">
        <a href="#" id="goLoginFromReg" class="small">عندي حساب بالفعل</a>
      </div>
      <p class="hint small" style="margin-top:10px">
        بالضغط على تسجيل، أنت توافق على حفظ بياناتك (الاسم/البريد/الهاتف/الدفعة) لاستخدامها في فعاليات الاتحاد.
      </p>
    </div>
  </section>

  <!-- ========= صفحة نسيان كلمة السر (مع تحقق) ========= -->
  <section id="page-reset" class="view">
    <div class="card form">
      <h2 class="center">استعادة كلمة السر</h2>
      <div class="field"><label>البريد</label><input id="resetEmail" type="email" placeholder="you@example.com"></div>
      <div class="flex2">
        <div class="field"><label>الموبايل</label><input id="resetPhone" inputmode="numeric" placeholder="01xxxxxxxxx"></div>
        <div class="field"><label>الدفعة</label><input id="resetBatch" inputmode="numeric" placeholder="12"></div>
      </div>
      <button class="btn" id="btnReset">تأكيد وإرسال رابط إعادة التعيين</button>
      <div class="row" style="justify-content:space-between;margin-top:10px">
        <a href="#" id="goLoginFromReset" class="small">رجوع للدخول</a>
      </div>
      <p class="hint small">نتحقق أولاً من تطابق (الموبايل + الدفعة) مع بيانات حسابك قبل إرسال الرابط.</p>
    </div>
  </section>

  <!-- ========= الصفحة الرئيسية (بعد الدخول) ========= -->
  <section id="page-home" class="view">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">مرحبًا بك</h2>
        <span class="badge-mini">حالة Firebase: <b id="fbState">—</b></span>
      </div>
      <p class="hint" id="welcomeMsg">…</p>
      <div class="separator"></div>
      <div class="grid grid-2">
        <div class="card">
          <h3 style="margin-top:0">أحدث الأخبار</h3>
          <div id="newsList">
            <div class="hint">سيتم إضافة منشورات وفعاليات لاحقًا.</div>
          </div>
        </div>
        <div class="card">
          <h3 style="margin-top:0">مختصر سريع</h3>
          <div class="kv">
            <div>اسم المستخدم</div><div id="kvName">—</div>
            <div>البريد</div><div id="kvEmail">—</div>
            <div>الدفعة</div><div id="kvBatch">—</div>
            <div>موبايل</div><div id="kvPhone">—</div>
            <div>الدور</div><div id="kvRole">—</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ========= البروفايل ========= -->
  <section id="page-profile" class="view">
    <div class="card">
      <h2 style="margin-top:0">الملف الشخصي</h2>
      <div class="row" style="gap:18px;align-items:center">
        <img id="avatar" class="avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='96' height='96'%3E%3Crect width='100%25' height='100%25' fill='%23111827'/%3E%3Ctext x='50%25' y='54%25' text-anchor='middle' fill='%23a6b2c6' font-size='22' font-family='system-ui'%3E👤%3C/text%3E%3C/svg%3E" alt="avatar">
        <div>
          <div style="font-weight:800" id="pName">—</div>
          <div class="small" style="color:var(--mut)"><span id="pEmail">—</span> • <span id="pRole">—</span></div>
        </div>
      </div>

      <div class="grid grid-2" style="margin-top:12px">
        <div>
          <label>تغيير الصورة</label>
          <input type="file" id="fileAvatar" accept="image/*">
          <div class="hint small">تُصغّر تلقائيًا إلى 256×256 وتُحفظ في الحساب.</div>
        </div>
        <div class="flex2">
          <div>
            <label>الموبايل</label>
            <input id="pPhone" placeholder="01xxxxxxxxx">
          </div>
          <div>
            <label>الدفعة</label>
            <input id="pBatch" placeholder="12">
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn green" id="btnSaveProfile">حفظ التعديلات</button>
        <span class="hint" id="saveStatus"></span>
      </div>
    </div>
  </section>

  <!-- ========= الإعدادات ========= -->
  <section id="page-settings" class="view">
    <div class="card">
      <h2 style="margin-top:0">الإعدادات</h2>
      <div class="grid grid-3">
        <div>
          <label>الوضع</label><br>
          <button class="btn ghost" id="btnTheme">☀️ / 🌙 تبديل</button>
        </div>
        <div>
          <label>اللغة</label><br>
          <select id="selLang">
            <option value="ar">العربية</option>
            <option value="en">English</option>
          </select>
        </div>
        <div>
          <label>حجم الخط</label><br>
          <div class="row">
            <button class="btn ghost small" data-fs="14">A-</button>
            <button class="btn ghost small" data-fs="16">A</button>
            <button class="btn ghost small" data-fs="18">A+</button>
          </div>
        </div>
      </div>
      <div class="separator"></div>
      <div class="row" style="justify-content:space-between">
        <button class="btn red" id="btnLogout">تسجيل الخروج</button>
        <button class="btn ghost" id="btnClear">مسح تفضيلات الجهاز</button>
      </div>
      <p class="hint small" style="margin-top:8px">* تسجيل الخروج موجود هنا كما طلبت.</p>
    </div>
  </section>

</main>

<!-- ===== Bottom Nav (يظهر بعد الدخول) ===== -->
<nav class="bottom" id="nav" style="display:none">
  <button class="tab active" data-goto="page-home">🏠 الرئيسية</button>
  <button class="tab" data-goto="page-profile">👤 بروفايل</button>
  <button class="tab" data-goto="page-settings">⚙️ إعدادات</button>
</nav>

<!-- ===== Toast ===== -->
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<!-- ===== Firebase (Compat) ===== -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics-compat.js"></script>
<script>
/* ===============================
   Firebase Config + Boot
   (مربوط على مشروعك الحالي)
   =============================== */
const firebaseConfig = {
  apiKey: "AIzaSyDfiO-4J0DIHSKZo_vdBXeS343eJ0x4pYo",
  authDomain: "ittihad-med-kfs.firebaseapp.com",
  projectId: "ittihad-med-kfs",
  appId: "1:323302922960:web:3343605d75d2a5147cdcd5"
};
// إيميل المالك
const OWNER_EMAIL = "dr.emara10@gmail.com";

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
try{ firebase.analytics(); }catch{}

/* ===============================
   Utilities
   =============================== */
const qs = sel => document.querySelector(sel);
const qsa = sel => [...document.querySelectorAll(sel)];
const L = s => (s||"").trim();
const lower = s => L(s).toLowerCase();
const show = id => (qs(id).style.display="");
const hide = id => (qs(id).style.display="none");
const toast = (msg, type="ok")=>{
  const t=qs("#toast"); t.textContent=msg; t.className="toast show "+type;
  setTimeout(()=>t.className="toast", 2500);
};
function setActive(pageId){
  qsa(".view").forEach(v=>v.classList.remove("active"));
  qs("#"+pageId).classList.add("active");
  qsa(".bottom .tab").forEach(b=>b.classList.toggle("active", b.dataset.goto===pageId));
}

/* ===============================
   Theme, Lang, Font
   =============================== */
(function bootPrefs(){
  const man = qs("#man");
  const manifest = {
    name:"اتحاد طب بشري كفر الشيخ",
    short_name:"اتحاد الطب",
    icons:[{src:"logo.png",sizes:"192x192",type:"image/png"}],
    start_url:"./", display:"standalone", background_color:"#0b1320", theme_color:"#0b1320"
  };
  const blob = new Blob([JSON.stringify(manifest)],{type:"application/json"});
  man.setAttribute("href", URL.createObjectURL(blob));

  const theme = localStorage.getItem("theme"); if(theme==="light") document.documentElement.classList.add("light");
  const fs = localStorage.getItem("fs"); if(fs) document.body.style.fontSize = fs+"px";
  const lang = localStorage.getItem("lang")||"ar"; qs("#loginLang").value = lang; qs("#regLang").value = lang; qs("#selLang").value = lang;
})();
qs("#btnTheme").onclick = ()=>{ const isLight=document.documentElement.classList.toggle("light"); localStorage.setItem("theme", isLight?"light":"dark"); };
qsa('[data-fs]').forEach(b=>b.onclick=()=>{ const v=b.getAttribute('data-fs'); document.body.style.fontSize=v+'px'; localStorage.setItem('fs',v); });
qs("#selLang").onchange = e => { localStorage.setItem("lang", e.target.value); toast("تم حفظ اللغة"); };
qs("#btnClear").onclick = ()=>{ localStorage.clear(); toast("تم مسح التفضيلات، أعد التحميل"); };

/* ===============================
   Nav
   =============================== */
qsa(".bottom .tab").forEach(b=> b.onclick=()=> setActive(b.dataset.goto));
["#goRegister","#goLoginFromReg","#goReset","#goLoginFromReset"].forEach(id=>{
  const el = qs(id); if(!el) return;
  el.onclick = (e)=>{ e.preventDefault(); setActive(el.id.includes("Register")? "page-register": el.id.includes("Reset")? "page-reset" : "page-login"); };
});

/* ===============================
   Eye toggles
   =============================== */
qsa(".eye").forEach(e=> e.onclick=()=>{
  const id=e.getAttribute("data-eye"), inp=qs("#"+id); inp.type = (inp.type==="password"?"text":"password");
});

/* ===============================
   Firestore helpers
   =============================== */
const usernames = () => db.collection("usernames");  // docId = nameLower, data:{uid}
const usersCol  = () => db.collection("users");      // docId = uid

/* ===============================
   Sign Up
   =============================== */
qs("#btnRegister").onclick = async ()=>{
  // inputs
  const name = L(qs("#regName").value);
  const phone= L(qs("#regPhone").value);
  const batch= L(qs("#regBatch").value);
  const email= L(qs("#regEmail").value);
  const pass = qs("#regPass").value;
  const pass2= qs("#regPass2").value;
  const lang = qs("#regLang").valu
