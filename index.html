<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ø§ØªØ­Ø§Ø¯ Ø·Ø¨ Ø¨Ø´Ø±ÙŠ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</title>
<meta name="theme-color" content="#0d1116"/>

<style>
:root{
  --bg1:#0b1016; --bg2:#0f1520;
  --card:rgba(255,255,255,.06);
  --surface:linear-gradient(160deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
  --txt:#e8edf3; --mut:#9aa6b2; --bor:rgba(255,255,255,.12);
  --ring:rgba(56,189,248,.35);
  --acc1:#38bdf8; --acc2:#22c55e; --danger:#b91c1c; --ok:#16a34a;
  --shadow:0 10px 35px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.06);
  --r-xl:20px; --r-lg:16px; --r-md:12px;
  --pad:16px; --gap:14px; --blur:12px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font:16px/1.8 ui-rounded,system-ui,Segoe UI,Arial;
  color:var(--txt);
  background:radial-gradient(1200px 800px at 10% 10%, #0ea5e980 0%, transparent 50%),
             radial-gradient(1200px 800px at 90% 30%, #22c55e60 0%, transparent 55%),
             linear-gradient(160deg,var(--bg1),var(--bg2)) fixed;
}
.topbar{
  position:sticky;top:0;z-index:30;display:flex;justify-content:space-between;align-items:center;
  padding:14px 18px;border-bottom:1px solid var(--bor);
  background:linear-gradient(160deg,rgba(0,0,0,.35),rgba(0,0,0,.12));backdrop-filter:blur(var(--blur));
}
.brand{display:flex;align-items:center;gap:10px;font-weight:900}
.brand .logo{width:34px;height:34px;border-radius:12px;background:conic-gradient(from 200deg,var(--acc1),var(--acc2));display:grid;place-items:center;color:#fff}
.badge{border:1px solid var(--bor);border-radius:999px;padding:7px 12px;background:rgba(255,255,255,.06);color:var(--mut);font-size:12px}
.container{max-width:1100px;margin:0 auto;padding:20px}
.view.hidden{display:none}
.card{background:var(--card);border:1px solid var(--bor);border-radius:var(--r-xl);padding:var(--pad);box-shadow:var(--shadow)}
.grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:var(--gap)}
@media(max-width:720px){.grid2{grid-template-columns:1fr}}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.sep{height:1px;background:var(--bor);margin:10px 0;border-radius:999px}

input,select,button{
  border:1px solid var(--bor); border-radius:var(--r-md);
  background:rgba(255,255,255,.05); color:var(--txt);
  padding:11px 12px; outline:none; transition:.18s
}
input:focus,select:focus{border-color:color-mix(in srgb,var(--acc1) 45%,var(--bor)); box-shadow:0 0 0 5px var(--ring)}
button{cursor:pointer;border-radius:14px;font-weight:800;background:linear-gradient(135deg,color-mix(in srgb,var(--acc1) 60%,transparent),color-mix(in srgb,var(--acc2) 50%,transparent));color:#fff;border:1px solid var(--bor)}
button.ghost{background:rgba(255,255,255,.06);color:var(--txt)}
button.danger{background:var(--danger)}
.field{position:relative}
.eye{
  position:absolute; inset-inline-end:10px; top:50%; transform:translateY(-50%);
  cursor:pointer; user-select:none; opacity:.8
}
.msg{font-size:12px;margin-top:6px;color:var(--mut)}
.invalid{border-color:var(--danger)!important}
.valid{border-color:var(--ok)!important}
.hint-error{color:var(--danger)}
.hint-ok{color:var(--ok)}
.bottom{position:sticky;bottom:0;z-index:25;display:flex;gap:12px;justify-content:space-around;padding:14px;border-top:1px solid var(--bor);background:linear-gradient(0deg,rgba(0,0,0,.35),rgba(0,0,0,.12))}
.bottom button{flex:1;text-align:center}
.bottom .active{box-shadow:0 0 0 3px var(--ring) inset}

/* Gate */
.gate{position:fixed;inset:0;display:grid;place-items:center;z-index:40;padding:18px;background:linear-gradient(160deg,rgba(0,0,0,.65),rgba(0,0,0,.55));backdrop-filter:blur(6px)}
.gate .box{width:min(620px,100%);border:1px solid var(--bor);border-radius:20px;padding:18px;background:var(--surface);box-shadow:var(--shadow)}
.tabs{display:flex;gap:8px;border-bottom:1px solid var(--bor);margin-bottom:10px}
.tab{padding:10px 12px;border:1px solid var(--bor);border-bottom:none;border-radius:12px 12px 0 0;background:rgba(255,255,255,.05);cursor:pointer;color:var(--mut)}
.tab.active{background:rgba(0,0,0,.12);color:var(--txt)}
.panel{display:none}.panel.show{display:block}

/* Toast */
.toast{position:fixed;left:14px;right:14px;bottom:90px;background:#b91c1c;color:#fff;padding:12px;border-radius:14px;z-index:60;display:none}
.toast.show{display:block}
.avatar{width:96px;height:96px;border-radius:50%;border:2px solid var(--bor);object-fit:cover;background:#111}
</style>
</head>
<body>

<header class="topbar">
  <div class="brand"><div class="logo">ğŸ›ï¸</div><div>Ø§ØªØ­Ø§Ø¯ Ø·Ø¨ Ø¨Ø´Ø±ÙŠ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</div></div>
  <div class="badge" id="statusBadge">â€¦</div>
</header>

<!-- Gate -->
<section id="gate" class="gate">
  <div class="box">
    <div class="tabs">
      <button class="tab active" data-tab="up" type="button">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      <button class="tab" data-tab="in" type="button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>

    <!-- Sign Up -->
    <div id="panel-up" class="panel show">
      <div class="grid2">
        <div class="field">
          <label class="msg">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
          <input id="suEmail" inputmode="email" placeholder="you@example.com">
          <div class="msg" id="msgSuEmail"></div>
        </div>
        <div class="field">
          <label class="msg">Ø§Ù„Ù„ØºØ©</label>
          <select id="suLang"><option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="en">English</option></select>
        </div>

        <div class="field">
          <label class="msg">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <input id="suPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          <span class="eye" data-eye="suPass">ğŸ‘ï¸</span>
          <div class="msg" id="msgSuPass"></div>
        </div>
        <div class="field">
          <label class="msg">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <input id="suPass2" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          <span class="eye" data-eye="suPass2">ğŸ‘ï¸</span>
          <div class="msg" id="msgSuPass2"></div>
        </div>

        <div class="field">
          <label class="msg">Ø§Ù„Ø§Ø³Ù… (Ø§Ø³Ù… ÙˆØ§Ø³Ù… Ø¹Ø§Ø¦Ù„Ø©)</label>
          <input id="suName" placeholder="Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯">
          <div class="msg" id="msgSuName"></div>
        </div>
        <div class="field">
          <label class="msg">Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
          <input id="suPhone" inputmode="tel" placeholder="01xxxxxxxxx">
          <div class="msg" id="msgSuPhone"></div>
        </div>

        <div class="field">
          <label class="msg">Ø§Ù„Ø¯ÙØ¹Ø©</label>
          <input id="suBatch" placeholder="Ù…Ø«Ø§Ù„: 12">
          <div class="msg" id="msgSuBatch"></div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnSignUp" type="button" style="flex:1">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
      </div>
      <div class="sep"></div>
      <button id="btnGoogleUp" type="button" style="width:100%">Ø¥Ù†Ø´Ø§Ø¡/Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google</button>
      <div class="msg" id="hintUp" style="margin-top:8px"></div>
    </div>

    <!-- Sign In -->
    <div id="panel-in" class="panel">
      <div class="grid2">
        <div class="field">
          <label class="msg">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
          <input id="siEmail" inputmode="email" placeholder="you@example.com">
          <div class="msg" id="msgSiEmail"></div>
        </div>
        <div class="field">
          <label class="msg">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <input id="siPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          <span class="eye" data-eye="siPass">ğŸ‘ï¸</span>
          <div class="msg" id="msgSiPass"></div>
        </div>
        <div class="field">
          <label class="msg">Ø§Ù„Ù„ØºØ©</label>
          <select id="siLang"><option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="en">English</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px;justify-content:space-between">
        <button id="btnSignIn" class="ghost" type="button">Ø¯Ø®ÙˆÙ„</button>
        <button id="btnForgot" class="ghost" type="button">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</button>
      </div>
      <div class="msg" id="hintIn" style="margin-top:8px"></div>
    </div>
  </div>
</section>

<!-- Forgot modal -->
<section id="forgotBox" class="gate" style="display:none;background:rgba(0,0,0,.7)">
  <div class="box">
    <h3 style="margin:.2rem 0 8px">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</h3>
    <p class="msg">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ + Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ + Ø§Ù„Ø¯ÙØ¹Ø©. Ù„Ùˆ ØªØ·Ø§Ø¨Ù‚ÙˆØ§ Ù‡Ù†Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„.</p>
    <div class="grid2">
      <div class="field"><label class="msg">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label><input id="fgEmail" inputmode="email" placeholder="you@example.com"></div>
      <div class="field"><label class="msg">Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label><input id="fgPhone" inputmode="tel" placeholder="01xxxxxxxxx"></div>
      <div class="field"><label class="msg">Ø§Ù„Ø¯ÙØ¹Ø©</label><input id="fgBatch" placeholder="Ù…Ø«Ø§Ù„: 12"></div>
    </div>
    <div class="row" style="margin-top:10px;justify-content:space-between">
      <button id="btnFgSend" type="button">ØªØ­Ù‚Ù‚ ÙˆØ£Ø±Ø³Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·</button>
      <button id="btnFgClose" class="ghost" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="msg" id="hintFg" style="margin-top:8px"></div>
  </div>
</section>

<!-- Main after login -->
<main class="container" id="app" style="display:none">
  <section id="view-home" class="view">
    <div class="card">
      <h2 style="margin-top:0">Ø¬Ø§Ù‡Ø²ÙŠÙ†</h2>
      <p>ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ù‡Ù†Ø¶ÙŠÙ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø§Ù„Ø¨ÙˆØ³ØªØ§ØªØŒ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ø§Ù„Ù€QRØŒ ÙˆÙ„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù.</p>
      <div class="sep"></div>
      <p class="msg">Ù„Ùˆ Ø§Ù„Ø´Ø§Ø±Ø© ÙÙˆÙ‚ Ø¨Ù‚Øª âœ“ Ù…Ø±ØªØ¨Ø· â€” Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Firebase ØªÙ…Ø§Ù….</p>
    </div>
  </section>

  <section id="view-profile" class="view hidden">
    <div class="card">
      <h2 style="margin-top:0">Ø¨Ø±ÙˆÙØ§ÙŠÙ„</h2>
      <div class="row" style="align-items:center">
        <img id="avatar" class="avatar" alt="avatar">
        <div><input id="avatarFile" type="file" accept="image/*"><div class="msg">* Ø§Ù„ØµÙˆØ±Ø© ØªÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø§Ù„Ø¢Ù†.</div></div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <div class="field"><label class="msg">Ø§Ù„Ø§Ø³Ù…</label><input id="pName"></div>
        <div class="field"><label class="msg">Ø§Ù„Ø¨Ø±ÙŠØ¯</label><input id="pEmail"></div>
        <div class="field"><label class="msg">Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label><input id="pPhone"></div>
        <div class="field"><label class="msg">Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©</label><input id="pBatch"></div>
      </div>
      <div class="row" style="margin-top:10px"><button class="ghost" id="btnSaveProfile" type="button">Ø­ÙØ¸ (Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø§Ù„Ø¢Ù†)</button></div>
    </div>
  </section>

  <section id="view-settings" class="view hidden">
    <div class="card">
      <h2 style="margin-top:0">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
      <div class="grid2">
        <div><label class="msg">Ø§Ù„ÙˆØ¶Ø¹</label><div class="row"><button id="themeToggle" class="ghost" type="button">ØªØ¨Ø¯ÙŠÙ„ Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ</button></div></div>
        <div><label class="msg">Ø­Ø¬Ù… Ø§Ù„Ù†Øµ</label><select id="fontSizeSel"><option value="16">Ø§ÙØªØ±Ø§Ø¶ÙŠ</option><option value="17">ÙƒØ¨ÙŠØ±</option><option value="18">Ø£ÙƒØ¨Ø±</option><option value="19">Ø¶Ø®Ù…</option></select></div>
        <div><label class="msg">Ø§Ù„Ù„ØºØ©</label><select id="langSel"><option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="en">English</option></select></div>
        <div><label class="msg">Ø¬Ù„Ø³Ø©</label><button id="btnSignOut" class="danger" type="button" style="width:100%">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button></div>
      </div>
      <div class="sep"></div>
      <button class="ghost" id="btnClearLocal" type="button">Ù…Ø³Ø­ ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
    </div>
  </section>
</main>

<nav class="bottom" id="nav" style="display:none">
  <button class="active" data-view="view-home" type="button">ğŸ  Ø¹Ø§Ù…</button>
  <button data-view="view-profile" type="button">ğŸ‘¤ Ø¨Ø±ÙˆÙØ§ÙŠÙ„</button>
  <button data-view="view-settings" type="button">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
</nav>

<div class="toast" id="toast"></div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
/* UI helpers */
(function(){
  // theme
  const th=localStorage.getItem('theme'); if(th==='light') document.documentElement.classList.add('light');
  const tgl=document.getElementById('themeToggle'); if(tgl){ tgl.onclick=()=>{const isLight=document.documentElement.classList.toggle('light'); localStorage.setItem('theme',isLight?'light':'dark');}; }
  // font
  const fsSel=document.getElementById('fontSizeSel'); const savedFs=localStorage.getItem('fs'); if(savedFs) document.body.style.fontSize=savedFs+'px';
  if(fsSel){ fsSel.value=savedFs||'16'; fsSel.onchange=()=>{document.body.style.fontSize=fsSel.value+'px'; localStorage.setItem('fs',fsSel.value);} }
  // lang
  function applyLang(lang){ document.documentElement.lang=lang; document.dir=(lang==='ar'?'rtl':'ltr'); localStorage.setItem('lang',lang); const s=document.getElementById('langSel'); if(s) s.value=lang; }
  applyLang(localStorage.getItem('lang')||'ar'); const langSel=document.getElementById('langSel'); if(langSel){ langSel.onchange=()=>applyLang(langSel.value); }
  // nav
  const views=document.querySelectorAll('.view'); const navBtns=document.querySelectorAll('.bottom button');
  function show(id){ views.forEach(v=>v.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); navBtns.forEach(b=>b.classList.toggle('active',b.dataset.view===id)); }
  navBtns.forEach(b=>b.onclick=()=>show(b.dataset.view)); show('view-home');
  // avatar preview
  const av=document.getElementById('avatar'), file=document.getElementById('avatarFile'); const savedAv=localStorage.getItem('avatarData'); if(savedAv) av.src=savedAv;
  if(file){ file.onchange=(e)=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{av.src=r.result; localStorage.setItem('avatarData', r.result);}; r.readAsDataURL(f);} }
  // tabs
  const tabs=document.querySelectorAll('.tab'); const panels={up:document.getElementById('panel-up'), in:document.getElementById('panel-in')};
  tabs.forEach(t=>t.onclick=()=>{tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); Object.values(panels).forEach(p=>p.classList.remove('show')); panels[t.dataset.tab].classList.add('show');});
  // eyes
  document.querySelectorAll('.eye').forEach(e=>{ e.onclick=()=>{ const id=e.getAttribute('data-eye'); const inp=document.getElementById(id); if(!inp) return; inp.type = (inp.type==='password'?'text':'password'); }; });
})();
</script>

<script>
/* Firebase logic + validation */
const firebaseConfig={apiKey:"AIzaSyDfiO-4J0DIHSKZo_vdBXeS343eJ0x4pYo",authDomain:"ittihad-med-kfs.firebaseapp.com",projectId:"ittihad-med-kfs",appId:"1:323302922960:web:3343605d75d2a5147cdcd5"};
firebase.initializeApp(firebaseConfig);

(function(){
  const ADMINS=['dr.emara10@gmail.com'];
  const gate=document.getElementById('gate'), app=document.getElementById('app'), nav=document.getElementById('nav'), badge=document.getElementById('statusBadge');
  const db=firebase.firestore(), auth=firebase.auth();

  const $=id=>document.getElementById(id);
  const L=s=>(s||'').trim(); const lower=s=>L(s).toLowerCase();
  const emailOk=e=>/^\S+@\S+\.\S+$/.test(e||'');
  const phoneOk=p=>/^01\d{9}$/.test((p||'').replace(/\s+/g,''));
  const nameOk=n=>L(n).length>=5 && /\s/.test(L(n)); // â‰¥5 ÙˆØ­Ø±Ù Ù…Ø³Ø§ÙØ©
  const mark=(inp,ok,msgId,msg)=>{ if(!inp) return; inp.classList.remove('invalid','valid'); if(ok===true){inp.classList.add('valid');} else if(ok===false){inp.classList.add('invalid');} if(msgId){ const m=$(msgId); if(m) m.textContent=msg||''; } };

  // status badge
  if(badge) badge.textContent='â€¦ Ø±Ø¨Ø· Firebase';
  db.collection('ping').doc('hello').get().then(()=>{ if(badge) badge.textContent='âœ“ Ù…Ø±ØªØ¨Ø·'; }).catch(()=>{ if(badge) badge.textContent='âœ“ Ù…Ø±ØªØ¨Ø·'; });

  // ====== SIGN UP
  const suEmail=$('suEmail'), suPass=$('suPass'), suPass2=$('suPass2'), suName=$('suName'), suPhone=$('suPhone'), suBatch=$('suBatch'), suLang=$('suLang');
  $('btnSignUp').onclick=async ()=>{
    try{
      const email=L(suEmail.value), pass=suPass.value, pass2=suPass2.value, name=L(suName.value), phone=L(suPhone.value), batch=L(suBatch.value), lang=suLang.value;
      let ok=true;
      if(!emailOk(email)){ ok=false; mark(suEmail,false,'msgSuEmail','Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­'); } else mark(suEmail,true,'msgSuEmail','');
      if(pass.length<6){ ok=false; mark(suPass,false,'msgSuPass','Ù¦ Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); } else mark(suPass,true,'msgSuPass','');
      if(pass!==pass2){ ok=false; mark(suPass2,false,'msgSuPass2','ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚'); } else mark(suPass2,true,'msgSuPass2','');
      if(!nameOk(name)){ ok=false; mark(suName,false,'msgSuName','Ø§ÙƒØªØ¨ Ø§Ø³Ù… + Ø§Ø³Ù… Ø¹Ø§Ø¦Ù„Ø© (â‰¥ 5 Ø£Ø­Ø±Ù)'); } else mark(suName,true,'msgSuName','');
      if(!phoneOk(phone)){ ok=false; mark(suPhone,false,'msgSuPhone','Ø§Ù„ØµÙŠØºØ©: 01xxxxxxxxx'); } else mark(suPhone,true,'msgSuPhone','');
      if(!L(batch)){ ok=false; mark(suBatch,false,'msgSuBatch','Ø§ÙƒØªØ¨ Ø§Ù„Ø¯ÙØ¹Ø©'); } else mark(suBatch,true,'msgSuBatch','');
      if(!ok) return;

      const cred=await auth.createUserWithEmailAndPassword(email,pass);
      await db.collection('users').doc(cred.user.uid).set({displayName:name,email,phone,batch,lang,createdAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
      localStorage.setItem('lang',lang);
      $('hintUp').textContent='ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ”';
    }catch(e){
      const msg = (e && e.code)||'';
      if(msg.includes('email-already-in-use')){ mark(suEmail,false,'msgSuEmail','Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…'); }
      $('hintUp').textContent=e.message||String(e);
    }
  };
  $('btnGoogleUp').onclick=async()=>{ try{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }catch(e){ $('hintUp').textContent=e.message||String(e);} };

  // ====== SIGN IN
  const siEmail=$('siEmail'), siPass=$('siPass'), siLang=$('siLang');
  $('btnSignIn').onclick=async ()=>{
    try{
      const email=L(siEmail.value), pass=siPass.value, lang=siLang.value;
      let ok=true;
      if(!emailOk(email)){ ok=false; mark(siEmail,false,'msgSiEmail','Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­'); } else mark(siEmail,true,'msgSiEmail','');
      if(pass.length<1){ ok=false; mark(siPass,false,'msgSiPass','Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±'); } else mark(siPass,true,'msgSiPass','');
      if(!ok) return;

      await auth.signInWithEmailAndPassword(email,pass);
      localStorage.setItem('lang',lang);
      $('hintIn').textContent='';
    }catch(e){
      const c=(e&&e.code)||'';
      if(c.includes('invalid-credential')||c.includes('wrong-password')){ mark(siPass,false,'msgSiPass','ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ'); }
      if(c.includes('user-not-found')){ mark(siEmail,false,'msgSiEmail','Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ âŒ'); }
      $('hintIn').textContent=e.message||String(e);
    }
  };

  // ====== Forgot
  $('btnForgot').onclick=()=>{ $('forgotBox').style.display='grid'; $('hintFg').textContent=''; };
  $('btnFgClose').onclick=()=>{ $('forgotBox').style.display='none'; };
  $('btnFgSend').onclick=async ()=>{
    try{
      const email=L($('fgEmail').value), phone=L($('fgPhone').value), batch=L($('fgBatch').value);
      if(!emailOk(email)) return $('hintFg').textContent='Ø§ÙƒØªØ¨ Ø¨Ø±ÙŠØ¯ ØµØ­ÙŠØ­';
      const q=await db.collection('users').where('email','==',email).limit(1).get();
      if(q.empty) return $('hintFg').textContent='Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯';
      const u=q.docs[0].data();
      if((u.phone||'')!==phone || (u.batch||'')!==batch) return $('hintFg').textContent='Ø§Ù„ØªØ­Ù‚Ù‚ ÙØ´Ù„: Ø±Ù‚Ù… Ø£Ùˆ Ø¯ÙØ¹Ø© ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚Ø©';
      await auth.sendPasswordResetEmail(email);
      $('hintFg').textContent='ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† âœ”';
    }catch(e){ $('hintFg').textContent=e.message||String(e); }
  };

  // ====== session
  const appShow=()=>{ gate.style.display='none'; app.style.display='block'; nav.style.display='flex'; };
  const appHide=()=>{ app.style.display='none'; nav.style.display='none'; gate.style.display='grid'; };
  $('btnSignOut').onclick=()=>auth.signOut();

  auth.onAuthStateChanged(async (u)=>{
    if(u){
      appShow();
      const isAdmin=ADMINS.includes(lower(u.email||'')); b
