<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø§ØªØ­Ø§Ø¯ Ø·Ø¨ Ø¨Ø´Ø±ÙŠ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&family=Inter:wght@400;600;800&family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg1:#0f1217; --bg2:#0b0d11; --card:rgba(255,255,255,.05);
  --txt:#eef1f4; --mut:#a6acb3; --bor:rgba(255,255,255,.10);
  --acc:#10b981; --warn:#ef4444; --ok:#22c55e; --amber:#f59e0b;
  --ring:rgba(16,185,129,.34);
  --r-xl:18px; --r-lg:14px; --r-md:10px; --pad:16px; --gap:12px; --blur:10px;
  --fs:16px; --shadow:0 10px 28px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.05);
}
:root.light{
  --bg1:#f6f7fb; --bg2:#ffffff; --card:#fff; --txt:#171a1f; --mut:#5e646b;
  --bor:rgba(0,0,0,.08); --ring:rgba(17,94,89,.20); --shadow:0 10px 24px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font:var(--fs)/1.7 "Cairo",system-ui,-apple-system,Segoe UI,Roboto;
  color:var(--txt);
  background:
    radial-gradient(1200px 600px at 10% -10%,rgba(59,130,246,.14),transparent),
    linear-gradient(160deg,var(--bg1),var(--bg2)) fixed;
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
}
body.ff-noto{font-family:"Noto Naskh Arabic",system-ui}
body.ff-inter{font-family:"Inter",system-ui}
img{max-width:100%;display:inline-block}
a{color:#fff;text-decoration:underline 1px rgba(255,255,255,.35)}
a:hover{opacity:.9}

.topbar{
  position:sticky;top:0;z-index:30;display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:10px 14px;border-bottom:1px solid var(--bor);
  background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.08));
  backdrop-filter:blur(var(--blur));
}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:40px;height:40px;object-fit:contain;border-radius:50%;cursor:pointer;box-shadow:0 0 0 2px rgba(255,255,255,.08)}
.brand h1{font-size:18px;margin:0}
.role-badge{font-size:12px;color:var(--mut);border:1px solid var(--bor);padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.05)}

.container{max-width:980px;margin:0 auto;padding:18px}
.card{background:var(--card);border:1px solid var(--bor);border-radius:var(--r-xl);padding:var(--pad);box-shadow:var(--shadow);backdrop-filter:blur(var(--blur))}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
@media(max-width:860px){.grid{grid-template-columns:1fr}}
.row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
.sep{height:1px;background:var(--bor);border-radius:999px;margin:10px 0}
.mut{color:var(--mut)}

input,select,button{border:1px solid var(--bor);border-radius:14px;background:rgba(255,255,255,.05);color:var(--txt);padding:10px 12px;outline:none;transition:.15s}
input:focus,select:focus{box-shadow:0 0 0 4px var(--ring)}
input.error{border-color:var(--warn);box-shadow:0 0 0 4px rgba(239,68,68,.20)}
button{cursor:pointer;font-weight:700;border-radius:12px;background:linear-gradient(135deg,rgba(16,185,129,.98),rgba(245,158,11,.9));border:1px solid var(--bor);color:#fff;padding:10px 14px;box-shadow:0 10px 25px rgba(0,0,0,.18)}
button.google{background:linear-gradient(135deg,#34a853,#0f9d58)}
button.warn{background:linear-gradient(135deg,#ef4444,#b91c1c)}
button.ghost{background:rgba(255,255,255,.06)}
button:disabled{opacity:.6;cursor:not-allowed}

.tabs{display:flex;gap:10px;border-bottom:1px dashed var(--bor);margin-bottom:12px}
.tab{padding:10px 14px;border-radius:12px 12px 0 0;cursor:pointer}
.tab.active{background:rgba(255,255,255,.06);box-shadow:var(--shadow)}
.view{display:none}.view.active{display:block}

.alert{display:none;position:sticky;top:10px;z-index:40;margin:0 auto 10px;padding:12px 14px;border-radius:14px;border:1px solid rgba(239,68,68,.3);background:linear-gradient(180deg,rgba(239,68,68,.20),rgba(239,68,68,.10));color:#fee2e2}
.alert.show{display:block}

.field{position:relative}
.eye{position:absolute;left:10px;top:50%;transform:translateY(-50%);cursor:pointer;user-select:none;opacity:.75}

.badge-mini {font-size:12px;padding:4px 8px;background: rgba(255,255,255,0.08);border-radius: 8px;border: 1px solid var(--bor)}

/* Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
.drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;z-index:60}
.drawer{position:fixed;top:0;bottom:0;left:0;width:min(90vw,380px);background:var(--card);border-inline-end:1px solid var(--bor);
  box-shadow:var(--shadow);transform:translateX(-100%);transition:.22s ease;z-index:70;padding:14px}
.drawer.open{transform:none}
.drawer-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}

/* ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ + Ø²Ø± Ø±ÙØ¹ */
.avatar-wrap{position:relative;display:inline-block}
.avatar{width:92px;height:92px;border-radius:50%;object-fit:cover;border:1px solid var(--bor);background:#111}
.camera-btn{
  position:absolute;bottom:-6px;left:-6px;border-radius:999px;border:1px solid var(--bor);
  width:38px;height:38px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--amber),#0ea5e9);box-shadow:var(--shadow)
}
.hidden{display:none!important}

/* Ø´Ø§Ø´Ø© ØªØ­Ù…ÙŠÙ„ Ø¨Ø³ÙŠØ·Ø© */
.loading{
  position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);z-index:80
}
.spinner{width:58px;height:58px;border-radius:50%;border:6px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
.login-box{max-width:520px;margin:0 auto}
@media (max-width:480px){
  .login-box{max-width:96%;padding:12px}
}
</style>
</head>

<body>
<header class="topbar">
  <div class="brand">
    <img src="logo.png" alt="Ø´Ø¹Ø§Ø±" class="logo" id="openSettings">
    <h1>Ø§ØªØ­Ø§Ø¯ Ø·Ø¨ Ø¨Ø´Ø±ÙŠ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</h1>
  </div>
  <div class="role-badge" id="roleBadge">ØºÙŠØ± Ù…Ø³Ø¬Ù„</div>
</header>

<main class="container">
  <div id="globalAlert" class="alert"></div>

  <!-- ===== Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ===== -->
  <section id="authView" class="view active">
    <div class="card login-box">
      <h2 style="margin-top:0">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <div class="grid">
        <div class="field">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="inEmail" type="email" placeholder="you@example.com" autocomplete="email">
        </div>
        <div class="field">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <span class="eye" id="eyeIn">ğŸ‘ï¸</span>
          <input id="inPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <label>Ø§Ù„Ù„ØºØ©</label>
          <select id="langSelAuth">
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
            <option value="en">English</option>
          </select>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button id="btnEmailLogin" type="button">Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnGoogleLogin" class="google" type="button">Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google</button>
      </div>

      <div class="row" style="margin-top:8px; gap:20px">
        <a class="linklike" id="toSignUp">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a>
        <a class="linklike" id="forgotLink">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</a>
      </div>

      <div class="mut" style="margin-top:6px">* ÙŠÙ„Ø²Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø­ÙŠØ§Ù†.</div>
    </div>

    <!-- Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ -->
    <div class="card login-box hidden" id="signupCard" style="margin-top:12px">
      <h2 style="margin-top:0">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
      <div class="grid">
        <div class="field"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</label><input id="suFirst" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…ÙˆØ¯"></div>
        <div class="field"><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</label><input id="suLast" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù…Ø§Ø±Ø©"></div>
        <div class="field"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input id="suEmail" type="email" placeholder="you@example.com" autocomplete="email"></div>
        <div class="field"><label>Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label><input id="suPhone" inputmode="tel" placeholder="01xxxxxxxxx"></div>
        <div class="field"><label>Ø§Ù„Ø¯ÙØ¹Ø©</label><input id="suBatch" inputmode="numeric" placeholder="12"></div>
        <div class="field">
          <label>Ø§Ù„Ù„ØºØ©</label>
          <select id="langSelSignup">
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="en">English</option>
          </select>
        </div>
        <div class="field"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label><span class="eye" id="eyeUp">ğŸ‘ï¸</span><input id="suPass" type="password" placeholder="8+ Ø­Ø±ÙˆÙ/Ø£Ø±Ù‚Ø§Ù…" autocomplete="new-password"></div>
        <div class="field"><label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label><input id="suPass2" type="password" placeholder="Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" autocomplete="new-password"></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnSignup" type="button" style="min-width:180px">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
        <button id="btnGoogleSignup" type="button" class="google">Ø¥Ù†Ø´Ø§Ø¡/Ø¥ÙƒÙ…Ø§Ù„ Ø¨Ø­Ø³Ø§Ø¨ Google</button>
        <a class="linklike" id="backToLogin">Ø±Ø¬ÙˆØ¹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
      </div>
    </div>
  </section>

  <!-- ===== Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== -->
  <section id="app" class="view">
    <div class="tabs" id="appTabs" style="display:none">
      <div class="tab active" data-to="viewHome">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      <div class="tab" data-to="viewProfile">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
    </div>

    <div id="viewHome" class="view active">
      <div class="card">
        <h2 style="margin:0 0 8px">Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ <span id="helloName">Ø¹Ø¶Ùˆ</span> ğŸ‘‹</h2>
        <div class="row" style="gap:8px;margin:8px 0 14px">
          <span class="badge-mini">Ø§Ù„Ø¨Ø±ÙŠØ¯: <span id="helloEmail">â€”</span></span>
          <span class="badge-mini">Ø§Ù„Ø¯ÙˆØ±: <span id="helloRole">â€”</span></span>
        </div>
        <p class="mut">Ù†Ø³Ø®Ø© Ø£ÙˆÙ„ÙŠØ© â€” Ø¨Ø¹Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‡Ù†Ø¶ÙŠÙ Ø§Ù„Ø¨ÙˆØ³ØªØ§ØªØŒ Ø­Ø¶ÙˆØ± QRâ€¦ Ø¥Ù„Ø®.</p>
      </div>
    </div>

    <div id="viewProfile" class="view">
      <div class="card">
        <h3 style="margin-top:0">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>

        <div class="row" style="gap:16px;align-items:center;margin-bottom:10px">
          <div class="avatar-wrap">
            <img id="pfAvatar" src="" alt="avatar" class="avatar">
            <button class="camera-btn" id="pickImage" title="Ø±ÙØ¹ ØµÙˆØ±Ø©"><span>ğŸ“·</span></button>
            <input id="pfFile" type="file" accept="image/*" class="hidden">
          </div>
          <input id="pfPhoto" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (URL)" style="min-width:260px">
        </div>

        <div class="grid">
          <div><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</label><input id="pfFirst"></div>
          <div><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</label><input id="pfLast"></div>
          <div><label>Ø§Ù„Ø¨Ø±ÙŠØ¯</label><input id="pfEmail" disabled></div>
          <div><label>Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label><input id="pfPhone" inputmode="tel"></div>
          <div><label>Ø§Ù„Ø¯ÙØ¹Ø©</label><input id="pfBatch" inputmode="numeric"></div>
        </div>

        <div class="row" style="margin-top:12px;justify-content:flex-end">
          <button id="saveProfile">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù</button>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Ø¯Ø±Ø¬ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
<div id="drawerBackdrop" class="drawer-backdrop"></div>
<aside id="drawer" class="drawer" aria-hidden="true">
  <div class="drawer-header">
    <strong>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</strong>
    <button class="warn" id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
  <div class="sep"></div>

  <div class="grid" style="margin-bottom:10px">
    <div>
      <label>Ø§Ù„Ø«ÙŠÙ…</label>
      <button class="google" id="toggleTheme" style="width:100%">ØªØ¨Ø¯ÙŠÙ„ Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ ğŸŒ™/â˜€ï¸</button>
    </div>
    <div>
      <label>Ø§Ù„Ù„ØºØ©</label>
      <select id="langSelSettings" style="width:100%">
        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="en">English</option>
      </select>
    </div>
    <div>
      <label>Ø§Ù„Ø®Ø·</label>
      <select id="fontSel" style="width:100%">
        <option value="cairo">Cairo (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>
        <option value="noto">Noto Naskh Arabic</option>
        <option value="inter">Inter</option>
      </select>
    </div>
    <div>
      <label>Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</label>
      <select id="fsSel" style="width:100%">
        <option value="15">ØµØºÙŠØ±</option>
        <option value="16" selected>Ø¹Ø§Ø¯ÙŠ</option>
        <option value="18">ÙƒØ¨ÙŠØ±</option>
        <option value="20">Ø£ÙƒØ¨Ø±</option>
      </select>
    </div>
  </div>
  <div class="sep"></div>
  <p class="mut" style="font-size:12px">ÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø´Ø¹Ø§Ø± Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ù…ØªØ§Ø­ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙ‚Ø·.</p>
</aside>

<!-- Overlay ØªØ­Ù…ÙŠÙ„ -->
<div class="loading" id="loading"><div class="spinner"></div></div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

<script>
/* ================= Firebase ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDfiO-4J0DIHSKZo_vdBXeS343eJ0x4pYo",
  authDomain: "ittihad-med-kfs.firebaseapp.com",
  projectId: "ittihad-med-kfs",
  appId: "1:323302922960:web:3343605d75d2a5147cdcd5",
  storageBucket: "ittihad-med-kfs.appspot.com"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
const storage = firebase.storage();

/* ================= Utils & Prefs ================= */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const val = el => (el?.value || "").trim();
const setV = (el,v)=>{ if(el) el.value = (v ?? ''); };
const OWNER_EMAILS = ["dr.emara10@gmail.com"]; // Ø¹Ø¯Ù‘Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø§Ù„ÙƒÙŠÙ† Ù„Ùˆ Ø­Ø§Ø¨Ø¨

function toast(msg, type){
  const a=$('#globalAlert'); if(!a) return;
  if(!msg){ a.classList.remove('show'); a.style.display='none'; a.textContent=''; return; }
  a.textContent = msg;
  a.style.display='block';
  a.classList.add('show');
  a.style.background = type==="ok"
    ? 'linear-gradient(180deg,rgba(34,197,94,.20),rgba(34,197,94,.10))'
    : 'linear-gradient(180deg,rgba(239,68,68,.20),rgba(239,68,68,.10))';
}
function show(vId){ $$('.view').forEach(v=>v.classList.remove('active')); $('#'+vId).classList.add('active'); }
function togglePass(inp){ const f=$(inp); if(!f) return; f.type = f.type==='password'?'text':'password'; }
function busy(on){ $('#loading').style.display = on?'flex':'none'; }
const okEmail = e => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e||'');
const min = (s,n)=> (s||'').trim().length>=n;
const mark = (el,ok)=>{ if(!el) return ok; el.classList.toggle('error',!ok); return ok; };

function setLang(l){ localStorage.setItem('lang',l); document.documentElement.lang=l; document.documentElement.dir=(l==='ar'?'rtl':'ltr');
  ['#langSelAuth','#langSelSignup','#langSelSettings'].forEach(s=>{ const e=$(s); if(e) e.value=l; }); }
function setFont(f){ localStorage.setItem('font',f); document.body.classList.remove('ff-noto','ff-inter'); if(f==='noto') document.body.classList.add('ff-noto'); if(f==='inter') document.body.classList.add('ff-inter'); }
function setFs(sz){ localStorage.setItem('fs',sz); document.documentElement.style.setProperty('--fs',(sz||16)+'px'); }
function toggleTheme(){ const light=document.documentElement.classList.toggle('light'); localStorage.setItem('theme', light?'light':'dark'); }

// Prefs init
(function(){
  setLang(localStorage.getItem('lang')||'ar');
  setFont(localStorage.getItem('font')||'cairo');
  setFs(localStorage.getItem('fs')||'16');
  if((localStorage.getItem('theme')||'dark')==='light') document.documentElement.classList.add('light');
})();

/* ============== Drawer (Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙ‚Ø·) ============== */
const drawer = $('#drawer'), backdrop = $('#drawerBackdrop');
function openDrawer(){ backdrop.style.display='block'; requestAnimationFrame(()=>drawer.classList.add('open')); }
function closeDrawer(){ drawer.classList.remove('open'); backdrop.style.display='none'; }
backdrop.addEventListener('click', closeDrawer);
$('#openSettings')?.addEventListener('click',()=>{ if(!window.__authed){ toast('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„ Ù„ÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'); return; } openDrawer(); });
$('#toggleTheme').addEventListener('click', toggleTheme);
$('#langSelSettings').addEventListener('change', e=> setLang(e.target.value));
$('#fontSel').addEventListener('change', e=> setFont(e.target.value));
$('#fsSel').addEventListener('change', e=> setFs(e.target.value));

/* ============== Auth UI actions ============== */
$('#eyeIn').addEventListener('click', ()=> togglePass('#inPass'));
$('#eyeUp').addEventListener('click', ()=> togglePass('#suPass'));
$('#toSignUp').addEventListener('click', ()=> { $('#signupCard').classList.remove('hidden'); toast(''); });
$('#backToLogin').addEventListener('click', ()=> { $('#signupCard').classList.add('hidden'); toast(''); });

/* ============== Firestore user doc helpers ============== */
async function writeUserDoc(u,data){
  const role = OWNER_EMAILS.includes((u.email||'').toLowerCase()) ? 'owner' : 'member';
  await db.collection('users').doc(u.uid).set({
    uid:u.uid,
    email:u.email||'',
    emailLower:(u.email||'').toLowerCase(),
    first:data.first||'',
    last:data.last||'',
    displayName:`${data.first||''} ${data.last||''}`.trim(),
    phone:data.phone||'',
    batch:data.batch||'',
    photoURL:data.photoURL||u.photoURL||'',
    role,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});
  return role;
}
async function loadUserDoc(uid){ const s=await db.collection('users').doc(uid).get(); return s.exists?s.data():null; }

/* ============== Auth State ============== */
auth.onAuthStateChanged(async user => {
  try{
    if(user){
      window.__authed = true;
      toast(''); // Ø§Ù…Ø³Ø­ Ø£ÙŠ Ø£Ø®Ø·Ø§Ø¡ Ù‚Ø¯ÙŠÙ…Ø©
      $('#roleBadge').textContent = '...';
      $('#appTabs').style.display='flex';
      $('#authView').classList.remove('active');
      $('#app').classList.add('active');
      await afterLogin(user);
    }else{
      window.__authed = false;
      $('#appTabs').style.display='none';
      $('#roleBadge').textContent = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
      show('authView');
    }
  }catch(e){ toast('Ø®Ø·Ø£ Ù…ØµØ§Ø¯Ù‚Ø©: '+(e.message||e), 'err'); }
});

/* ============== After login ============== */
async function afterLogin(user){
  const doc = await loadUserDoc(user.uid);
  const role = doc?.role || (OWNER_EMAILS.includes((user.email||'').toLowerCase())?'owner':'member');
  $('#roleBadge').textContent = role==='owner'?'Owner ğŸ‘‘':'Member';

  $('#helloEmail').textContent = user.email||'';
  $('#helloRole').textContent  = role==='owner'?'Owner ğŸ‘‘':'Member';

  const first = doc?.first || (user.displayName||'').split(' ')[0] || '';
  const last  = doc?.last  || (user.displayName||'').split(' ').slice(1).join(' ') || '';
  $('#helloName').textContent = (first+' '+last).trim() || 'Ø¹Ø¶Ùˆ';

  setV($('#pfEmail'), user.email||'');
  setV($('#pfFirst'), first); setV($('#pfLast'), last);
  setV($('#pfPhone'), doc?.phone||''); setV($('#pfBatch'), doc?.batch||'');
  setV($('#pfPhoto'), doc?.photoURL||'');
  $('#pfAvatar').src = doc?.photoURL || user.photoURL || '';

  // ØªØ¨ÙˆÙŠØ¨Ø§Øª
  $('#appTabs').onclick = (e)=>{
    const t = e.target.closest('.tab'); if(!t) return;
    $$('#appTabs .tab').forEach(x=>x.classList.toggle('active',x===t));
    $$('#app .view').forEach(v=>v.classList.remove('active'));
    $('#'+t.dataset.to).classList.add('active');
  };
}

/* ============== Buttons ============== */
$('#btnEmailLogin').addEventListener('click', async ()=>{
  const email=val($('#inEmail')), pass=val($('#inPass'));
  if(!okEmail(email)) { mark($('#inEmail'),false); return toast('Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± ØµØ§Ù„Ø­.', 'err'); }
  busy(true); $('#btnEmailLogin').disabled=true;
  try{
    const cred=await auth.signInWithEmailAndPassword(email,pass);
    const doc=await loadUserDoc(cred.user.uid);
    if(!doc) await writeUserDoc(cred.user,{});
    await afterLogin(cred.user);
    toast('');
  }catch(e){
    const c=e.code||'';
    if(c.includes('invalid-credential')||c.includes('wrong-password')){ mark($('#inPass'),false); toast('Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.', 'err'); }
    else toast('ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: '+(e.message||e), 'err');
  }finally{ busy(false); $('#btnEmailLogin').disabled=false; }
});

const googleProvider=new firebase.auth.GoogleAuthProvider();
$('#btnGoogleLogin').addEventListener('click', async ()=>{
  $('#btnGoogleLogin').disabled=true; busy(true);
  try{
    let cred;
    try { cred=await auth.signInWithPopup(googleProvider); }
    catch(e){ if((e.code||'').includes('popup-blocked')) cred=await auth.signInWithRedirect(googleProvider); else throw e; }
    if(!cred?.user){ toast('Ø£ÙƒÙ…Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù…Ù† Google.'); return; }
    const doc=await loadUserDoc(cred.user.uid);
    if(!doc) await writeUserDoc(cred.user,{ first:(cred.user.displayName||'').split(' ')[0]||'' });
    await afterLogin(cred.user);
    toast('');
  }catch(e){ toast('Ø¥Ù„ØºØ§Ø¡/Ø®Ø·Ø£ Google: '+(e.message||e), 'err'); }
  finally{ busy(false); $('#btnGoogleLogin').disabled=false; }
});

$('#btnSignup').addEventListener('click', async ()=>{
  const first=val($('#suFirst')), last=val($('#suLast'));
  const email=val($('#suEmail')), phone=val($('#suPhone'));
  const batch=val($('#suBatch')), pass=val($('#suPass')), pass2=val($('#suPass2'));
  const ok=[
    mark($('#suFirst'),min(first,2)), mark($('#suLast'),min(last,2)),
    mark($('#suEmail'),okEmail(email)), mark($('#suPhone'),min(phone,7)),
    mark($('#suBatch'),min(batch,1)), mark($('#suPass'),min(pass,8)),
    mark($('#suPass2'),pass===pass2)
  ].every(Boolean);
  if(!ok) return toast('Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø­Ù…Ø±Ø§Ø¡.', 'err');
  $('#btnSignup').disabled=true; busy(true);
  try{
    const cred=await auth.createUserWithEmailAndPassword(email,pass);
    const role=await writeUserDoc(cred.user,{first,last,phone,batch});
    setLang($('#langSelSignup').value);
    await afterLogin(cred.user);
    toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ…','ok');
  }catch(e){ toast('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: '+(e.message||e), 'err'); }
  finally{ $('#btnSignup').disabled=false; busy(false); }
});

$('#btnGoogleSignup').addEventListener('click', async ()=>{
  $('#btnGoogleSignup').disabled=true; busy(true);
  try{
    let cred;
    try { cred=await auth.signInWithPopup(googleProvider); }
    catch(e){ if((e.code||'').includes('popup-blocked')) cred=await auth.signInWithRedirect(googleProvider); else throw e; }
    if(!cred?.user){ toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù…Ù† Google.'); return; }
    const doc=await loadUserDoc(cred.user.uid);
    if(!doc){
      const parts=(cred.user.displayName||'').split(' ');
      setV($('#suEmail'),cred.user.email||'');
      setV($('#suFirst'),parts[0]||''); setV($('#suLast'),parts.slice(1).join(' ')||'');
      $('#signupCard').classList.remove('hidden');
      toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯".');
    }else{
      await afterLogin(cred.user); toast('');
    }
  }catch(e){ toast('Ø¥Ù„ØºØ§Ø¡/Ø®Ø·Ø£ Google: '+(e.message||e), 'err'); }
  finally{ $('#btnGoogleSignup').disabled=false; busy(false); }
});

/* ===== Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (Ù…Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù‚Ù‚ Ù‡Ø§ØªÙ+Ø¯ÙØ¹Ø© Ù„Ùˆ Ù…ØªØ§Ø­Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©) ===== */
$('#forgotLink').addEventListener('click', async ()=>{
  const email=val($('#inEmail'));
  if(!okEmail(email)) { mark($('#inEmail'),false); return toast('Ø§ÙƒØªØ¨ Ø¨Ø±ÙŠØ¯Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§.', 'err'); }
  try{
    // Ù†Ø­Ø§ÙˆÙ„ Ù†Ù‚Ø±Ø£ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ­Ù‚Ù‚ (Ù‚Ø¯ ØªÙÙ…Ù†Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯)
    const q = await db.collection('users').where('emailLower','==',email.toLowerCase()).limit(1).get();
    if(!q.empty){
      const d = q.docs[0].data();
      const phone = prompt('Ù„Ù„ØªØ£ÙƒØ¯: Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ù…Ø³Ø¬Ù„'); 
      const batch = prompt('ÙˆØ§ÙƒØªØ¨ Ø§Ù„Ø¯ÙØ¹Ø©');
      if((phone||'').trim() !== (d.phone||'').trim() || (batch||'').trim() !== (d.batch||'').trim()){
        return toast('Ø§Ù„ØªØ­Ù‚Ù‚ ÙØ´Ù„. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.', 'err');
      }
    }
    await auth.sendPasswordResetEmail(email);
    toast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.', 'ok');
  }catch(e){
    toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„/Ø§Ù„ØªØ­Ù‚Ù‚ (Ù‚ÙˆØ§Ø¹Ø¯ Firestore Ø±Ø¨Ù…Ø§ ØªÙ…Ù†Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©).', 'err');
  }
});

/* ===== Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ===== */
$('#saveProfile').addEventListener('click', async ()=>{
  const u=auth.currentUser; if(!u) return;
  const first=val($('#pfFirst')), last=val($('#pfLast'));
  const phone=val($('#pfPhone')), batch=val($('#pfBatch')), photo=val($('#pfPhoto'));
  if(!min(first,1)||!min(last,1)) return toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø§Ø³Ù….', 'err');
  try{
    await db.collection('users').doc(u.uid).set({
      first,last,phone,batch,photoURL:photo,displayName:(first+' '+last).trim(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
    $('#helloName').textContent=(first+' '+last).trim();
    $('#pfAvatar').src = photo || $('#pfAvatar').src;
    toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù âœ…','ok');
  }catch(e){ toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸: '+(e.message||e), 'err'); }
});

/* ===== Ø±ÙØ¹ ØµÙˆØ±Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Firebase Storage ===== */
$('#pickImage').addEventListener('click', ()=> $('#pfFile').click());
$('#pfFile').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const u = auth.currentUser; if(!u){ toast('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§.', 'err'); return; }
  busy(true);
  try{
    const ext = (f.name.split('.').pop()||'jpg').toLowerCase();
    const ref = storage.ref().child(`avatars/${u.uid}.${ext}`);
    await ref.put(f,{contentType:f.type||'image/jpeg', cacheControl:'public,max-age=31536000'});
    const url = await ref.getDownloadURL();
    $('#pfAvatar').src = url;
    setV($('#pfPhoto'), url);
    await db.collection('users').doc(u.uid).set({ photoURL:url, updatedAt: firebase.firestore.FieldValue.serverTimestamp() },{merge:true});
    toast('ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ÙˆØªØ«Ø¨ÙŠØªÙ‡Ø§ âœ…','ok');
  }catch(e){
    toast('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: '+(e.message||e), 'err');
  }finally{
    busy(false); e.target.value='';
  }
});

/* ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ===== */
$('#logoutBtn').addEventListener('click', async ()=>{
  await auth.signOut();
  closeDrawer();
  $('#appTabs').style.display='none';
  $('#roleBadge').textContent='ØºÙŠØ± Ù…Ø³Ø¬Ù„';
  show('authView');
  toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬','ok');
});

/* ===== ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ===== */
$('#langSelAuth').addEventListener('change', e=> setLang(e.target.value));
$('#langSelSignup').addEventListener('change', e=> setLang(e.target.value));
</script>
</body>
</html>
