<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ø§ØªØ­Ø§Ø¯ Ø·Ø¨ Ø¨Ø´Ø±ÙŠ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</title>
<meta name="theme-color" content="#0b1220"/>

<style>
:root{
  --bg:#0b1220; --bg2:#0e1426; --card:#10192f; --ink:#e8eefc; --mut:#97a2b8; --bor:#1e2a44;
  --acc:#22c55e; --acc2:#f59e0b; --danger:#ef4444; --ok:#10b981; --ring:rgba(34,197,94,.25);
  --radius:16px; --rsm:10px; --pad:14px; --gap:12px;
}
:root.light{
  --bg:#f6f8ff; --bg2:#ffffff; --card:#ffffff; --ink:#0f172a; --mut:#5b6580; --bor:#e3e8f5;
  --acc:#16a34a; --ring:rgba(22,163,74,.25);
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; font:15.5px/1.75 ui-rounded,system-ui,Segoe UI,Arial;
  color:var(--ink); background:linear-gradient(160deg,var(--bg),var(--bg2)) fixed;
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
}
.wrap{max-width:980px;margin:0 auto;padding:18px}
.top{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  position:sticky; top:0; z-index:50; padding:10px 16px;
  background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,0));
  backdrop-filter:blur(8px); border-bottom:1px solid var(--bor)
}
.brand{display:flex; align-items:center; gap:12px}
.brand img{height:38px; width:38px; object-fit:contain; filter:drop-shadow(0 0 10px rgba(0,0,0,.4))}
.title{font-weight:800; letter-spacing:.2px}
.badge{border:1px solid var(--bor); color:var(--mut); background:rgba(255,255,255,.04);
  padding:6px 12px; border-radius:999px; font-size:12px}
.btn{cursor:pointer; border:1px solid var(--bor); border-radius:12px; padding:10px 14px;
  color:#fff; background:linear-gradient(135deg,rgba(34,197,94,.22),rgba(245,158,11,.18));
  box-shadow:0 8px 22px rgba(0,0,0,.18); transition:.14s}
.btn:hover{filter:brightness(1.06)} .btn:active{transform:translateY(1px)}
.btn.ghost{background:rgba(255,255,255,.04); color:var(--ink)}
.btn.danger{background:linear-gradient(135deg,rgba(239,68,68,.25),rgba(239,68,68,.15))}
.link{color:#fff; text-decoration:none; border-bottom:1px dashed #fff4}
.link.muted{color:var(--mut); border-color:transparent}
.card{
  background:var(--card); border:1px solid var(--bor); border-radius:var(--radius);
  padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.04)
}
.grid{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap)}
@media(max-width:760px){.grid{grid-template-columns:1fr}}
input,select,button,textarea{
  outline:none; border:1px solid var(--bor); border-radius:12px; padding:12px 14px;
  background:#0d172c; color:var(--ink); transition:.18s
}
:root.light input,:root.light select,:root.light textarea{background:#f7f9ff}
input:focus,select:focus,textarea:focus{box-shadow:0 0 0 4px var(--ring); border-color:color-mix(in srgb,var(--acc) 55%, transparent)}
.field{margin-bottom:12px}
.field label{display:block; margin-bottom:6px; color:var(--mut)}
.row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.right{margin-inline-start:auto}
.center{text-align:center}
.err{color:#fecaca; background:#7f1d1d; border:1px solid #dc2626; padding:10px 12px; border-radius:12px; display:none}
.ok{color:#d1fae5; background:#064e3b; border:1px solid #10b981; padding:10px 12px; border-radius:12px; display:none}
.show{display:block}
.eye{position:absolute; inset-inline-start:-36px; top:50%; transform:translateY(-50%); cursor:pointer; opacity:.7}
.sep{height:1px; background:var(--bor); margin:12px 0; border-radius:999px}
.tabs{display:flex; gap:8px; border-bottom:1px solid var(--bor); margin-bottom:14px}
.tab{background:transparent; border:1px solid var(--bor); padding:8px 12px; color:var(--mut); border-radius:10px 10px 0 0; cursor:pointer}
.tab.active{background:#0d172c; color:#fff; border-bottom-color:#0d172c}
.view{display:none} .view.active{display:block}
.footerNote{color:var(--mut); font-size:12px}
.small{font-size:12.5px; color:var(--mut)}
.linkbar a{color:#fff; text-decoration:none; margin-inline:8px; border-bottom:1px dashed #fff4}
</style>
</head>
<body>

<!-- ================== Header ================== -->
<header class="top">
  <div class="brand">
    <img src="logo.png" alt="Ø´Ø¹Ø§Ø±" onerror="this.style.display='none'"/>
    <div class="title">Ø§ØªØ­Ø§Ø¯ Ø·Ø¨ Ø¨Ø´Ø±ÙŠ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</div>
  </div>
  <div class="row">
    <span id="authBadge" class="badge">ØºÙŠØ± Ù…Ø³Ø¬Ù„</span>
    <button id="btnTheme" class="btn ghost">ØªØ¨Ø¯ÙŠÙ„ Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ</button>
  </div>
</header>

<div class="wrap">

  <!-- =============== LOGIN VIEW =============== -->
  <section id="viewLogin" class="view active">
    <div class="card">
      <h2 class="center">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>

      <div id="loginErr" class="err"></div>
      <div id="loginOk"  class="ok"></div>

      <div class="grid" style="position:relative">
        <div class="field">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="inEmail" type="email" placeholder="you@example.com" autocomplete="email">
        </div>
        <div class="field" style="position:relative">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <span class="eye" id="eyeLogin">ğŸ‘ï¸</span>
          <input id="inPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
        </div>
      </div>

      <div class="grid">
        <div class="field">
          <label>Ø§Ù„Ù„ØºØ©</label>
          <select id="loginLang">
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
            <option value="en">English</option>
            <option value="es">EspaÃ±ol</option>
            <option value="fr">FranÃ§ais</option>
            <option value="de">Deutsch</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnLogin" class="btn">Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
        <button id="btnGoogle" class="btn">Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google</button>
        <div class="right linkbar">
          <a id="linkSignup" href="#">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a>
          <a id="linkForgot" href="#">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</a>
        </div>
      </div>

      <p class="footerNote" style="margin-top:10px">* ÙŠÙ„Ø²Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø­ÙŠØ§Ù†.</p>
    </div>
  </section>

  <!-- =============== SIGNUP VIEW =============== -->
  <section id="viewSignup" class="view">
    <div class="card">
      <h2 class="center">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>

      <div id="signupErr" class="err"></div>
      <div id="signupOk"  class="ok"></div>

      <div class="grid">
        <div class="field">
          <label>Ø§Ù„Ø§Ø³Ù… (Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©)</label>
          <input id="suName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ">
        </div>
        <div class="field">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
          <input id="suPhone" inputmode="numeric" pattern="[0-9]*" placeholder="Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·">
        </div>
      </div>

      <div class="grid">
        <div class="field">
          <label>Ø§Ù„Ø¯ÙØ¹Ø©</label>
          <input id="suBatch" type="number" min="1" max="200" placeholder="Ù…Ø«Ø§Ù„: 72">
        </div>
        <div class="field">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="suEmail" type="email" placeholder="you@example.com" autocomplete="email">
        </div>
      </div>

      <div class="grid" style="position:relative">
        <div class="field" style="position:relative">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <span class="eye" id="eyeSu1">ğŸ‘ï¸</span>
          <input id="suPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password">
        </div>
        <div class="field" style="position:relative">
          <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <span class="eye" id="eyeSu2">ğŸ‘ï¸</span>
          <input id="suPass2" type="password" placeholder="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„" autocomplete="new-password">
        </div>
      </div>

      <div class="grid">
        <div class="field">
          <label>Ø§Ù„Ù„ØºØ©</label>
          <select id="signupLang">
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
            <option value="en">English</option>
            <option value="es">EspaÃ±ol</option>
            <option value="fr">FranÃ§ais</option>
            <option value="de">Deutsch</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnSignup" class="btn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
        <a id="linkBackLogin" class="link right" href="#">Ø±Ø¬ÙˆØ¹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
      </div>
    </div>
  </section>

  <!-- =============== APP (AFTER LOGIN) =============== -->
  <section id="viewApp" class="view">
    <div class="card">
      <div class="row">
        <div class="title">Ù…Ø±Ø­Ø¨Ù‹Ø§ <span id="helloName">â€”</span></div>
        <div class="right">
          <span id="roleBadge" class="badge">Member</span>
          <button id="btnLogout" class="btn danger">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="tabs">
        <button class="tab active" data-tab="homeTab">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="tab" data-tab="profileTab">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
        <button class="tab" data-tab="settingsTab">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      </div>

      <div id="homeTab" class="tabview">
        <p>Ù†Ø³Ø®Ø© Ø£ÙˆÙ„ÙŠØ© â€” Ø¨Ø¹Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‡Ù†Ø¶ÙŠÙ Ø§Ù„Ø¨ÙˆØ³ØªØ§ØªØŒ Ø­Ø¶ÙˆØ± QRâ€¦ Ø¥Ù„Ø®.</p>
      </div>

      <div id="profileTab" class="tabview" style="display:none">
        <div class="grid">
          <div class="field">
            <label>Ø§Ù„Ø§Ø³Ù…</label>
            <input id="pfName">
          </div>
          <div class="field">
            <label>Ø§Ù„Ø¨Ø±ÙŠØ¯</label>
            <input id="pfEmail" disabled>
          </div>
          <div class="field">
            <label>Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
            <input id="pfPhone">
          </div>
          <div class="field">
            <label>Ø§Ù„Ø¯ÙØ¹Ø©</label>
            <input id="pfBatch" type="number" min="1" max="200">
          </div>
          <div class="field">
            <label>ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (URL Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)</label>
            <input id="pfPhoto" placeholder="https://â€¦">
          </div>
        </div>
        <div class="row">
          <button id="btnSaveProfile" class="btn">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù</button>
        </div>
      </div>

      <div id="settingsTab" class="tabview" style="display:none">
        <div class="grid">
          <div class="field">
            <label>Ø§Ù„ÙˆØ¶Ø¹</label><br/>
            <button id="btnTheme2" class="btn ghost">ØªØ¨Ø¯ÙŠÙ„ Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ</button>
          </div>
          <div class="field">
            <label>Ø§Ù„Ù„ØºØ©</label>
            <select id="appLang">
              <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
              <option value="en">English</option>
              <option value="es">EspaÃ±ol</option>
              <option value="fr">FranÃ§ais</option>
              <option value="de">Deutsch</option>
            </select>
          </div>
        </div>
        <p class="small">* Ø³ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.</p>
      </div>
    </div>
  </section>

</div>

<!-- ================== Firebase (Compat) ================== -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics-compat.js"></script>

<script>
/* ========= Theme & Small helpers ========= */
(function(){
  const btn1=document.getElementById('btnTheme'), btn2=document.getElementById('btnTheme2');
  const apply=()=>{ document.documentElement.classList.toggle('light'); localStorage.setItem('theme', document.documentElement.classList.contains('light')?'light':'dark'); };
  const boot=localStorage.getItem('theme'); if(boot==='light') document.documentElement.classList.add('light');
  if(btn1) btn1.onclick=apply; if(btn2) btn2.onclick=apply;
})();
const $ = s=>document.querySelector(s);
const $$ = s=>[...document.querySelectorAll(s)];
function show(id){ $$('.view').forEach(v=>v.classList.remove('active')); $('#'+id).classList.add('active'); }
function toast(el,msg,ok=false){ if(!el) return; el.textContent=msg; el.classList.add('show'); if(ok){ el.classList.remove('err'); el.classList.add('ok'); } else { el.classList.remove('ok'); el.classList.add('err'); } setTimeout(()=>el.classList.remove('show'), 4500); }
function toggleEye(eye,input){ eye?.addEventListener('click',()=>{ input.type=(input.type==='password'?'text':'password'); }); }

/* ========= Language (basic wiring) ========= */
(function(){
  const loginLang=$('#loginLang'), signupLang=$('#signupLang'), appLang=$('#appLang');
  const set=(v)=>{ localStorage.setItem('lang', v); [loginLang,signupLang,appLang].forEach(s=>{ if(s) s.value=v; }); document.documentElement.lang=v; document.dir=(v==='ar'?'rtl':'ltr'); };
  const boot=localStorage.getItem('lang')||'ar'; set(boot);
  [loginLang,signupLang,appLang].forEach(s=> s && (s.onchange=()=>set(s.value)));
})();

/* ========= Firebase Config + Boot ========= */
const firebaseConfig = {
  apiKey: "AIzaSyDfiO-4J0DIHSKZo_vdBXeS343eJ0x4pYo",
  authDomain: "ittihad-med-kfs.firebaseapp.com",
  projectId: "ittihad-med-kfs",
  appId: "1:323302922960:web:3343605d75d2a5147cdcd5"
};
firebase.initializeApp(firebaseConfig);
try{ firebase.analytics(); }catch(e){}

/* ========= Globals ========= */
const auth=firebase.auth();
const db  =firebase.firestore();
const OWNER_EMAIL="dr.emara10@gmail.com".toLowerCase();

/* ========= UI Refs ========= */
const badge  = $('#authBadge');
const eyeLogin=$('#eyeLogin'), eyeSu1=$('#eyeSu1'), eyeSu2=$('#eyeSu2');
toggleEye(eyeLogin,$('#inPass')); toggleEye(eyeSu1,$('#suPass')); toggleEye(eyeSu2,$('#suPass2'));

$('#linkSignup').onclick=(e)=>{ e.preventDefault(); show('viewSignup'); };
$('#linkBackLogin').onclick=(e)=>{ e.preventDefault(); show('viewLogin'); };
$('#linkForgot').onclick= async (e)=>{
  e.preventDefault();
  const email=prompt('Ø§Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:');
  if(!email) return;
  try{ await auth.sendPasswordResetEmail(email); alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ.'); }
  catch(err){ alert('Ø®Ø·Ø£: '+(err.message||err)); }
};

/* ========= Signup ========= */
$('#btnSignup').onclick= async ()=>{
  const name = ($('#suName').value||'').trim();
  const phone= ($('#suPhone').value||'').replace(/\D/g,'');
  const batch= parseInt($('#suBatch').value||'0',10);
  const email= ($('#suEmail').value||'').trim();
  const pass = $('#suPass').value||'';
  const pass2= $('#suPass2').value||'';

  const err=$('#signupErr'), ok=$('#signupOk');

  if(name.length<5 || !name.includes(' ')) return toast(err,'Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„: Ø§Ø³Ù… + Ø¹Ø§Ø¦Ù„Ø© (â‰¥ 5 Ø­Ø±ÙˆÙ)');
  if(phone.length<10 || phone.length>15)   return toast(err,'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­ (10â€“15 Ø±Ù‚Ù…).');
  if(!(batch>=1 && batch<=200))            return toast(err,'Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø¯ÙØ¹Ø© ØµØ­ÙŠØ­ (1â€“200).');
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return toast(err,'Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­.');
  if(pass.length<6)                         return toast(err,'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ø§ ØªÙ‚Ù„ Ø¹Ù† 6 Ø­Ø±ÙˆÙ.');
  if(pass!==pass2)                          return toast(err,'ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚.');

  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await cred.user.updateProfile({ displayName: name });
    // Ø§ÙƒØªØ¨ Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    await db.collection('users').doc(cred.user.uid).set({
      uid: cred.user.uid,
      email: email.toLowerCase(),
      displayName: name,
      phone, batch,
      role: (email.toLowerCase()===OWNER_EMAIL?'owner':'member'),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
    toast(ok,'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…',true);
    show('viewApp');
  }catch(e){
    toast(err, 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨: ' + (e.code||e.message||e));
  }
};

/* ========= Login ========= */
$('#btnLogin').onclick= async ()=>{
  const email=($('#inEmail').value||'').trim();
  const pass =$('#inPass').value||'';
  const err=$('#loginErr'), ok=$('#loginOk');

  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return toast(err,'ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
  if(pass.length<6) return toast(err,'ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.');

  try{
    const cred=await auth.signInWithEmailAndPassword(email,pass);
    toast(ok,'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…',true);
    show('viewApp');
  }catch(e){
    toast(err,'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + (e.code||e.message||e));
  }
};

/* ========= Google Sign-In ========= */
$('#btnGoogle').onclick= async ()=>{
  try{
    const provider=new firebase.auth.GoogleAuthProvider();
    const res=await auth.signInWithPopup(provider);
    const u=res.user;
    await db.collection('users').doc(u.uid).set({
      uid:u.uid, email:u.email.toLowerCase(), displayName:u.displayName||'', role:(u.email.toLowerCase()===OWNER_EMAIL?'owner':'member')
    },{merge:true});
    show('viewApp');
  }catch(e){
    toast($('#loginErr'),'Google Sign-In: '+(e.code||e.message||e));
  }
};

/* ========= Logout ========= */
$('#btnLogout').onclick=()=>auth.signOut();

/* ========= Tabs ========= */
$$('.tab').forEach(b=>{
  b.onclick=()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    $$('.tabview').forEach(x=>x.style.display='none');
    document.getElementById(b.dataset.tab).style.display='';
  };
});

/* ========= Profile Save ========= */
$('#btnSaveProfile').onclick= async ()=>{
  const u=auth.currentUser; if(!u) return alert('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
  try{
    const name=($('#pfName').value||'').trim();
    const phone=($('#pfPhone').value||'').replace(/\D/g,'');
    const batch=parseInt($('#pfBatch').value||'0',10);
    const photo=($('#pfPhoto').value||'').trim();
    if(name.length<5 || !name.includes(' ')) return alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„ (Ø§Ø³Ù… + Ø¹Ø§Ø¦Ù„Ø©).');
    await u.updateProfile({displayName:name, photoURL: photo||null});
    await db.collection('users').doc(u.uid).set({displayName:name, phone, batch, photoURL:photo||null},{merge:true});
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù.');
  }catch(e){ alert('Ø®Ø·Ø£: '+(e.message||e)); }
};

/* ========= Auth State ========= */
auth.onAuthStateChanged(async (u)=>{
  if(!u){
    badge.textContent='ØºÙŠØ± Ù…Ø³Ø¬Ù„';
    show('viewLogin');
    return;
  }
  // load user doc
  try{
    const doc=await db.collection('users').doc(u.uid).get();
    const role = (doc.exists && doc.data().role) ? doc.data().role : (u.email.toLowerCase()===OWNER_EMAIL?'owner':'member');
    $('#helloName').textContent = u.displayName || (doc.exists? (doc.data().displayName||'Ø¹Ø¶Ùˆ'): 'Ø¹Ø¶Ùˆ');
    $('#pfName').value  = u.displayName || (doc.exists? (doc.data().displayName||'') : '');
    $('#pfEmail').value = u.email||'';
    $('#pfPhone').value = doc.exists? (doc.data().phone||'') : '';
    $('#pfBatch').value = doc.exists? (doc.data().batch||'') : '';
    $('#pfPhoto').value = (u.photoURL|| (doc.exists? (doc.data().photoURL||'') : ''));

    badge.textContent = (role==='owner' ? 'Owner ğŸ‘‘' : 'Ø¹Ø¶Ùˆ');
    $('#roleBadge').textContent = (role==='owner' ? 'Owner ğŸ‘‘' : 'Member');
    show('viewApp');
  }catch(e){
    badge.textContent='âš ï¸ Firestore';
    console.error(e);
  }
});

/* ========= Ping Firestore (Banner on rules error) ========= */
(async ()=>{
  try{
    await db.collection('ping').doc('hello').set({ t: Date.now() }, {merge:true});
  }catch(e){
    const b=document.createElement('div');
    b.className='err show';
    b.textContent='Firestore error: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ (Rules) Ø£Ùˆ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©.';
    document.querySelector('.wrap').prepend(b);
  }
})();
</script>
</body>
         </html>
