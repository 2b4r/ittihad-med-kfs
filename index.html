<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<metaname="viewport" content="width=device-width, initial-scale=1"/>
<title id="t_site">Ø§ØªØ­Ø§Ø¯ Ø·Ø¨ Ø¨Ø´Ø±ÙŠ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&family=Inter:wght@400;600;800&family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg1:#0f1217; --bg2:#0b0d11; --card:rgba(255,255,255,.05);
  --txt:#eef1f4; --mut:#a6acb3; --bor:rgba(255,255,255,.10);
  --acc:#10b981; --warn:#ef4444; --ring:rgba(16,185,129,.34);
  --r-xl:18px; --r-lg:14px; --pad:16px; --gap:12px; --blur:10px; --fs:16px;
  --shadow:0 10px 28px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.05);
}
:root.light{ --bg1:#f6f7fb; --bg2:#ffffff; --card:#fff; --txt:#171a1f; --mut:#5e646b; --bor:rgba(0,0,0,.08); --ring:rgba(17,94,89,.20); --shadow:0 10px 24px rgba(0,0,0,.08) }
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font:var(--fs)/1.7 "Cairo",system-ui,-apple-system,Segoe UI,Roboto;
  color:var(--txt);
  background:radial-gradient(1200px 600px at 10% -10%,rgba(59,130,246,.14),transparent),
             linear-gradient(160deg,var(--bg1),var(--bg2)) fixed;
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
}
body.ff-noto{font-family:"Noto Naskh Arabic",system-ui}
body.ff-inter{font-family:"Inter",system-ui}
a{color:#fff;text-decoration:underline 1px rgba(255,255,255,.35)}

.topbar{position:sticky;top:0;z-index:30;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 14px;border-bottom:1px solid var(--bor);background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.08));backdrop-filter:blur(var(--blur))}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:40px;height:40px;object-fit:contain;border-radius:50%;cursor:pointer;box-shadow:0 0 0 2px rgba(255,255,255,.08)}
.brand h1{font-size:18px;margin:0}
.role-badge{font-size:12px;color:var(--mut);border:1px solid var(--bor);padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.05)}

.container{max-width:980px;margin:0 auto;padding:18px}
.card{background:var(--card);border:1px solid var(--bor);border-radius:var(--r-xl);padding:var(--pad);box-shadow:var(--shadow);backdrop-filter:blur(var(--blur))}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
@media(max-width:860px){.grid{grid-template-columns:1fr}}
.row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
.sep{height:1px;background:var(--bor);border-radius:999px;margin:10px 0}
.mut{color:var(--mut)}
.badge-mini{font-size:12px;padding:4px 8px;background:rgba(255,255,255,.08);border-radius:8px;border:1px solid var(--bor)}

input,select,button{border:1px solid var(--bor);border-radius:14px;background:rgba(255,255,255,.05);color:var(--txt);padding:10px 12px;outline:none;transition:.15s}
input:focus,select:focus{box-shadow:0 0 0 4px var(--ring)}
input.error{border-color:var(--warn);box-shadow:0 0 0 4px rgba(239,68,68,.20)}
button{cursor:pointer;font-weight:700;border-radius:12px;background:linear-gradient(135deg,rgba(16,185,129,.98),rgba(245,158,11,.9));border:1px solid var(--bor);color:#fff;padding:10px 14px;box-shadow:0 10px 25px rgba(0,0,0,.18)}
button.google{background:linear-gradient(135deg,#34a853,#0f9d58)}
button.warn{background:linear-gradient(135deg,#ef4444,#b91c1c)}
button:disabled{opacity:.6;cursor:not-allowed}

.tabs{display:flex;gap:10px;border-bottom:1px dashed var(--bor);margin-bottom:12px}
.tab{padding:10px 14px;border-radius:12px 12px 0 0;cursor:pointer}
.tab.active{background:rgba(255,255,255,.06);box-shadow:var(--shadow)}
.view{display:none}.view.active{display:block}
.alert{display:none;position:sticky;top:10px;z-index:40;margin:0 auto 10px;padding:12px 14px;border-radius:14px;border:1px solid rgba(239,68,68,.3);background:linear-gradient(180deg,rgba(239,68,68,.20),rgba(239,68,68,.10));color:#fee2e2}
.alert.show{display:block}
.field{position:relative}
.eye{position:absolute;left:10px;top:50%;transform:translateY(-50%);cursor:pointer;user-select:none;opacity:.75}

/* Drawer */
.drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;z-index:60}
.drawer{position:fixed;top:0;bottom:0;left:0;width:min(90vw,380px);background:var(--card);border-inline-end:1px solid var(--bor);box-shadow:var(--shadow);transform:translateX(-100%);transition:.2s ease;z-index:70;padding:14px}
.drawer.open{transform:none}
.drawer-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}

/* Avatar */
.avatar-wrap{display:flex;align-items:center;gap:14px;margin-bottom:10px}
.avatar{width:84px;height:84px;border-radius:50%;object-fit:cover;border:2px solid var(--bor);background:#222}
.avatar-btn{border:1px dashed var(--bor);background:rgba(255,255,255,.06)}
.linklike{cursor:pointer;color:#fff;text-decoration:underline}
</style>
</head>

<body>
<header class="topbar">
  <div class="brand">
    <img src="logo.png" alt="Ø´Ø¹Ø§Ø±" class="logo" id="btnOpenSettings" onerror="this.style.display='none'">
    <h1 id="t_header">Ø§ØªØ­Ø§Ø¯ Ø·Ø¨ Ø¨Ø´Ø±ÙŠ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</h1>
  </div>
  <div class="role-badge" id="roleBadge">ØºÙŠØ± Ù…Ø³Ø¬Ù„</div>
</header>

<main class="container">
  <div id="globalAlert" class="alert"></div>

  <div id="tabs" class="tabs" style="display:none">
    <div class="tab active" data-view="homeView" onclick="switchTab(this)" id="t_tab_home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    <div class="tab" data-view="profileView" onclick="switchTab(this)" id="t_tab_profile">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
  </div>

  <!-- Auth -->
  <section id="authView" class="view active">
    <div class="card">
      <h2 style="margin-top:0" id="t_login_title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <div class="grid">
        <div class="field">
          <label id="t_email_lbl">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="inEmail" type="email" placeholder="you@example.com" autocomplete="email">
        </div>
        <div class="field">
          <label id="t_pass_lbl">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <span class="eye" onclick="togglePass('inPass')">ğŸ‘ï¸</span>
          <input id="inPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <label id="t_lang_lbl">Ø§Ù„Ù„ØºØ©</label>
          <select id="langSelAuth" onchange="setLang(this.value)">
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
            <option value="en">English</option>
          </select>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button id="btnEmailLogin" type="button" onclick="emailLogin()"><span id="t_btn_email_login">Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯</span></button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnGoogleLogin" class="google" type="button" onclick="googleLogin()"><span id="t_btn_google_login">Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google</span></button>
      </div>

      <div class="row" style="margin-top:8px; gap:20px">
        <a class="linklike" onclick="showView('signupView')" id="t_to_signup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a>
        <a class="linklike" onclick="openForgot()" id="t_forgot">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</a>
      </div>

      <div class="mut" style="margin-top:6px" id="t_mail_note">* ÙŠÙ„Ø²Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø­ÙŠØ§Ù†.</div>
    </div>
  </section>

  <!-- Signup -->
  <section id="signupView" class="view">
    <div class="card">
      <h2 style="margin-top:0" id="t_signup_title">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
      <div class="grid">
        <div class="field"><label id="t_first_lbl">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</label><input id="suFirst" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…ÙˆØ¯"></div>
        <div class="field"><label id="t_last_lbl">Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</label><input id="suLast" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù…Ø§Ø±Ø©"></div>
        <div class="field"><label id="t_email2_lbl">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input id="suEmail" type="email" placeholder="you@example.com" autocomplete="email"></div>
        <div class="field"><label id="t_phone_lbl">Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label><input id="suPhone" inputmode="tel" placeholder="01xxxxxxxxx"></div>
        <div class="field"><label id="t_batch_lbl">Ø§Ù„Ø¯ÙØ¹Ø©</label><input id="suBatch" inputmode="numeric" placeholder="12"></div>
        <div class="field">
          <label id="t_lang2_lbl">Ø§Ù„Ù„ØºØ©</label>
          <select id="langSelSignup" onchange="setLang(this.value)">
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="en">English</option>
          </select>
        </div>
        <div class="field"><label id="t_pass2_lbl">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label><span class="eye" onclick="togglePass('suPass')">ğŸ‘ï¸</span><input id="suPass" type="password" placeholder="8+ Ø­Ø±ÙˆÙ/Ø£Ø±Ù‚Ø§Ù…" autocomplete="new-password"></div>
        <div class="field"><label id="t_pass3_lbl">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label><input id="suPass2" type="password" placeholder="Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" autocomplete="new-password"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnSignup" type="button" onclick="signup()" style="min-width:180px"><span id="t_btn_signup_email">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯</span></button>
        <button id="btnGoogleSignup" type="button" class="google" onclick="googleSignup()" ><span id="t_btn_signup_google">Ø¥Ù†Ø´Ø§Ø¡/Ø¥ÙƒÙ…Ø§Ù„ Ø¨Ø­Ø³Ø§Ø¨ Google</span></button>
        <a class="linklike" onclick="showView('authView')" id="t_back_login">Ø±Ø¬ÙˆØ¹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
      </div>
    </div>
  </section>

  <!-- Home -->
  <section id="homeView" class="view">
    <div class="card">
      <h2 style="margin:0 0 8px"><span id="t_welcome">Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ</span> <span id="helloName">Ø¹Ø¶Ùˆ</span></h2>
      <div class="row" style="gap:8px">
        <span class="badge-mini"><span id="t_status">Ø§Ù„Ø­Ø§Ù„Ø©:</span> <span id="badAuth">â€”</span></span>
        <span class="badge-mini"><span id="t_role">Ø§Ù„Ø¯ÙˆØ±:</span> <span id="badRole">â€”</span></span>
      </div>
      <div class="sep"></div>
      <p class="mut" id="t_home_note">Ù†Ø³Ø®Ø© Ø£ÙˆÙ„ÙŠØ© â€” Ø¨Ø¹Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‡Ù†Ø¶ÙŠÙ Ø§Ù„Ø¨ÙˆØ³ØªØ§ØªØŒ Ø­Ø¶ÙˆØ± QRâ€¦ Ø¥Ù„Ø®.</p>
    </div>
  </section>

  <!-- Profile -->
  <section id="profileView" class="view">
    <div class="card">
      <h3 style="margin-top:0" id="t_profile_title">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>

      <!-- Avatar + pick -->
      <div class="avatar-wrap">
        <img id="avatar" class="avatar" src="" alt="avatar" onerror="this.src=''; this.style.background='#222'">
        <div>
          <div class="row">
            <button class="avatar-btn" type="button" onclick="pickAvatar()" id="t_change_photo">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</button>
            <input id="fileAvatar" type="file" accept="image/*" style="display:none" />
          </div>
          <div class="mut" style="font-size:12px" id="t_photo_hint">ÙŠÙÙØ¶Ù‘Ù„ ØµÙˆØ±Ø© Ù…Ø±Ø¨Ø¹Ø© Ø£Ù‚Ù„ Ù…Ù† 1MB.</div>
        </div>
      </div>

      <div class="grid">
        <div><label id="t_pf_first">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</label><input id="pfFirst"></div>
        <div><label id="t_pf_last">Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</label><input id="pfLast"></div>
        <div><label id="t_pf_email">Ø§Ù„Ø¨Ø±ÙŠØ¯</label><input id="pfEmail" disabled></div>
        <div><label id="t_pf_phone">Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label><input id="pfPhone"></div>
        <div><label id="t_pf_batch">Ø§Ù„Ø¯ÙØ¹Ø©</label><input id="pfBatch"></div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btnSaveProfile" type="button" onclick="saveProfile()"><span id="t_save_profile">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù</span></button>
      </div>
    </div>
  </section>
</main>

<!-- Drawer -->
<div id="drawerBackdrop" class="drawer-backdrop" onclick="closeDrawer()"></div>
<aside id="drawer" class="drawer" aria-hidden="true">
  <div class="drawer-header">
    <strong id="t_settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</strong>
    <button class="warn" type="button" onclick="logout()" id="t_logout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
  <div class="sep"></div>
  <div class="row" style="margin-bottom:10px">
    <div style="flex:1">
      <label id="t_theme">Ø§Ù„Ø«ÙŠÙ…</label>
      <button class="google" type="button" style="width:100%" onclick="toggleTheme()" id="t_toggle_theme">ØªØ¨Ø¯ÙŠÙ„ Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ ğŸŒ™/â˜€ï¸</button>
    </div>
  </div>
  <div class="grid">
    <div><label id="t_lang3_lbl">Ø§Ù„Ù„ØºØ©</label><select id="langSelSettings" style="width:100%" onchange="setLang(this.value)"><option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="en">English</option></select></div>
    <div><label id="t_font_lbl">Ø§Ù„Ø®Ø·</label><select id="fontSel" style="width:100%" onchange="setFont(this.value)"><option value="cairo">Cairo (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option><option value="noto">Noto Naskh Arabic</option><option value="inter">Inter</option></select></div>
    <div><label id="t_fs_lbl">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</label><select id="fsSel" style="width:100%" onchange="setFs(this.value)"><option value="15">ØµØºÙŠØ±</option><option value="16" selected>Ø¹Ø§Ø¯ÙŠ</option><option value="18">ÙƒØ¨ÙŠØ±</option><option value="20">Ø£ÙƒØ¨Ø±</option></select></div>
  </div>
  <div class="sep"></div>
  <p class="mut" style="font-size:12px" id="t_logo_hint">* Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø´Ø¹Ø§Ø± Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ù„ÙØªØ­ Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙˆØ­Ø© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.</p>
</aside>

<!-- Forgot Modal -->
<div id="forgotBack" class="drawer-backdrop" style="z-index:80"></div>
<aside id="forgot" class="drawer" style="z-index:90;width:min(90vw,420px)">
  <div class="drawer-header">
    <strong id="t_forgot_title">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</strong>
    <button class="warn" type="button" onclick="closeForgot()" id="t_close">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <div class="sep"></div>
  <div class="grid">
    <div class="field"><label id="t_f_email">Ø§Ù„Ø¨Ø±ÙŠØ¯</label><input id="fgEmail" type="email" placeholder="you@example.com"></div>
    <div class="field"><label id="t_f_phone">Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label><input id="fgPhone" inputmode="tel" placeholder="Ù…Ø«Ø§Ù„: 01xxxxxxxxx"></div>
    <div class="field"><label id="t_f_batch">Ø§Ù„Ø¯ÙØ¹Ø©</label><input id="fgBatch" inputmode="numeric" placeholder="12"></div>
  </div>
  <div class="row" style="margin-top:12px">
    <button type="button" onclick="doRecovery()" id="t_send_reset">ØªØ­Ù‚Ù‚ Ø«Ù… Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†</button>
  </div>
  <p class="mut" style="margin-top:10px" id="t_f_note">Ù„Ù† Ù†Ø¹Ø±Ø¶ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø£Ø¨Ø¯Ù‹Ø§Ø› Ø³Ù†Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.</p>
</aside>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

<script>
/* ================= Firebase ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDfiO-4J0DIHSKZo_vdBXeS343eJ0x4pYo",
  authDomain: "ittihad-med-kfs.firebaseapp.com",
  projectId: "ittihad-med-kfs",
  appId: "1:323302922960:web:3343605d75d2a5147cdcd5",
  storageBucket: "ittihad-med-kfs.appspot.com"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
const st   = firebase.storage();

/* ================= I18N ================= */
const I18N = {
  ar:{
    site:"Ø§ØªØ­Ø§Ø¯ Ø·Ø¨ Ø¨Ø´Ø±ÙŠ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®", header:"Ø§ØªØ­Ø§Ø¯ Ø·Ø¨ Ø¨Ø´Ø±ÙŠ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®",
    login_title:"ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", email:"Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", pass:"ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±", lang:"Ø§Ù„Ù„ØºØ©",
    btn_email_login:"Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯", btn_google_login:"Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google",
    to_signup:"Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯", forgot:"Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ", mail_note:"* ÙŠÙ„Ø²Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø­ÙŠØ§Ù†.",
    signup_title:"Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨", first:"Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„", last:"Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©", phone:"Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„", batch:"Ø§Ù„Ø¯ÙØ¹Ø©",
    pass2:"ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±", pass3:"ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±", btn_signup_email:"Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯", btn_signup_google:"Ø¥Ù†Ø´Ø§Ø¡/Ø¥ÙƒÙ…Ø§Ù„ Ø¨Ø­Ø³Ø§Ø¨ Google", back_login:"Ø±Ø¬ÙˆØ¹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
    tab_home:"Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", tab_profile:"Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ", welcome:"Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ", status:"Ø§Ù„Ø­Ø§Ù„Ø©:", role:"Ø§Ù„Ø¯ÙˆØ±:", home_note:"Ù†Ø³Ø®Ø© Ø£ÙˆÙ„ÙŠØ© â€” Ø¨Ø¹Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‡Ù†Ø¶ÙŠÙ Ø§Ù„Ø¨ÙˆØ³ØªØ§ØªØŒ Ø­Ø¶ÙˆØ± QRâ€¦ Ø¥Ù„Ø®.",
    profile_title:"Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ", pf_first:"Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„", pf_last:"Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©", pf_email:"Ø§Ù„Ø¨Ø±ÙŠØ¯", pf_phone:"Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„", pf_batch:"Ø§Ù„Ø¯ÙØ¹Ø©", save_profile:"Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù",
    change_photo:"ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©", photo_hint:"ÙŠÙÙØ¶Ù‘Ù„ ØµÙˆØ±Ø© Ù…Ø±Ø¨Ø¹Ø© Ø£Ù‚Ù„ Ù…Ù† 1MB.",
    settings:"Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", logout:"ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬", theme:"Ø§Ù„Ø«ÙŠÙ…", toggle_theme:"ØªØ¨Ø¯ÙŠÙ„ Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ ğŸŒ™/â˜€ï¸", logo_hint:"* Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø´Ø¹Ø§Ø± Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ù„ÙØªØ­ Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙˆØ­Ø© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.",
    forgot_title:"Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨", close:"Ø¥ØºÙ„Ø§Ù‚", f_email:"Ø§Ù„Ø¨Ø±ÙŠØ¯", f_phone:"Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„", f_batch:"Ø§Ù„Ø¯ÙØ¹Ø©", send_reset:"ØªØ­Ù‚Ù‚ Ø«Ù… Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†", f_note:"Ù„Ù† Ù†Ø¹Ø±Ø¶ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø£Ø¨Ø¯Ù‹Ø§Ø› Ø³Ù†Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ."
  },
  en:{
    site:"Kafr Elâ€‘Sheikh Med Students Union", header:"Kafr Elâ€‘Sheikh Med Students Union",
    login_title:"Sign in", email:"Email", pass:"Password", lang:"Language",
    btn_email_login:"Sign in with Email", btn_google_login:"Sign in with Google",
    to_signup:"Create new account", forgot:"Forgot password?", mail_note:"* Email permission may be required sometimes.",
    signup_title:"Create account", first:"First name", last:"Last name", phone:"Mobile", batch:"Batch",
    pass2:"Password", pass3:"Confirm password", btn_signup_email:"Create with Email", btn_signup_google:"Continue with Google", back_login:"Back to Login",
    tab_home:"Home", tab_profile:"Profile", welcome:"Welcome,", status:"Status:", role:"Role:", home_note:"Early preview â€” posts, QR attendance, etc. coming soon.",
    profile_title:"Profile", pf_first:"First name", pf_last:"Last name", pf_email:"Email", pf_phone:"Mobile", pf_batch:"Batch", save_profile:"Save profile",
    change_photo:"Change Photo", photo_hint:"Square image under 1MB is preferred.",
    settings:"Settings", logout:"Sign out", theme:"Theme", toggle_theme:"Toggle Dark/Light ğŸŒ™/â˜€ï¸", logo_hint:"* Tap the logo to open this panel after signing in.",
    forgot_title:"Account recovery", close:"Close", f_email:"Email", f_phone:"Mobile", f_batch:"Batch", send_reset:"Verify & send reset link", f_note:"We never show your password; we send a reset link after verifying your data."
  }
};
function applyI18n(locale){
  const t=I18N[locale]||I18N.ar;
  const M = (id, key) => { const el=document.getElementById(id); if(el) el.textContent=t[key]; };
  document.title = t.site;
  M('t_site','site'); M('t_header','header');
  M('t_login_title','login_title'); M('t_email_lbl','email'); M('t_pass_lbl','pass'); M('t_lang_lbl','lang');
  M('t_btn_email_login','btn_email_login'); M('t_btn_google_login','btn_google_login');
  M('t_to_signup','to_signup'); M('t_forgot','forgot'); M('t_mail_note','mail_note');
  M('t_signup_title','signup_title'); M('t_first_lbl','first'); M('t_last_lbl','last'); M('t_email2_lbl','email'); M('t_phone_lbl','phone'); M('t_batch_lbl','batch');
  M('t_lang2_lbl','lang'); M('t_pass2_lbl','pass2'); M('t_pass3_lbl','pass3'); M('t_btn_signup_email','btn_signup_email'); M('t_btn_signup_google','btn_signup_google'); M('t_back_login','back_login');
  M('t_tab_home','tab_home'); M('t_tab_profile','tab_profile'); M('t_welcome','welcome'); M('t_status','status'); M('t_role','role'); M('t_home_note','home_note');
  M('t_profile_title','profile_title'); M('t_pf_first','pf_first'); M('t_pf_last','pf_last'); M('t_pf_email','pf_email'); M('t_pf_phone','pf_phone'); M('t_pf_batch','pf_batch'); M('t_save_profile','save_profile');
  M('t_change_photo','change_photo'); M('t_photo_hint','photo_hint');
  M('t_settings','settings'); M('t_logout','logout'); M('t_theme','theme'); M('t_toggle_theme','toggle_theme'); M('t_lang3_lbl','lang'); M('t_font_lbl','lang'); M('t_fs_lbl','lang'); M('t_logo_hint','logo_hint');
  M('t_forgot_title','forgot_title'); M('t_close','close'); M('t_f_email','f_email'); M('t_f_phone','f_phone'); M('t_f_batch','f_batch'); M('t_send_reset','send_reset'); M('t_f_note','f_note');
}

/* ================= Utils & Prefs ================= */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const val = el => (el?.value || "").trim();
const setV = (el,v)=>{ if(el) el.value = (v ?? ''); const OWNER_EMAILS = ["dr.emara10@gmail.com"];
let userListenerUnsubscribe = null;

function toast(msg,err=false){
  const a=$('#globalAlert'); if(!a) return;
  a.textContent = msg || '';
  a.style.display = msg ? 'block' : 'none';
  a.classList.toggle('show', !!msg);
  a.style.background = err
    ? 'linear-gradient(180deg,rgba(239,68,68,.20),rgba(239,68,68,.10))'
    : 'linear-gradient(180deg,rgba(34,197,94,.20),rgba(34,197,94,.10))';
}
function showView(id){ $$('.view').forEach(v=>v.classList.remove('active')); $('#'+id).classList.add('active'); }
function switchTab(el){ $$('.tab').forEach(t=>t.classList.toggle('active',t===el)); showView(el.dataset.view); }
function togglePass(id){ const f=$('#'+id); if(f) f.type = f.type==='password'?'text':'password'; }

function setLang(l){
  localStorage.setItem('lang',l);
  document.documentElement.lang=l; document.documentElement.dir=(l==='ar'?'rtl':'ltr');
  ['#langSelAuth','#langSelSignup','#langSelSettings'].forEach(s=>{ const e=$(s); if(e) e.value=l; });
  applyI18n(l);
}
function setFont(f){ localStorage.setItem('font',f); document.body.classList.remove('ff-noto','ff-inter'); if(f==='noto') document.body.classList.add('ff-noto'); if(f==='inter') document.body.classList.add('ff-inter'); }
function setFs(sz){ localStorage.setItem('fs',sz); document.documentElement.style.setProperty('--fs',(sz||16)+'px'); }
function toggleTheme(){ const light=document.documentElement.classList.toggle('light'); localStorage.setItem('theme', light?'light':'dark'); }

// boot prefs
(function(){
  setLang(localStorage.getItem('lang')||'ar');
  setFont(localStorage.getItem('font')||'cairo');
  setFs(localStorage.getItem('fs')||'16');
  if((localStorage.getItem('theme')||'dark')==='light') document.documentElement.classList.add('light');
})();

/* ================= Drawer (Logo opens only if signed) ================= */
const drawer = $('#drawer'), backdrop = $('#drawerBackdrop');
$('#btnOpenSettings')?.addEventListener('click',()=>{
  if(!auth.currentUser){ toast(I18N[localStorage.getItem('lang')||'ar'].to_signup + ' / ' + I18N[localStorage.getItem('lang')||'ar'].login_title, true); return; }
  backdrop.style.display='block'; requestAnimationFrame(()=>drawer.classList.add('open'));
});
function closeDrawer(){ drawer.classList.remove('open'); backdrop.style.display='none'; }

/* ================= Validation ================= */
const okEmail = e => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e||'');
const min = (s,n)=> (s||'').trim().length>=n;
const mark = (el,ok)=>{ if(!el) return ok; el.classList.toggle('error',!ok); return ok; };

/* ================= Firestore UserDoc & PublicProfile ================= */
async function writeUserDoc(u,data){
  const role = OWNER_EMAILS.includes((u.email||'').toLowerCase()) ? 'owner' : (data.role || 'member');
  const first=data.first||'', last=data.last||'';
  const displayName=`${first} ${last}`.trim() || u.displayName || '';

  await db.collection('users').doc(u.uid).set({
    uid:u.uid, email:u.email||'', emailLower:(u.email||'').toLowerCase(),
    first, last, displayName, phone:data.phone||'', batch:data.batch||'',
    photoURL:data.photoURL||u.photoURL||'', role,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});

  // publicProfiles: ÙÙ‚Ø· Ø¢Ø®Ø± Ø±Ù‚Ù…ÙŠÙ† Ù…Ù† Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ + Ø§Ù„Ø¯ÙØ¹Ø© â€” Ù„Ù„ØªØ±Ù…ÙŠÙ…
  const phoneLast2 = (data.phone||'').slice(-2);
  await db.collection('publicProfiles').doc((u.email||'').toLowerCase()).set({
    emailLower:(u.email||'').toLowerCase(), batch:data.batch||'', phoneLast2: phoneLast2||'',
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});

  return role;
}
async function loadUserDoc(uid){ const s=await db.collection('users').doc(uid).get(); return s.exists?s.data():null; }
async function determineUserRole(user, doc){
  if(doc?.role) return doc.role;
  if(OWNER_EMAILS.includes((user.email||'').toLowerCase())){
    await db.collection('users').doc(user.uid).set({ role:'owner' },{merge:true});
    return 'owner';
  }
  return 'member';
}

/* ================= Auth State ================= */
let loadingToastTimer=null;
const showLoading = (v)=>{ clearTimeout(loadingToastTimer); if(v){ loadingToastTimer=setTimeout(()=>toast('... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ'),200);} else { toast(''); } };

auth.onAuthStateChanged(async user=>{
  try{
    if(userListenerUnsubscribe){ userListenerUnsubscribe(); userListenerUnsubscribe=null; }

    if(user){
      showLoading(true);
      const doc = await loadUserDoc(user.uid);
      const role = await determineUserRole(user, doc);

      // ping Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙ‚Ø·
      try{ await db.collection('ping').doc('hello').set({t:Date.now()},{merge:true}); }catch(e){ console.warn('ping fail',e); }

      await afterLogin(user, role);
      showLoading(false);
    }else{
      afterLogout();
    }
  }catch(err){
    console.error('Auth state error:', err);
    showLoading(false);
    toast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', true);
    afterLogout();
  }
});

/* ================= Post-Login / Logout ================= */
async function afterLogin(user,role){
  $('#tabs').style.display='';
  $('#roleBadge').textContent = role==='owner'?'Owner ğŸ‘‘':'Member';
  $('#badAuth').textContent = user.email || user.uid;
  $('#badRole').textContent = role==='owner'?'Owner ğŸ‘‘':'Member';
  setV($('#pfEmail'), user.email || '');
  $('#helloName').textContent = user.displayName || 'Ø¹Ø¶Ùˆ';

  // snapshot
  userListenerUnsubscribe = db.collection('users').doc(user.uid).onSnapshot(
    s=>{
      const d=s.data()||{};
      setV($('#pfFirst'),d.first||'');
      setV($('#pfLast'),d.last||'');
      setV($('#pfPhone'),d.phone||'');
      setV($('#pfBatch'),d.batch||'');
      const url=d.photoURL||'';
      $('#avatar').src=url||'';
      $('#helloName').textContent = d.displayName || user.displayName || 'Ø¹Ø¶Ùˆ';
    },
    e=>{ console.error('User doc snapshot error:', e); toast('ØªØ¹Ø°Ù‘Ø± Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ.', true); }
  );
  showView('homeView');
}
function afterLogout(){
  $('#tabs').style.display='none';
  $('#roleBadge').textContent='ØºÙŠØ± Ù…Ø³Ø¬Ù„';
  showView('authView');
  setV($('#inEmail'),''); setV($('#inPass'),'');
  $('#avatar').src='';
}

/* ================= Actions ================= */
async function emailLogin(){
  const email=val($('#inEmail')), pass=val($('#inPass'));
  if(!okEmail(email)) { mark($('#inEmail'),false); return toast('Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± ØµØ§Ù„Ø­.',true); }
  $('#btnEmailLogin').disabled=true;
  try{ await auth.signInWithEmailAndPassword(email,pass); }
  catch(e){
    const c=e.code||'';
    if(c.includes('invalid-credential')||c.includes('wrong-password')){
      mark($('#inPass'),false); toast('Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.',true);
    }else toast('ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: '+(e.message||e),true);
  }finally{ $('#btnEmailLogin').disabled=false; }
}
const googleProvider=new firebase.auth.GoogleAuthProvider();
async function googleLogin(){
  $('#btnGoogleLogin').disabled=true;
  try{
    let cred;
    try { cred=await auth.signInWithPopup(googleProvider); }
    catch(e){ if((e.code||'').includes('popup-blocked')) cred=await auth.signInWithRedirect(googleProvider); else throw e; }
    if(!cred?.user){ toast('Ø£ÙƒÙ…Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù…Ù† Google.'); return; }
  }catch(e){ toast('Ø¥Ù„ØºØ§Ø¡/Ø®Ø·Ø£ Google: '+(e.message||e),true); }
  finally{ $('#btnGoogleLogin').disabled=false; }
}

async function signup(){
  const first=val($('#suFirst')), last=val($('#suLast'));
  const email=val($('#suEmail')), phone=val($('#suPhone'));
  const batch=val($('#suBatch')), pass=val($('#suPass')), pass2=val($('#suPass2'));
  const ok=[
    mark($('#suFirst'),min(first,2)), mark($('#suLast'),min(last,2)),
    mark($('#suEmail'),okEmail(email)), mark($('#suPhone'),min(phone,7)),
    mark($('#suBatch'),min(batch,1)), mark($('#suPass'),min(pass,8)),
    mark($('#suPass2'),pass===pass2)
  ].every(Boolean);
  if(!ok) return toast('Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø­Ù…Ø±Ø§Ø¡.',true);
  $('#btnSignup').disabled=true;
  try{
    const cred=await auth.createUserWithEmailAndPassword(email,pass);
    await writeUserDoc(cred.user,{first,last,phone,batch});
    setLang($('#langSelSignup').value);
    toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ…');
  }catch(e){ toast('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: '+(e.message||e),true); }
  finally{ $('#btnSignup').disabled=false; }
}

async function googleSignup(){
  $('#btnGoogleSignup').disabled=true;
  try{
    let cred;
    try { cred=await auth.signInWithPopup(googleProvider); }
    catch(e){ if((e.code||'').includes('popup-blocked')) cred=await auth.signInWithRedirect(googleProvider); else throw e; }
    if(!cred?.user){ toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù…Ù† Google.'); return; }
    const doc=await loadUserDoc(cred.user.uid);
    if(!doc){
      const parts=(cred.user.displayName||'').split(' ');
      setV($('#suEmail'),cred.user.email||'');
      setV($('#suFirst'),parts[0]||''); setV($('#suLast'),parts.slice(1).join(' ')||'');
      showView('signupView'); toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯".');
    }
  }catch(e){ toast('Ø¥Ù„ØºØ§Ø¡/Ø®Ø·Ø£ Google: '+(e.message||e),true); }
  finally{ $('#btnGoogleSignup').disabled=false; }
}

async function saveProfile(){
  const u=auth.currentUser; if(!u) return;
  const first=val($('#pfFirst')), last=val($('#pfLast'));
  const phone=val($('#pfPhone')), batch=val($('#pfBatch'));
  const currentPhoto=$('#avatar').src||'';
  if(!min(first,1)||!min(last,1)) return toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø§Ø³Ù….',true);
  try{
    const role=await writeUserDoc(u,{first,last,phone,batch,photoURL:currentPhoto});
    $('#roleBadge').textContent = role==='owner'?'Owner ğŸ‘‘':'Member';
    $('#helloName').textContent = `${first} ${last}`.trim() || 'Ø¹Ø¶Ùˆ';
    toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù âœ…');
  }catch(e){ toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸: '+(e.message||e),true); }
}async function logout(){
  try{
    if(userListenerUnsubscribe){ userListenerUnsubscribe(); userListenerUnsubscribe=null; }
    await auth.signOut();
    toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
  }catch(e){ toast('ØªØ¹Ø°Ù‘Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: '+(e.message||e),true); }
  finally{ closeDrawer(); afterLogout(); }
}

/* ================= Avatar upload (Storage) ================= */
function pickAvatar(){ if(!auth.currentUser){ return toast('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§.',true); } $('#fileAvatar').click(); }
$('#fileAvatar').addEventListener('change', async (ev)=>{
  const file=ev.target.files?.[0]; if(!file) return;
  if(file.size>1_000_000) return toast('Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± (>1MB).',true);
  if(!file.type.startsWith('image/')) return toast('Ø§Ø®ØªØ± ØµÙˆØ±Ø©.',true);
  try{
    const uid=auth.currentUser.uid;
    const ref = st.ref().child(`users/${uid}/avatar.jpg`);
    await ref.put(file);
    const url = await ref.getDownloadURL();
    $('#avatar').src=url;
    await db.collection('users').doc(uid).set({ photoURL:url, updatedAt:firebase.firestore.FieldValue.serverTimestamp() },{merge:true});
    toast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© âœ…');
  }catch(e){ toast('ØªØ¹Ø°Ù‘Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: '+(e.message||e),true); }
});

/* ================= Forgot: verify (email+phone last2 + batch) then send reset ================= */
function openForgot(){ $('#forgotBack').style.display='block'; $('#forgot').classList.add('open'); }
function closeForgot(){ $('#forgot').classList.remove('open'); $('#forgotBack').style.display='none'; }

async function doRecovery(){
  const email = val($('#fgEmail')).toLowerCase();
  const phone = val($('#fgPhone'));
  const batch = val($('#fgBatch'));
  if(!okEmail(email) || !min(phone,7) || !min(batch,1)) return toast('Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©.',true);

  try{
    const snap = await db.collection('publicProfiles').doc(email).get();
    if(!snap.exists){ return toast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯.', true); }
    const d = snap.data()||{};
    const p2=(phone||'').slice(-2);
    if((d.phoneLast2||'')===p2 && (d.batch||'')===batch){
      await auth.sendPasswordResetEmail(email);
      toast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.');
      closeForgot();
    }else{
      toast('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚Ø©.', true);
    }
  }catch(e){ toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ­Ù‚Ù‚: '+(e.message||e), true); }
}
</script>
</body>
</html>
