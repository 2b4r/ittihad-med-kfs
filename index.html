<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>اتحاد طب بشري كفر الشيخ</title>
<meta name="theme-color" content="#0b1220"/>

<style>
:root{
  --bg:#0b1220; --bg2:#0e1426; --card:#10192f; --ink:#e8eefc; --mut:#97a2b8; --bor:#1e2a44;
  --acc:#22c55e; --acc2:#f59e0b; --danger:#ef4444; --ok:#10b981; --ring:rgba(34,197,94,.25);
  --radius:16px; --rsm:10px; --pad:14px; --gap:12px;
}
:root.light{
  --bg:#f6f8ff; --bg2:#ffffff; --card:#ffffff; --ink:#0f172a; --mut:#5b6580; --bor:#e3e8f5;
  --acc:#16a34a; --ring:rgba(22,163,74,.25);
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; font:15.5px/1.75 ui-rounded,system-ui,Segoe UI,Arial;
  color:var(--ink); background:linear-gradient(160deg,var(--bg),var(--bg2)) fixed;
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
}
.wrap{max-width:980px;margin:0 auto;padding:18px}
.top{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  position:sticky; top:0; z-index:50; padding:10px 16px;
  background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,0));
  backdrop-filter:blur(8px); border-bottom:1px solid var(--bor)
}
.brand{display:flex; align-items:center; gap:12px}
.brand img{height:38px; width:38px; object-fit:contain; filter:drop-shadow(0 0 10px rgba(0,0,0,.4))}
.title{font-weight:800; letter-spacing:.2px}
.badge{border:1px solid var(--bor); color:var(--mut); background:rgba(255,255,255,.04);
  padding:6px 12px; border-radius:999px; font-size:12px}
.btn{cursor:pointer; border:1px solid var(--bor); border-radius:12px; padding:10px 14px;
  color:#fff; background:linear-gradient(135deg,rgba(34,197,94,.22),rgba(245,158,11,.18));
  box-shadow:0 8px 22px rgba(0,0,0,.18); transition:.14s}
.btn:hover{filter:brightness(1.06)} .btn:active{transform:translateY(1px)}
.btn.ghost{background:rgba(255,255,255,.04); color:var(--ink)}
.btn.danger{background:linear-gradient(135deg,rgba(239,68,68,.25),rgba(239,68,68,.15))}
.link{color:#fff; text-decoration:none; border-bottom:1px dashed #fff4}
.link.muted{color:var(--mut); border-color:transparent}
.card{
  background:var(--card); border:1px solid var(--bor); border-radius:var(--radius);
  padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.04)
}
.grid{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap)}
@media(max-width:760px){.grid{grid-template-columns:1fr}}
input,select,button,textarea{
  outline:none; border:1px solid var(--bor); border-radius:12px; padding:12px 14px;
  background:#0d172c; color:var(--ink); transition:.18s
}
:root.light input,:root.light select,:root.light textarea{background:#f7f9ff}
input:focus,select:focus,textarea:focus{box-shadow:0 0 0 4px var(--ring); border-color:color-mix(in srgb,var(--acc) 55%, transparent)}
.field{margin-bottom:12px}
.field label{display:block; margin-bottom:6px; color:var(--mut)}
.row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.right{margin-inline-start:auto}
.center{text-align:center}
.err{color:#fecaca; background:#7f1d1d; border:1px solid #dc2626; padding:10px 12px; border-radius:12px; display:none}
.ok{color:#d1fae5; background:#064e3b; border:1px solid #10b981; padding:10px 12px; border-radius:12px; display:none}
.show{display:block}
.eye{position:absolute; inset-inline-start:-36px; top:50%; transform:translateY(-50%); cursor:pointer; opacity:.7}
.sep{height:1px; background:var(--bor); margin:12px 0; border-radius:999px}
.tabs{display:flex; gap:8px; border-bottom:1px solid var(--bor); margin-bottom:14px}
.tab{background:transparent; border:1px solid var(--bor); padding:8px 12px; color:var(--mut); border-radius:10px 10px 0 0; cursor:pointer}
.tab.active{background:#0d172c; color:#fff; border-bottom-color:#0d172c}
.view{display:none} .view.active{display:block}
.footerNote{color:var(--mut); font-size:12px}
.small{font-size:12.5px; color:var(--mut)}
.linkbar a{color:#fff; text-decoration:none; margin-inline:8px; border-bottom:1px dashed #fff4}
</style>
</head>
<body>

<!-- ================== Header ================== -->
<header class="top">
  <div class="brand">
    <img src="logo.png" alt="شعار" onerror="this.style.display='none'"/>
    <div class="title">اتحاد طب بشري كفر الشيخ</div>
  </div>
  <div class="row">
    <span id="authBadge" class="badge">غير مسجل</span>
    <button id="btnTheme" class="btn ghost">تبديل ليلي/نهاري</button>
  </div>
</header>

<div class="wrap">

  <!-- =============== LOGIN VIEW =============== -->
  <section id="viewLogin" class="view active">
    <div class="card">
      <h2 class="center">تسجيل الدخول</h2>

      <div id="loginErr" class="err"></div>
      <div id="loginOk"  class="ok"></div>

      <div class="grid" style="position:relative">
        <div class="field">
          <label>البريد الإلكتروني</label>
          <input id="inEmail" type="email" placeholder="you@example.com" autocomplete="email">
        </div>
        <div class="field" style="position:relative">
          <label>كلمة السر</label>
          <span class="eye" id="eyeLogin">👁️</span>
          <input id="inPass" type="password" placeholder="•••••••" autocomplete="current-password">
        </div>
      </div>

      <div class="grid">
        <div class="field">
          <label>اللغة</label>
          <select id="loginLang">
            <option value="ar">العربية</option>
            <option value="en">English</option>
            <option value="es">Español</option>
            <option value="fr">Français</option>
            <option value="de">Deutsch</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnLogin" class="btn">دخول بالبريد</button>
        <button id="btnGoogle" class="btn">دخول بحساب Google</button>
        <div class="right linkbar">
          <a id="linkSignup" href="#">إنشاء حساب جديد</a>
          <a id="linkForgot" href="#">نسيت كلمة السر؟</a>
        </div>
      </div>

      <p class="footerNote" style="margin-top:10px">* يلزم الموافقة على البريد في بعض الأحيان.</p>
    </div>
  </section>

  <!-- =============== SIGNUP VIEW =============== -->
  <section id="viewSignup" class="view">
    <div class="card">
      <h2 class="center">إنشاء حساب</h2>

      <div id="signupErr" class="err"></div>
      <div id="signupOk"  class="ok"></div>

      <div class="grid">
        <div class="field">
          <label>الاسم (الاسم + العائلة)</label>
          <input id="suName" placeholder="مثال: أحمد علي">
        </div>
        <div class="field">
          <label>رقم الموبايل</label>
          <input id="suPhone" inputmode="numeric" pattern="[0-9]*" placeholder="أرقام فقط">
        </div>
      </div>

      <div class="grid">
        <div class="field">
          <label>الدفعة</label>
          <input id="suBatch" type="number" min="1" max="200" placeholder="مثال: 72">
        </div>
        <div class="field">
          <label>البريد الإلكتروني</label>
          <input id="suEmail" type="email" placeholder="you@example.com" autocomplete="email">
        </div>
      </div>

      <div class="grid" style="position:relative">
        <div class="field" style="position:relative">
          <label>كلمة السر</label>
          <span class="eye" id="eyeSu1">👁️</span>
          <input id="suPass" type="password" placeholder="•••••••" autocomplete="new-password">
        </div>
        <div class="field" style="position:relative">
          <label>تأكيد كلمة السر</label>
          <span class="eye" id="eyeSu2">👁️</span>
          <input id="suPass2" type="password" placeholder="إعادة الإدخال" autocomplete="new-password">
        </div>
      </div>

      <div class="grid">
        <div class="field">
          <label>اللغة</label>
          <select id="signupLang">
            <option value="ar">العربية</option>
            <option value="en">English</option>
            <option value="es">Español</option>
            <option value="fr">Français</option>
            <option value="de">Deutsch</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnSignup" class="btn">إنشاء الحساب</button>
        <a id="linkBackLogin" class="link right" href="#">رجوع لتسجيل الدخول</a>
      </div>
    </div>
  </section>

  <!-- =============== APP (AFTER LOGIN) =============== -->
  <section id="viewApp" class="view">
    <div class="card">
      <div class="row">
        <div class="title">مرحبًا <span id="helloName">—</span></div>
        <div class="right">
          <span id="roleBadge" class="badge">Member</span>
          <button id="btnLogout" class="btn danger">تسجيل الخروج</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="tabs">
        <button class="tab active" data-tab="homeTab">الرئيسية</button>
        <button class="tab" data-tab="profileTab">الملف الشخصي</button>
        <button class="tab" data-tab="settingsTab">الإعدادات</button>
      </div>

      <div id="homeTab" class="tabview">
        <p>نسخة أولية — بعد تفعيل الصلاحيات هنضيف البوستات، حضور QR… إلخ.</p>
      </div>

      <div id="profileTab" class="tabview" style="display:none">
        <div class="grid">
          <div class="field">
            <label>الاسم</label>
            <input id="pfName">
          </div>
          <div class="field">
            <label>البريد</label>
            <input id="pfEmail" disabled>
          </div>
          <div class="field">
            <label>الموبايل</label>
            <input id="pfPhone">
          </div>
          <div class="field">
            <label>الدفعة</label>
            <input id="pfBatch" type="number" min="1" max="200">
          </div>
          <div class="field">
            <label>صورة البروفايل (URL اختيارية)</label>
            <input id="pfPhoto" placeholder="https://…">
          </div>
        </div>
        <div class="row">
          <button id="btnSaveProfile" class="btn">حفظ الملف</button>
        </div>
      </div>

      <div id="settingsTab" class="tabview" style="display:none">
        <div class="grid">
          <div class="field">
            <label>الوضع</label><br/>
            <button id="btnTheme2" class="btn ghost">تبديل ليلي/نهاري</button>
          </div>
          <div class="field">
            <label>اللغة</label>
            <select id="appLang">
              <option value="ar">العربية</option>
              <option value="en">English</option>
              <option value="es">Español</option>
              <option value="fr">Français</option>
              <option value="de">Deutsch</option>
            </select>
          </div>
        </div>
        <p class="small">* سيتم تخزين التفضيلات محليًا على جهازك.</p>
      </div>
    </div>
  </section>

</div>

<!-- ================== Firebase (Compat) ================== -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics-compat.js"></script>

<script>
/* ========= Theme & Small helpers ========= */
(function(){
  const btn1=document.getElementById('btnTheme'), btn2=document.getElementById('btnTheme2');
  const apply=()=>{ document.documentElement.classList.toggle('light'); localStorage.setItem('theme', document.documentElement.classList.contains('light')?'light':'dark'); };
  const boot=localStorage.getItem('theme'); if(boot==='light') document.documentElement.classList.add('light');
  if(btn1) btn1.onclick=apply; if(btn2) btn2.onclick=apply;
})();
const $ = s=>document.querySelector(s);
const $$ = s=>[...document.querySelectorAll(s)];
function show(id){ $$('.view').forEach(v=>v.classList.remove('active')); $('#'+id).classList.add('active'); }
function toast(el,msg,ok=false){ if(!el) return; el.textContent=msg; el.classList.add('show'); if(ok){ el.classList.remove('err'); el.classList.add('ok'); } else { el.classList.remove('ok'); el.classList.add('err'); } setTimeout(()=>el.classList.remove('show'), 4500); }
function toggleEye(eye,input){ eye?.addEventListener('click',()=>{ input.type=(input.type==='password'?'text':'password'); }); }

/* ========= Language (basic wiring) ========= */
(function(){
  const loginLang=$('#loginLang'), signupLang=$('#signupLang'), appLang=$('#appLang');
  const set=(v)=>{ localStorage.setItem('lang', v); [loginLang,signupLang,appLang].forEach(s=>{ if(s) s.value=v; }); document.documentElement.lang=v; document.dir=(v==='ar'?'rtl':'ltr'); };
  const boot=localStorage.getItem('lang')||'ar'; set(boot);
  [loginLang,signupLang,appLang].forEach(s=> s && (s.onchange=()=>set(s.value)));
})();

/* ========= Firebase Config + Boot ========= */
const firebaseConfig = {
  apiKey: "AIzaSyDfiO-4J0DIHSKZo_vdBXeS343eJ0x4pYo",
  authDomain: "ittihad-med-kfs.firebaseapp.com",
  projectId: "ittihad-med-kfs",
  appId: "1:323302922960:web:3343605d75d2a5147cdcd5"
};
firebase.initializeApp(firebaseConfig);
try{ firebase.analytics(); }catch(e){}

/* ========= Globals ========= */
const auth=firebase.auth();
const db  =firebase.firestore();
const OWNER_EMAIL="dr.emara10@gmail.com".toLowerCase();

/* ========= UI Refs ========= */
const badge  = $('#authBadge');
const eyeLogin=$('#eyeLogin'), eyeSu1=$('#eyeSu1'), eyeSu2=$('#eyeSu2');
toggleEye(eyeLogin,$('#inPass')); toggleEye(eyeSu1,$('#suPass')); toggleEye(eyeSu2,$('#suPass2'));

$('#linkSignup').onclick=(e)=>{ e.preventDefault(); show('viewSignup'); };
$('#linkBackLogin').onclick=(e)=>{ e.preventDefault(); show('viewLogin'); };
$('#linkForgot').onclick= async (e)=>{
  e.preventDefault();
  const email=prompt('ادخل بريدك لإرسال رابط إعادة كلمة السر:');
  if(!email) return;
  try{ await auth.sendPasswordResetEmail(email); alert('تم إرسال رابط تغيير كلمة السر إلى بريدك.'); }
  catch(err){ alert('خطأ: '+(err.message||err)); }
};

/* ========= Signup ========= */
$('#btnSignup').onclick= async ()=>{
  const name = ($('#suName').value||'').trim();
  const phone= ($('#suPhone').value||'').replace(/\D/g,'');
  const batch= parseInt($('#suBatch').value||'0',10);
  const email= ($('#suEmail').value||'').trim();
  const pass = $('#suPass').value||'';
  const pass2= $('#suPass2').value||'';

  const err=$('#signupErr'), ok=$('#signupOk');

  if(name.length<5 || !name.includes(' ')) return toast(err,'اكتب الاسم كامل: اسم + عائلة (≥ 5 حروف)');
  if(phone.length<10 || phone.length>15)   return toast(err,'رقم الهاتف غير صالح (10–15 رقم).');
  if(!(batch>=1 && batch<=200))            return toast(err,'اكتب رقم دفعة صحيح (1–200).');
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return toast(err,'بريد إلكتروني غير صالح.');
  if(pass.length<6)                         return toast(err,'كلمة السر لا تقل عن 6 حروف.');
  if(pass!==pass2)                          return toast(err,'تأكيد كلمة السر غير مطابق.');

  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await cred.user.updateProfile({ displayName: name });
    // اكتب ملف المستخدم
    await db.collection('users').doc(cred.user.uid).set({
      uid: cred.user.uid,
      email: email.toLowerCase(),
      displayName: name,
      phone, batch,
      role: (email.toLowerCase()===OWNER_EMAIL?'owner':'member'),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
    toast(ok,'تم إنشاء الحساب بنجاح ✅',true);
    show('viewApp');
  }catch(e){
    toast(err, 'خطأ في تسجيل الحساب: ' + (e.code||e.message||e));
  }
};

/* ========= Login ========= */
$('#btnLogin').onclick= async ()=>{
  const email=($('#inEmail').value||'').trim();
  const pass =$('#inPass').value||'';
  const err=$('#loginErr'), ok=$('#loginOk');

  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return toast(err,'صيغة البريد غير صحيحة.');
  if(pass.length<6) return toast(err,'تحقق من كلمة السر.');

  try{
    const cred=await auth.signInWithEmailAndPassword(email,pass);
    toast(ok,'تم تسجيل الدخول ✅',true);
    show('viewApp');
  }catch(e){
    toast(err,'فشل تسجيل الدخول: ' + (e.code||e.message||e));
  }
};

/* ========= Google Sign-In ========= */
$('#btnGoogle').onclick= async ()=>{
  try{
    const provider=new firebase.auth.GoogleAuthProvider();
    const res=await auth.signInWithPopup(provider);
    const u=res.user;
    await db.collection('users').doc(u.uid).set({
      uid:u.uid, email:u.email.toLowerCase(), displayName:u.displayName||'', role:(u.email.toLowerCase()===OWNER_EMAIL?'owner':'member')
    },{merge:true});
    show('viewApp');
  }catch(e){
    toast($('#loginErr'),'Google Sign-In: '+(e.code||e.message||e));
  }
};

/* ========= Logout ========= */
$('#btnLogout').onclick=()=>auth.signOut();

/* ========= Tabs ========= */
$$('.tab').forEach(b=>{
  b.onclick=()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    $$('.tabview').forEach(x=>x.style.display='none');
    document.getElementById(b.dataset.tab).style.display='';
  };
});

/* ========= Profile Save ========= */
$('#btnSaveProfile').onclick= async ()=>{
  const u=auth.currentUser; if(!u) return alert('سجّل دخول أولاً');
  try{
    const name=($('#pfName').value||'').trim();
    const phone=($('#pfPhone').value||'').replace(/\D/g,'');
    const batch=parseInt($('#pfBatch').value||'0',10);
    const photo=($('#pfPhoto').value||'').trim();
    if(name.length<5 || !name.includes(' ')) return alert('اكتب الاسم كامل (اسم + عائلة).');
    await u.updateProfile({displayName:name, photoURL: photo||null});
    await db.collection('users').doc(u.uid).set({displayName:name, phone, batch, photoURL:photo||null},{merge:true});
    alert('تم حفظ الملف.');
  }catch(e){ alert('خطأ: '+(e.message||e)); }
};

/* ========= Auth State ========= */
auth.onAuthStateChanged(async (u)=>{
  if(!u){
    badge.textContent='غير مسجل';
    show('viewLogin');
    return;
  }
  // load user doc
  try{
    const doc=await db.collection('users').doc(u.uid).get();
    const role = (doc.exists && doc.data().role) ? doc.data().role : (u.email.toLowerCase()===OWNER_EMAIL?'owner':'member');
    $('#helloName').textContent = u.displayName || (doc.exists? (doc.data().displayName||'عضو'): 'عضو');
    $('#pfName').value  = u.displayName || (doc.exists? (doc.data().displayName||'') : '');
    $('#pfEmail').value = u.email||'';
    $('#pfPhone').value = doc.exists? (doc.data().phone||'') : '';
    $('#pfBatch').value = doc.exists? (doc.data().batch||'') : '';
    $('#pfPhoto').value = (u.photoURL|| (doc.exists? (doc.data().photoURL||'') : ''));

    badge.textContent = (role==='owner' ? 'Owner 👑' : 'عضو');
    $('#roleBadge').textContent = (role==='owner' ? 'Owner 👑' : 'Member');
    show('viewApp');
  }catch(e){
    badge.textContent='⚠️ Firestore';
    console.error(e);
  }
});

/* ========= Ping Firestore (Banner on rules error) ========= */
(async ()=>{
  try{
    await db.collection('ping').doc('hello').set({ t: Date.now() }, {merge:true});
  }catch(e){
    const b=document.createElement('div');
    b.className='err show';
    b.textContent='Firestore error: تأكد من القواعد (Rules) أو تفعيل المصادقة.';
    document.querySelector('.wrap').prepend(b);
  }
})();
</script>
</body>
         </html>
