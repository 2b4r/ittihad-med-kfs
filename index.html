<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø§ØªØ­Ø§Ø¯ Ø·Ø¨ Ø¨Ø´Ø±ÙŠ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&family=Inter:wght@400;600;800&family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg1:#0f1217; --bg2:#0b0d11; --card:rgba(255,255,255,.04);
  --txt:#eef1f4; --mut:#a6acb3; --bor:rgba(255,255,255,.10);
  --acc:#10b981; --warn:#ef4444; --ok:#22c55e;
  --ring:rgba(16,185,129,.34);
  --r-xl:18px; --r-lg:14px; --r-md:10px;
  --pad:16px; --gap:12px; --blur:10px;
  --fs:16px;
  --shadow:0 10px 28px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.05);
  --brand: #8ee3d3;
}
:root.light{
  --bg1:#f7f7f9; --bg2:#ffffff; --card:rgba(255,255,255,.96);
  --txt:#171a1f; --mut:#5e646b; --bor:rgba(0,0,0,.08);
  --ring:rgba(17,94,89,.20);
  --shadow:0 10px 24px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.9);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font: var(--fs)/1.7 "Cairo", system-ui, -apple-system, Segoe UI, Roboto;
  color:var(--txt);
  background:radial-gradient(1200px 600px at 10% -10%,rgba(59,130,246,.14),transparent),
             linear-gradient(160deg,var(--bg1),var(--bg2)) fixed;
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
}
body.ff-noto{font-family:"Noto Naskh Arabic", system-ui}
body.ff-inter{font-family:"Inter", system-ui}
a{color:#fff;text-decoration:underline 1px rgba(255,255,255,.35)}
a:hover{opacity:.9}

.topbar{
  position:sticky; top:0; z-index:30;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:10px 14px; border-bottom:1px solid var(--bor);
  background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.08));
  backdrop-filter:blur(var(--blur));
}
.brand{display:flex; align-items:center; gap:12px}
.logo{width:34px;height:34px; object-fit:contain; border-radius:50%;
  box-shadow:0 0 0 2px rgba(255,255,255,.08)}
.brand h1{font-size:18px; margin:0}
.role-badge{
  font-size:12px; color:var(--mut); border:1px solid var(--bor); padding:4px 10px;
  border-radius:999px; background:rgba(255,255,255,.05)
}
.container{max-width:980px; margin:0 auto; padding:18px}
.card{
  background:var(--card); border:1px solid var(--bor); border-radius:var(--r-xl);
  padding:var(--pad); box-shadow:var(--shadow); backdrop-filter:blur(var(--blur));
}
.grid{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap)}
@media(max-width:860px){ .grid{grid-template-columns:1fr} }
.row{display:flex; gap:var(--gap); flex-wrap:wrap; align-items:center}
.sep{height:1px; background:var(--bor); border-radius:999px; margin:10px 0}
.mut{color:var(--mut)}

input,select,button,textarea{
  border:1px solid var(--bor); border-radius:var(--r-lg);
  background:rgba(255,255,255,.04); color:var(--txt);
  padding:10px 12px; outline:none; transition:.15s;
}
input:focus,select:focus,textarea:focus{box-shadow:0 0 0 4px var(--ring)}
input.error{border-color:var(--warn); box-shadow:0 0 0 4px rgba(239,68,68,.20)}
label{display:block; margin:2px 2px 6px}
button{
  cursor:pointer; font-weight:700; border-radius:12px;
  background:linear-gradient(135deg,rgba(16,185,129,.95),rgba(245,158,11,.9));
  border:1px solid var(--bor); color:#fff; padding:10px 14px;
  box-shadow:0 10px 25px rgba(0,0,0,.18)
}
button.ghost{background:rgba(255,255,255,.06)}
button.warn{background:linear-gradient(135deg,#ef4444,#b91c1c)}
button.google{background:linear-gradient(135deg,#34a853,#0f9d58)}
button:disabled{opacity:.6; cursor:not-allowed}

.tabs{display:flex; gap:10px; border-bottom:1px dashed var(--bor); margin-bottom:12px}
.tab{padding:10px 14px; border-radius:12px 12px 0 0; cursor:pointer}
.tab.active{background:rgba(255,255,255,.06); box-shadow:var(--shadow)}

.view{display:none}
.view.active{display:block}

.alert{
  display:none; position:sticky; top:0; z-index:40; margin:12px auto 0;
  padding:12px 14px; border-radius:14px; border:1px solid rgba(239,68,68,.3);
  background:linear-gradient(180deg,rgba(239,68,68,.20),rgba(239,68,68,.10));
  color:#fee2e2
}
.alert.show{display:block}

.badge-mini{
  font-size:12px; padding:4px 8px; border:1px solid var(--bor);
  border-radius:999px; background:rgba(255,255,255,.05); color:var(--mut)
}

.field{position:relative}
.eye{
  position:absolute; left:10px; top:50%; transform:translateY(-50%);
  cursor:pointer; user-select:none; opacity:.75
}
.helper{font-size:12px; color:var(--mut); margin-top:6px}
.linklike{color:#fff; text-decoration:underline}
.center{display:flex; align-items:center; justify-content:center}
.right{display:flex; justify-content:flex-end}
</style>
</head>

<body>

<header class="topbar">
  <div class="brand">
    <img src="logo.png" alt="Ø´Ø¹Ø§Ø±" class="logo" onerror="this.style.display='none'">
    <h1>Ø§ØªØ­Ø§Ø¯ Ø·Ø¨ Ø¨Ø´Ø±ÙŠ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</h1>
  </div>
  <div class="role-badge" id="roleBadge">ØºÙŠØ± Ù…Ø³Ø¬Ù„</div>
</header>

<main class="container">
  <div id="globalAlert" class="alert"></div>

  <div id="tabs" class="tabs" style="display:none">
    <div class="tab active" data-view="homeView">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    <div class="tab" data-view="profileView">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
    <div class="tab" data-view="settingsView">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
  </div>

  <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <section id="authView" class="view active">
    <div class="card">
      <h2 style="margin-top:0">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>

      <div class="grid">
        <div class="field">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="inEmail" type="email" placeholder="you@example.com" autocomplete="email">
        </div>
        <div class="field">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <span class="eye" id="eyeIn">ğŸ‘ï¸</span>
          <input id="inPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <label>Ø§Ù„Ù„ØºØ©</label>
          <select id="langSelAuth">
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
            <option value="en">English</option>
          </select>
        </div>
        <div class="right">
          <button id="btnEmailLogin">Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnGoogleLogin" class="google">Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google</button>
      </div>

      <div class="row" style="margin-top:8px; gap:20px">
        <a class="linklike" id="toSignUp">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a>
        <a class="linklike" id="forgotLink">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</a>
      </div>

      <div class="helper">* ÙŠÙ„Ø²Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø­ÙŠØ§Ù†.</div>
    </div>
  </section>

  <!-- Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ -->
  <section id="signupView" class="view">
    <div class="card">
      <h2 style="margin-top:0">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
      <div class="grid">
        <div class="field">
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</label>
          <input id="suFirst" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…ÙˆØ¯">
        </div>
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</label>
          <input id="suLast" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù…Ø§Ø±Ø©">
        </div>
        <div class="field">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="suEmail" type="email" placeholder="you@example.com" autocomplete="email">
        </div>
        <div class="field">
          <label>Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
          <input id="suPhone" inputmode="tel" placeholder="01xxxxxxxxx">
        </div>
        <div class="field">
          <label>Ø§Ù„Ø¯ÙØ¹Ø©</label>
          <input id="suBatch" inputmode="numeric" placeholder="12">
        </div>
        <div class="field">
          <label>Ø§Ù„Ù„ØºØ©</label>
          <select id="langSelSignup">
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
            <option value="en">English</option>
          </select>
        </div>

        <div class="field">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <span class="eye" id="eyeUp">ğŸ‘ï¸</span>
          <input id="suPass" type="password" placeholder="8+ Ø­Ø±ÙˆÙ/Ø£Ø±Ù‚Ø§Ù…" autocomplete="new-password">
        </div>
        <div class="field">
          <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <input id="suPass2" type="password" placeholder="Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" autocomplete="new-password">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnSignup" style="min-width:180px">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
        <button id="btnGoogleSignup" class="google">Ø¥Ù†Ø´Ø§Ø¡/Ø¥ÙƒÙ…Ø§Ù„ Ø¨Ø­Ø³Ø§Ø¨ Google</button>
        <a class="linklike" id="backToLogin">Ø±Ø¬ÙˆØ¹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <section id="homeView" class="view">
    <div class="card">
      <h2 style="margin:0 0 8px">Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ <span id="helloName">Ø¹Ø¶Ùˆ</span></h2>
      <div class="row" style="gap:8px">
        <span class="badge-mini">Ø§Ù„Ø­Ø§Ù„Ø©: <span id="badAuth">â€”</span></span>
        <span class="badge-mini">Ø§Ù„Ø¯ÙˆØ±: <span id="badRole">â€”</span></span>
      </div>
      <div class="sep"></div>
      <p class="mut">Ù†Ø³Ø®Ø© Ø£ÙˆÙ„ÙŠØ© â€” Ø¨Ø¹Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‡Ù†Ø¶ÙŠÙ Ø§Ù„Ø¨ÙˆØ³ØªØ§ØªØŒ Ø­Ø¶ÙˆØ± QRâ€¦ Ø¥Ù„Ø®.</p>
    </div>
  </section>

  <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
  <section id="profileView" class="view">
    <div class="card">
      <h3 style="margin-top:0">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
      <div class="grid">
        <div>
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</label>
          <input id="pfFirst">
        </div>
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</label>
          <input id="pfLast">
        </div>
        <div>
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯</label>
          <input id="pfEmail" disabled>
        </div>
        <div>
          <label>Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
          <input id="pfPhone">
        </div>
        <div>
          <label>Ø§Ù„Ø¯ÙØ¹Ø©</label>
          <input id="pfBatch">
        </div>
        <div>
          <label>ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€“ URL)</label>
          <input id="pfPhoto" placeholder="https://â€¦">
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btnSaveProfile">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù</button>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <section id="settingsView" class="view">
    <div class="card">
      <h3 style="margin-top:0">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
    <div class="grid">
      <div>
        <label>Ø§Ù„Ø«ÙŠÙ…</label>
        <div class="row">
          <button id="btnTheme" class="ghost">ØªØ¨Ø¯ÙŠÙ„ Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ ğŸŒ™/â˜€ï¸</button>
        </div>
      </div>
      <div>
        <label>Ø§Ù„Ù„ØºØ©</label>
        <select id="langSelSettings">
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="en">English</option>
        </select>
      </div>
      <div>
        <label>Ø§Ù„Ø®Ø·</label>
        <select id="fontSel">
          <option value="cairo">Cairo (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>
          <option value="noto">Noto Naskh Arabic</option>
          <option value="inter">Inter</option>
        </select>
      </div>
      <div>
        <label>Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</label>
        <select id="fsSel">
          <option value="15">ØµØºÙŠØ±</option>
          <option value="16" selected>Ø¹Ø§Ø¯ÙŠ</option>
          <option value="18">ÙƒØ¨ÙŠØ±</option>
          <option value="20">Ø£ÙƒØ¨Ø±</option>
        </select>
      </div>
    </div>
    <div class="sep"></div>
    <div class="right">
      <button id="btnLogout" class="warn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
    </div>
  </section>
</main>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
/* ============ Firebase Config ============ */
const firebaseConfig = {
  apiKey: "AIzaSyDfiO-4J0DIHSKZo_vdBXeS343eJ0x4pYo",
  authDomain: "ittihad-med-kfs.firebaseapp.com",
  projectId: "ittihad-med-kfs",
  appId: "1:323302922960:web:3343605d75d2a5147cdcd5"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* ========= Owner (Ù…Ø§Ù„Ùƒ) ========= */
const OWNER_EMAILS = ["dr.emara10@gmail.com"];

/* ========= Helpers ========= */
const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];
const val = el => (el?.value || "").trim();
const set = (el, v) => el && (el.value = v ?? "");
const toast = (msg, isErr=false) => {
  const a = $("#globalAlert");
  a.textContent = msg;
  a.style.display = msg ? "block" : "none";
  a.classList.toggle("show", !!msg);
  a.style.borderColor = isErr ? "rgba(239,68,68,.35)" : "rgba(34,197,94,.35)";
  a.style.background = isErr
      ? "linear-gradient(180deg,rgba(239,68,68,.20),rgba(239,68,68,.10))"
      : "linear-gradient(180deg,rgba(34,197,94,.20),rgba(34,197,94,.10))";
};
const showView = id => { $$(".view").forEach(v => v.classList.remove("active")); $("#"+id).classList.add("active"); };
const switchTab = id => { $$(".tab").forEach(t => t.classList.toggle("active", t.dataset.view===id)); showView(id); };
$$(".tab").forEach(t => t.onclick = () => switchTab(t.dataset.view));

/* ========= Theme/Fonts/Language ========= */
function applyTheme(theme){ document.documentElement.classList.toggle("light", theme==="light"); }
function applyFont(f){ document.body.classList.remove("ff-noto","ff-inter"); if(f==="noto") document.body.classList.add("ff-noto"); if(f==="inter") document.body.classList.add("ff-inter"); }
function applyFs(sz){ document.documentElement.style.setProperty("--fs", sz+"px"); }
function applyLang(lang){ document.documentElement.lang = lang; document.documentElement.dir  = (lang==="ar" ? "rtl" : "ltr"); ["#langSelAuth","#langSelSignup","#langSelSettings"].forEach(s=>{const el=$(s); if(el) el.value=lang;}); }
(function bootPrefs(){ applyTheme(localStorage.getItem("theme")||"dark"); applyFont(localStorage.getItem("font")||"cairo"); applyFs(parseInt(localStorage.getItem("fs")||"16")); applyLang(localStorage.getItem("lang")||"ar"); })();
$("#btnTheme").onclick = () => { const isLight = document.documentElement.classList.toggle("light"); localStorage.setItem("theme", isLight ? "light" : "dark"); };
$("#fontSel").onchange = e => { localStorage.setItem("font", e.target.value); applyFont(e.target.value); };
$("#fsSel").onchange   = e => { localStorage.setItem("fs", e.target.value); applyFs(parseInt(e.target.value)); };
$("#langSelAuth").onchange    = e => { localStorage.setItem("lang", e.target.value); applyLang(e.target.value); };
$("#langSelSignup").onchange  = e => { localStorage.setItem("lang", e.target.value); applyLang(e.target.value); };
$("#langSelSettings").onchange= e => { localStorage.setItem("lang", e.target.value); applyLang(e.target.value); };

/* ========= UI toggles ========= */
$("#toSignUp").onclick = () => showView("signupView");
$("#backToLogin").onclick = () => showView("authView");
$("#eyeIn").onclick = () => { const f=$("#inPass"); f.type = (f.type==="password"?"text":"password"); };
$("#eyeUp").onclick = () => { const f=$("#suPass"); f.type = (f.type==="password"?"text":"password"); };

/* ========= Validation ========= */
function mark(el, ok){ el.classList.toggle("error", !ok); return ok; }
function validEmail(s){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s); }
function minLen(s,n){ return (s||"").trim().length>=n; }

/* ========= Firestore: users/{uid} ========= */
async function writeUserDoc(u, data){
  const ref = db.collection("users").doc(u.uid);
  const role = OWNER_EMAILS.includes((u.email||"").toLowerCase()) ? "owner" : "member";
  const payload = {
    uid: u.uid,
    email: (u.email||""),
    emailLower: (u.email||"").toLowerCase(),
    first: data.first||"",
    last: data.last||"",
    displayName: `${data.first||""} ${data.last||""}`.trim(),
    phone: data.phone||"",
    batch: data.batch||"",
    photoURL: data.photoURL||u.photoURL||"",
    role,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  await ref.set(payload, {merge:true});
  return role;
}
async function loadUserDoc(uid){
  const snap = await db.collection("users").doc(uid).get();
  return snap.exists ? snap.data() : null;
}

/* ========= Sign Up (email) ========= */
$("#btnSignup").onclick = async () => {
  const first = val($("#suFirst")), last = val($("#suLast"));
  const email = val($("#suEmail")), phone = val($("#suPhone"));
  const batch = val($("#suBatch")), pass = val($("#suPass")), pass2 = val($("#suPass2"));

  const ok = [
    mark($("#suFirst"), minLen(first,2)),
    mark($("#suLast"),  minLen(last,2)),
    mark($("#suEmail"), validEmail(email)),
    mark($("#suPhone"), minLen(phone,7)),
    mark($("#suBatch"), minLen(batch,1)),
    mark($("#suPass"),  minLen(pass,8)),
    mark($("#suPass2"), pass===pass2)
  ].every(Boolean);
  if(!ok) return toast("Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±.", true);

  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    const role = await writeUserDoc(cred.user, {first,last,phone,batch});
    localStorage.setItem("lang", $("#langSelSignup").value);
    applyLang($("#langSelSignup").value);
    toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    afterLogin(cred.user, role);
  }catch(e){ toast("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: " + (e.message||e), true); }
};

/* ========= Sign Up / Continue with Google ========= */
const googleProvider = new firebase.auth.GoogleAuthProvider();
$("#btnGoogleSignup").onclick = async () => {
  try{
    const cred = await auth.signInWithPopup(googleProvider);
    const doc = await loadUserDoc(cred.user.uid);
    if(!doc){
      set($("#suEmail"), cred.user.email||"");
      const parts = (cred.user.displayName||"").split(" ");
      set($("#suFirst"), parts[0]||"");
      set($("#suLast"), parts.slice(1).join(" ")||"");
      showView("signupView");
      toast("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù.");
    }else{
      afterLogin(cred.user, doc.role||"member");
    }
  }catch(e){ toast("Ø¥Ù„ØºØ§Ø¡/Ø®Ø·Ø£ Google: " + (e.message||e), true); }
};

/* ========= Login ========= */
$("#btnEmailLogin").onclick = async () => {
  const email = val($("#inEmail")), pass = val($("#inPass"));
  if(!validEmail(email)){ mark($("#inEmail"), false); return toast("Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± ØµØ§Ù„Ø­.", true); }
  try{
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    const doc  = await loadUserDoc(cred.user.uid);
    const role = doc?.role || (OWNER_EMAILS.includes(email.toLowerCase()) ? "owner":"member");
    if(!doc){ await writeUserDoc(cred.user, {first:"",last:"",phone:"",batch:""}); }
    toast(""); afterLogin(cred.user, role);
  }catch(e){
    const code = e && e.code || "";
    if(code.includes("invalid-credential") || code.includes("wrong-password")){
      $("#inPass").classList.add("error");
      toast("Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.", true);
    }else{
      toast("ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + (e.message||e), true);
    }
  }
};

/* ========= Forgot Password ========= */
$("#forgotLink").onclick = async () => {
  const email = val($("#inEmail"));
  if(!validEmail(email)) { mark($("#inEmail"),false); return toast("Ø§ÙƒØªØ¨ Ø¨Ø±ÙŠØ¯Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹.", true); }
  try{ await auth.sendPasswordResetEmail(email); toast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ."); }
  catch(e){ toast("ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + (e.message||e), true); }
};

/* ========= After Login UI ========= */
function afterLogin(user, role){
  $("#tabs").style.display = "";
  $("#roleBadge").textContent = (role==="owner"?"Owner ğŸ‘‘":"Member");
  $("#badAuth").textContent   = user.email || user.uid;
  $("#badRole").textContent   = (role==="owner"?"Owner ğŸ‘‘":"Member");
  const dn = user.displayName || "";
  $("#helloName").textContent = dn || "Ø¹Ø¶Ùˆ";
  set($("#pfEmail"), user.email||"");
  db.collection("users").doc(user.uid).onSnapshot(s=>{
    const d = s.data()||{};
    set($("#pfFirst"), d.first||"");
    set($("#pfLast"),  d.last||"");
    set($("#pfPhone"), d.phone||"");
    set($("#pfBatch"), d.batch||"");
    set($("#pfPhoto"), d.photo
