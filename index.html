<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>اتحاد طب بشري كفر الشيخ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #0f172a;
      color: white;
      font-family: 'Cairo', sans-serif;
    }
    .login-box {
      max-width: 420px;
      margin: auto;
      background: #1e293b;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0px 4px 12px rgba(0,0,0,0.5);
    }
    .btn-custom {
      background: linear-gradient(90deg, #22c55e, #16a34a);
      border: none;
      color: white;
      font-weight: bold;
    }
    .btn-google {
      background: #db4437;
      border: none;
      color: white;
      font-weight: bold;
    }
    /* موبايل */
    @media (max-width: 767px) {
      .login-box {
        margin-top: 60px;
        padding: 15px;
      }
    }
    /* كمبيوتر */
    @media (min-width: 768px) {
      .login-box {
        margin-top: 120px;
        padding: 30px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="login-box">
      <h3 class="text-center mb-4">تسجيل الدخول</h3>
      <form id="loginForm">
        <div class="mb-3">
          <label for="email" class="form-label">البريد الإلكتروني</label>
          <input type="email" class="form-control" id="email" placeholder="you@example.com" required>
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">كلمة السر</label>
          <div class="input-group">
            <input type="password" class="form-control" id="password" placeholder="••••••••" required>
            <button class="btn btn-outline-secondary" type="button" id="togglePassword">👁</button>
          </div>
        </div>
        <button type="submit" class="btn btn-custom w-100 mb-2">دخول بالبريد</button>
        <button type="button" class="btn btn-google w-100 mb-2" id="googleLogin">دخول بحساب Google</button>
        <a href="#" class="d-block text-center text-info">نسيت كلمة السر؟</a>
        <hr class="text-light">
        <a href="#" class="btn btn-outline-light w-100">إنشاء حساب جديد</a>
      </form>
    </div>
  </div> 
  <!-- Firebase SDKs (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    // ===== 1) Firebase Config & Boot =====
    const firebaseConfig = {
      apiKey: "AIzaSyDfiO-4J0DIHSKZo_vdBXeS343eJ0x4pYo",
      authDomain: "ittihad-med-kfs.firebaseapp.com",
      projectId: "ittihad-med-kfs",
      appId: "1:323302922960:web:3343605d75d2a5147cdcd5"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // ===== 2) Helpers =====
    const $  = (sel) => document.querySelector(sel);
    const val = (el) => (el?.value || "").trim();
    const okEmail = (e) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);

    function toast(msg, type="info") {
      // تنبيه بسيط سريع
      const box = document.createElement("div");
      box.textContent = msg;
      box.style.cssText =
        "position:fixed;inset:auto 0 20px 0;margin:auto;max-width:90%;width:fit-content;padding:10px 14px;border-radius:10px;z-index:9999;font-weight:700;" +
        (type==="err"
          ? "background:#7f1d1d;color:#fee2e2;border:1px solid #ef4444;"
          : "background:#064e3b;color:#d1fae5;border:1px solid #10b981;");
      document.body.appendChild(box);
      setTimeout(()=>box.remove(), 3000);
    }

    // ===== 3) UI: إظهار/إخفاء كلمة السر =====
    $("#togglePassword").addEventListener("click", () => {
      const input = $("#password");
      input.type = input.type === "password" ? "text" : "password";
    });

    // ===== 4) Auth: دخول بالبريد =====
    $("#loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = val($("#email"));
      const pass  = val($("#password"));

      if (!okEmail(email)) {
        toast("اكتب بريد إلكتروني صالح.", "err");
        $("#email").focus();
        return;
      }
      if (pass.length < 6) {
        toast("كلمة السر قصيرة.", "err");
        $("#password").focus();
        return;
      }

      const btn = $("#loginForm button[type='submit']");
      btn.disabled = true;
      try {
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        // عند أول دخول نضمن وجود مستند للمستخدم
        await ensureUserDoc(cred.user);
        toast("تم تسجيل الدخول ✅", "ok");
      } catch (err) {
        const code = err.code || "";
        if (code.includes("wrong-password") || code.includes("invalid-credential")) {
          toast("الإيميل أو كلمة السر غير صحيحة.", "err");
          $("#password").focus();
        } else if (code.includes("user-not-found")) {
          toast("لا يوجد حساب بهذا البريد.", "err");
        } else {
          toast("فشل الدخول: " + (err.message || err), "err");
        }
      } finally {
        btn.disabled = false;
      }
    });

    // ===== 5) Auth: دخول بحساب Google =====
    const provider = new firebase.auth.GoogleAuthProvider();
    $("#googleLogin").addEventListener("click", async () => {
      const btn = $("#googleLogin");
      btn.disabled = true;
      try {
        let cred;
        try {
          cred = await auth.signInWithPopup(provider);
        } catch (e) {
          if ((e.code || "").includes("popup-blocked")) {
            await auth.signInWithRedirect(provider);
            return; // هيكمل بعد الرجوع
          }
          throw e;
        }
        if (cred?.user) {
          await ensureUserDoc(cred.user);
          toast("مرحبًا بك ✅");
        }
      } catch (err) {
        toast("إلغاء/خطأ Google: " + (err.message || err), "err");
      } finally {
        btn.disabled = false;
      }
    });

    // ===== 6) onAuthStateChanged =====
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        // انتقال لشاشة داخلية (هنضيفها في الجزء الثالث)
        document.body.classList.add("authed");
        showDashboard(user); // تعريفها بالجزء الثالث
      } else {
        document.body.classList.remove("authed");
        // إرجاع نموذج الدخول
        document.querySelector(".login-box").style.display = "block";
      }
    });

    // ===== 7) Firestore: ضمان مستند مستخدم =====
    async function ensureUserDoc(u) {
      const ref = db.collection("users").doc(u.uid);
      const snap = await ref.get();
      if (!snap.exists) {
        await ref.set({
          uid: u.uid,
          email: u.email || "",
          emailLower: (u.email || "").toLowerCase(),
          displayName: u.displayName || "",
          photoURL: u.photoURL || "",
          role: "member",
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      } else {
        // حدّث آخر نشاط
        await ref.set({ updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      }
    }
  </script>
  <!-- ====== Dashboard (يظهر بعد تسجيل الدخول) ====== -->
  <section id="app" style="display:none">
    <div class="topbar app" style="position:sticky;top:0;z-index:50;gap:12px">
      <div class="brand">
        <!-- نفس اللوجو – يفتح الإعدادات فقط لو المستخدم مسجل -->
        <img src="logo.png" alt="شعار" class="logo" id="openSettings">
        <h1 id="appTitle" style="margin:0">اتحاد طب بشري كفر الشيخ</h1>
      </div>
      <div class="role-badge" id="roleTxt">Member</div>
    </div>

    <div class="container" style="padding-top:12px">
      <!-- تبويبات -->
      <div class="tabs" id="appTabs">
        <div class="tab active" data-to="viewHome">الرئيسية</div>
        <div class="tab" data-to="viewProfile">الملف الشخصي</div>
      </div>

      <!-- الرئيسية -->
      <div id="viewHome" class="view active">
        <div class="card">
          <h2 style="margin:0 0 8px">مرحبًا، <span id="helloName">عضو</span> 👋</h2>
          <div class="row" style="gap:8px;margin:8px 0 14px">
            <span class="badge-mini">البريد: <span id="helloEmail">—</span></span>
            <span class="badge-mini">الدور: <span id="helloRole">—</span></span>
          </div>
          <p class="mut">نسخة أولية — بعد تفعيل الصلاحيات هنضيف البوستات، حضور QR… إلخ.</p>
        </div>
      </div>

      <!-- الملف الشخصي -->
      <div id="viewProfile" class="view">
        <div class="card">
          <h3 style="margin-top:0">الملف الشخصي</h3>

          <!-- صورة في الأعلى + اختيار ملف (عرض محلي فقط) -->
          <div class="row" style="gap:16px;align-items:center;margin-bottom:10px">
            <img id="pfAvatar" src="" alt="avatar" style="width:84px;height:84px;border-radius:50%;object-fit:cover;border:1px solid var(--bor);background:#111">
            <div class="row" style="gap:10px">
              <input id="pfPhoto" placeholder="رابط صورة (URL)" style="min-width:240px">
              <input id="pfFile" type="file" accept="image/*" style="max-width:200px">
            </div>
          </div>

          <div class="grid">
            <div><label>الاسم الأول</label><input id="pfFirst"></div>
            <div><label>اسم العائلة</label><input id="pfLast"></div>
            <div><label>البريد</label><input id="pfEmail" disabled></div>
            <div><label>الموبايل</label><input id="pfPhone" inputmode="tel"></div>
            <div><label>الدفعة</label><input id="pfBatch" inputmode="numeric"></div>
          </div>

          <div class="row" style="margin-top:12px;justify-content:flex-end">
            <button id="saveProfile">حفظ الملف</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ====== درج الإعدادات الجانبي ====== -->
  <div id="drawerBackdrop" class="drawer-backdrop"></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <strong>الإعدادات</strong>
      <button class="warn" id="logoutBtn">تسجيل الخروج</button>
    </div>
    <div class="sep"></div>

    <div class="grid" style="margin-bottom:10px">
      <div>
        <label>الثيم</label>
        <button class="google" id="toggleTheme" style="width:100%">تبديل ليلي/نهاري 🌙/☀️</button>
      </div>
      <div>
        <label>اللغة</label>
        <select id="langSelSettings" style="width:100%">
          <option value="ar">العربية</option>
          <option value="en">English</option>
        </select>
      </div>
      <div>
        <label>الخط</label>
        <select id="fontSel" style="width:100%">
          <option value="cairo">Cairo (افتراضي)</option>
          <option value="noto">Noto Naskh Arabic</option>
          <option value="inter">Inter</option>
        </select>
      </div>
      <div>
        <label>حجم الخط</label>
        <select id="fsSel" style="width:100%">
          <option value="15">صغير</option>
          <option value="16" selected>عادي</option>
          <option value="18">كبير</option>
          <option value="20">أكبر</option>
        </select>
      </div>
    </div>
    <div class="sep"></div>
    <p class="mut" style="font-size:12px">ملاحظة: فتح الإعدادات من شعار الاتحاد متاح بعد تسجيل الدخول فقط.</p>
  </aside>

  <script>
    // =============== تبديل التبويبات ===============
    document.getElementById("appTabs").addEventListener("click",(e)=>{
      const t = e.target.closest(".tab"); if(!t) return;
      document.querySelectorAll("#appTabs .tab").forEach(x=>x.classList.toggle("active", x===t));
      const to = t.dataset.to;
      document.querySelectorAll("#app .view").forEach(v=>v.classList.remove("active"));
      document.getElementById(to).classList.add("active");
    });

    // =============== فتح/غلق الدرج ===============
    const drawer = document.getElementById("drawer");
    const backdrop = document.getElementById("drawerBackdrop");
    function openDrawer(){ backdrop.style.display="block"; requestAnimationFrame(()=>drawer.classList.add("open")); }
    function closeDrawer(){ drawer.classList.remove("open"); backdrop.style.display="none"; }
    backdrop.addEventListener("click", closeDrawer);

    // افتح الإعدادات بالضغط على الشعار — لكن فقط عند تسجيل الدخول
    document.getElementById("openSettings").addEventListener("click", ()=>{
      if (!window.__authed) { toast("سجل دخول الأول لفتح الإعدادات","err"); return; }
      openDrawer();
    });

    // =============== إعدادات المظهر/اللغة/الخط ===============
    function setLang(l){ localStorage.setItem("lang",l); document.documentElement.lang=l; document.documentElement.dir=(l==="ar"?"rtl":"ltr"); }
    function setFont(f){
      localStorage.setItem("font",f);
      document.body.classList.remove("ff-noto","ff-inter");
      if(f==="noto") document.body.classList.add("ff-noto");
      if(f==="inter") document.body.classList.add("ff-inter");
    }
    function setFs(sz){ localStorage.setItem("fs",sz); document.documentElement.style.setProperty("--fs", (sz||16)+"px"); }
    function toggleTheme(){ const light = document.documentElement.classList.toggle("light"); localStorage.setItem("theme", light?"light":"dark"); }

    // ربط عناصر الدرج
    document.getElementById("toggleTheme").onclick = toggleTheme;
    document.getElementById("langSelSettings").onchange = (e)=>setLang(e.target.value);
    document.getElementById("fontSel").onchange = (e)=>setFont(e.target.value);
    document.getElementById("fsSel").onchange   = (e)=>setFs(e.target.value);

    // تحميل تفضيلات محلية
    (function bootPrefs(){
      setLang(localStorage.getItem("lang")||"ar");
      setFont(localStorage.getItem("font")||"cairo");
      setFs(localStorage.getItem("fs")||"16");
      if((localStorage.getItem("theme")||"dark")==="light") document.documentElement.classList.add("light");
    })();

    // =============== عرض الداشبورد بعد الدخول ===============
    async function showDashboard(user){
      window.__authed = true;

      // إظهار قسم التطبيق وإخفاء صندوق الدخول
      document.querySelector(".login-box")?.setAttribute("style","display:none");
      document.getElementById("app").style.display = "block";

      // معلومات أساسية
      document.getElementById("helloEmail").textContent = user.email || "";
      document.getElementById("pfEmail").value = user.email || "";

      // اجلب/أنشئ مستند المستخدم ثم املأ الحقول
      const ref = db.collection("users").doc(user.uid);
      const snap = await ref.get();
      const d = snap.exists ? snap.data() : {};
      const first = d.first || (user.displayName||"").split(" ")[0] || "";
      const last  = d.last  || (user.displayName||"").split(" ").slice(1).join(" ") || "";
      const role  = d.role  || "member";

      document.getElementById("pfFirst").value = first;
      document.getElementById("pfLast").value  = last;
      document.getElementById("pfPhone").value = d.phone || "";
      document.getElementById("pfBatch").value = d.batch || "";
      document.getElementById("pfPhoto").value = d.photoURL || "";
      document.getElementById("pfAvatar").src = d.photoURL || user.photoURL || "";

      document.getElementById("helloName").textContent = (first+" "+last).trim() || (user.displayName||"عضو");
      document.getElementById("helloRole").textContent = role==="owner" ? "Owner 👑" : "Member";
      document.getElementById("roleTxt").textContent   = role==="owner" ? "Owner 👑" : "Member";
    }

    // =============== حفظ الملف الشخصي ===============
    document.getElementById("saveProfile").addEventListener("click", async () => {
      const u = auth.currentUser; if(!u) return;
      const first = document.getElementById("pfFirst").value.trim();
      const last  = document.getElementById("pfLast").value.trim();
      const phone = document.getElementById("pfPhone").value.trim();
      const batch = document.getElementById("pfBatch").value.trim();
      const photo = document.getElementById("pfPhoto").value.trim();

      if (!first || !last) { toast("أكمل الاسم.", "err"); return; }

      try{
        await db.collection("users").doc(u.uid).set({
          first, last, phone, batch, photoURL: photo,
          displayName: (first+" "+last).trim(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        document.getElementById("helloName").textContent = (first+" "+last).trim();
        document.getElementById("pfAvatar").src = photo || document.getElementById("pfAvatar").src;

        toast("تم حفظ الملف ✅");
      }catch(e){
        toast("تعذّر الحفظ: "+(e.message||e), "err");
      }
    });

    // معاينة الصورة من اختيار ملف محلي (عرض فقط)
    document.getElementById("pfFile").addEventListener("change", (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const url = URL.createObjectURL(f);
      document.getElementById("pfAvatar").src = url; // عرض فوري
      toast("تم اختيار صورة للمعاينة — احفظ رابطًا في خانة URL لو حابب تثبتها.");
    });

    // =============== تسجيل الخروج ===============
    document.getElementById("logoutBtn").addEventListener("click", async ()=>{
      await auth.signOut();
      closeDrawer();
      window.__authed = false;
      document.getElementById("app").style.display = "none";
      document.querySelector(".login-box")?.setAttribute("style","display:block");
      toast("تم تسجيل الخروج");
    });

    // =============== تحسينات عرض للموبايل/PC ===============
    // تكبير محتوى نموذج الدخول في الشاشات الصغيرة
    (function responsiveTuning(){
      const mq = window.matchMedia("(max-width: 480px)");
      function tune(){
        const box = document.querySelector(".login-box");
        if (!box) return;
        if (mq.matches){
          box.style.maxWidth = "98%";
          box.style.padding  = "14px";
        } else {
          box.style.maxWidth = "520px";
          box.style.padding  = "18px";
        }
      }
      mq.addEventListener?.("change", tune);
      tune();
    })();
  </script>
</body>
</html>
