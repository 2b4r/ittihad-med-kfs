<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§ØªØ­Ø§Ø¯ Ø·Ø¨ Ø¨Ø´Ø±ÙŠ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #0f172a;
      color: white;
      font-family: 'Cairo', sans-serif;
    }
    .login-box {
      max-width: 420px;
      margin: auto;
      background: #1e293b;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0px 4px 12px rgba(0,0,0,0.5);
    }
    .btn-custom {
      background: linear-gradient(90deg, #22c55e, #16a34a);
      border: none;
      color: white;
      font-weight: bold;
    }
    .btn-google {
      background: #db4437;
      border: none;
      color: white;
      font-weight: bold;
    }
    /* Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    @media (max-width: 767px) {
      .login-box {
        margin-top: 60px;
        padding: 15px;
      }
    }
    /* ÙƒÙ…Ø¨ÙŠÙˆØªØ± */
    @media (min-width: 768px) {
      .login-box {
        margin-top: 120px;
        padding: 30px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="login-box">
      <h3 class="text-center mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <form id="loginForm">
        <div class="mb-3">
          <label for="email" class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input type="email" class="form-control" id="email" placeholder="you@example.com" required>
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <div class="input-group">
            <input type="password" class="form-control" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
            <button class="btn btn-outline-secondary" type="button" id="togglePassword">ğŸ‘</button>
          </div>
        </div>
        <button type="submit" class="btn btn-custom w-100 mb-2">Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
        <button type="button" class="btn btn-google w-100 mb-2" id="googleLogin">Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google</button>
        <a href="#" class="d-block text-center text-info">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</a>
        <hr class="text-light">
        <a href="#" class="btn btn-outline-light w-100">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a>
      </form>
    </div>
  </div> 
  <!-- Firebase SDKs (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    // ===== 1) Firebase Config & Boot =====
    const firebaseConfig = {
      apiKey: "AIzaSyDfiO-4J0DIHSKZo_vdBXeS343eJ0x4pYo",
      authDomain: "ittihad-med-kfs.firebaseapp.com",
      projectId: "ittihad-med-kfs",
      appId: "1:323302922960:web:3343605d75d2a5147cdcd5"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // ===== 2) Helpers =====
    const $  = (sel) => document.querySelector(sel);
    const val = (el) => (el?.value || "").trim();
    const okEmail = (e) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);

    function toast(msg, type="info") {
      // ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø³ÙŠØ· Ø³Ø±ÙŠØ¹
      const box = document.createElement("div");
      box.textContent = msg;
      box.style.cssText =
        "position:fixed;inset:auto 0 20px 0;margin:auto;max-width:90%;width:fit-content;padding:10px 14px;border-radius:10px;z-index:9999;font-weight:700;" +
        (type==="err"
          ? "background:#7f1d1d;color:#fee2e2;border:1px solid #ef4444;"
          : "background:#064e3b;color:#d1fae5;border:1px solid #10b981;");
      document.body.appendChild(box);
      setTimeout(()=>box.remove(), 3000);
    }

    // ===== 3) UI: Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± =====
    $("#togglePassword").addEventListener("click", () => {
      const input = $("#password");
      input.type = input.type === "password" ? "text" : "password";
    });

    // ===== 4) Auth: Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ =====
    $("#loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = val($("#email"));
      const pass  = val($("#password"));

      if (!okEmail(email)) {
        toast("Ø§ÙƒØªØ¨ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ§Ù„Ø­.", "err");
        $("#email").focus();
        return;
      }
      if (pass.length < 6) {
        toast("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù‚ØµÙŠØ±Ø©.", "err");
        $("#password").focus();
        return;
      }

      const btn = $("#loginForm button[type='submit']");
      btn.disabled = true;
      try {
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        // Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„ Ù†Ø¶Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªÙ†Ø¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await ensureUserDoc(cred.user);
        toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…", "ok");
      } catch (err) {
        const code = err.code || "";
        if (code.includes("wrong-password") || code.includes("invalid-credential")) {
          toast("Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.", "err");
          $("#password").focus();
        } else if (code.includes("user-not-found")) {
          toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯.", "err");
        } else {
          toast("ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + (err.message || err), "err");
        }
      } finally {
        btn.disabled = false;
      }
    });

    // ===== 5) Auth: Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google =====
    const provider = new firebase.auth.GoogleAuthProvider();
    $("#googleLogin").addEventListener("click", async () => {
      const btn = $("#googleLogin");
      btn.disabled = true;
      try {
        let cred;
        try {
          cred = await auth.signInWithPopup(provider);
        } catch (e) {
          if ((e.code || "").includes("popup-blocked")) {
            await auth.signInWithRedirect(provider);
            return; // Ù‡ÙŠÙƒÙ…Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¬ÙˆØ¹
          }
          throw e;
        }
        if (cred?.user) {
          await ensureUserDoc(cred.user);
          toast("Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ âœ…");
        }
      } catch (err) {
        toast("Ø¥Ù„ØºØ§Ø¡/Ø®Ø·Ø£ Google: " + (err.message || err), "err");
      } finally {
        btn.disabled = false;
      }
    });

    // ===== 6) onAuthStateChanged =====
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        // Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø´Ø§Ø´Ø© Ø¯Ø§Ø®Ù„ÙŠØ© (Ù‡Ù†Ø¶ÙŠÙÙ‡Ø§ ÙÙŠ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù„Ø«)
        document.body.classList.add("authed");
        showDashboard(user); // ØªØ¹Ø±ÙŠÙÙ‡Ø§ Ø¨Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù„Ø«
      } else {
        document.body.classList.remove("authed");
        // Ø¥Ø±Ø¬Ø§Ø¹ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯Ø®ÙˆÙ„
        document.querySelector(".login-box").style.display = "block";
      }
    });

    // ===== 7) Firestore: Ø¶Ù…Ø§Ù† Ù…Ø³ØªÙ†Ø¯ Ù…Ø³ØªØ®Ø¯Ù… =====
    async function ensureUserDoc(u) {
      const ref = db.collection("users").doc(u.uid);
      const snap = await ref.get();
      if (!snap.exists) {
        await ref.set({
          uid: u.uid,
          email: u.email || "",
          emailLower: (u.email || "").toLowerCase(),
          displayName: u.displayName || "",
          photoURL: u.photoURL || "",
          role: "member",
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      } else {
        // Ø­Ø¯Ù‘Ø« Ø¢Ø®Ø± Ù†Ø´Ø§Ø·
        await ref.set({ updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      }
    }
  </script>
  <!-- ====== Dashboard (ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„) ====== -->
  <section id="app" style="display:none">
    <div class="topbar app" style="position:sticky;top:0;z-index:50;gap:12px">
      <div class="brand">
        <!-- Ù†ÙØ³ Ø§Ù„Ù„ÙˆØ¬Ùˆ â€“ ÙŠÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ -->
        <img src="logo.png" alt="Ø´Ø¹Ø§Ø±" class="logo" id="openSettings">
        <h1 id="appTitle" style="margin:0">Ø§ØªØ­Ø§Ø¯ Ø·Ø¨ Ø¨Ø´Ø±ÙŠ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</h1>
      </div>
      <div class="role-badge" id="roleTxt">Member</div>
    </div>

    <div class="container" style="padding-top:12px">
      <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
      <div class="tabs" id="appTabs">
        <div class="tab active" data-to="viewHome">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="tab" data-to="viewProfile">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
      </div>

      <!-- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
      <div id="viewHome" class="view active">
        <div class="card">
          <h2 style="margin:0 0 8px">Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ <span id="helloName">Ø¹Ø¶Ùˆ</span> ğŸ‘‹</h2>
          <div class="row" style="gap:8px;margin:8px 0 14px">
            <span class="badge-mini">Ø§Ù„Ø¨Ø±ÙŠØ¯: <span id="helloEmail">â€”</span></span>
            <span class="badge-mini">Ø§Ù„Ø¯ÙˆØ±: <span id="helloRole">â€”</span></span>
          </div>
          <p class="mut">Ù†Ø³Ø®Ø© Ø£ÙˆÙ„ÙŠØ© â€” Ø¨Ø¹Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‡Ù†Ø¶ÙŠÙ Ø§Ù„Ø¨ÙˆØ³ØªØ§ØªØŒ Ø­Ø¶ÙˆØ± QRâ€¦ Ø¥Ù„Ø®.</p>
        </div>
      </div>

      <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
      <div id="viewProfile" class="view">
        <div class="card">
          <h3 style="margin-top:0">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>

          <!-- ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ + Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù (Ø¹Ø±Ø¶ Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·) -->
          <div class="row" style="gap:16px;align-items:center;margin-bottom:10px">
            <img id="pfAvatar" src="" alt="avatar" style="width:84px;height:84px;border-radius:50%;object-fit:cover;border:1px solid var(--bor);background:#111">
            <div class="row" style="gap:10px">
              <input id="pfPhoto" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (URL)" style="min-width:240px">
              <input id="pfFile" type="file" accept="image/*" style="max-width:200px">
            </div>
          </div>

          <div class="grid">
            <div><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</label><input id="pfFirst"></div>
            <div><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</label><input id="pfLast"></div>
            <div><label>Ø§Ù„Ø¨Ø±ÙŠØ¯</label><input id="pfEmail" disabled></div>
            <div><label>Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label><input id="pfPhone" inputmode="tel"></div>
            <div><label>Ø§Ù„Ø¯ÙØ¹Ø©</label><input id="pfBatch" inputmode="numeric"></div>
          </div>

          <div class="row" style="margin-top:12px;justify-content:flex-end">
            <button id="saveProfile">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ====== Ø¯Ø±Ø¬ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ ====== -->
  <div id="drawerBackdrop" class="drawer-backdrop"></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <strong>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</strong>
      <button class="warn" id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
    <div class="sep"></div>

    <div class="grid" style="margin-bottom:10px">
      <div>
        <label>Ø§Ù„Ø«ÙŠÙ…</label>
        <button class="google" id="toggleTheme" style="width:100%">ØªØ¨Ø¯ÙŠÙ„ Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ ğŸŒ™/â˜€ï¸</button>
      </div>
      <div>
        <label>Ø§Ù„Ù„ØºØ©</label>
        <select id="langSelSettings" style="width:100%">
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="en">English</option>
        </select>
      </div>
      <div>
        <label>Ø§Ù„Ø®Ø·</label>
        <select id="fontSel" style="width:100%">
          <option value="cairo">Cairo (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>
          <option value="noto">Noto Naskh Arabic</option>
          <option value="inter">Inter</option>
        </select>
      </div>
      <div>
        <label>Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</label>
        <select id="fsSel" style="width:100%">
          <option value="15">ØµØºÙŠØ±</option>
          <option value="16" selected>Ø¹Ø§Ø¯ÙŠ</option>
          <option value="18">ÙƒØ¨ÙŠØ±</option>
          <option value="20">Ø£ÙƒØ¨Ø±</option>
        </select>
      </div>
    </div>
    <div class="sep"></div>
    <p class="mut" style="font-size:12px">Ù…Ù„Ø§Ø­Ø¸Ø©: ÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø´Ø¹Ø§Ø± Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ù…ØªØ§Ø­ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙ‚Ø·.</p>
  </aside>

  <script>
    // =============== ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ===============
    document.getElementById("appTabs").addEventListener("click",(e)=>{
      const t = e.target.closest(".tab"); if(!t) return;
      document.querySelectorAll("#appTabs .tab").forEach(x=>x.classList.toggle("active", x===t));
      const to = t.dataset.to;
      document.querySelectorAll("#app .view").forEach(v=>v.classList.remove("active"));
      document.getElementById(to).classList.add("active");
    });

    // =============== ÙØªØ­/ØºÙ„Ù‚ Ø§Ù„Ø¯Ø±Ø¬ ===============
    const drawer = document.getElementById("drawer");
    const backdrop = document.getElementById("drawerBackdrop");
    function openDrawer(){ backdrop.style.display="block"; requestAnimationFrame(()=>drawer.classList.add("open")); }
    function closeDrawer(){ drawer.classList.remove("open"); backdrop.style.display="none"; }
    backdrop.addEventListener("click", closeDrawer);

    // Ø§ÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¹Ø§Ø± â€” Ù„ÙƒÙ† ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    document.getElementById("openSettings").addEventListener("click", ()=>{
      if (!window.__authed) { toast("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„ Ù„ÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª","err"); return; }
      openDrawer();
    });

    // =============== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø±/Ø§Ù„Ù„ØºØ©/Ø§Ù„Ø®Ø· ===============
    function setLang(l){ localStorage.setItem("lang",l); document.documentElement.lang=l; document.documentElement.dir=(l==="ar"?"rtl":"ltr"); }
    function setFont(f){
      localStorage.setItem("font",f);
      document.body.classList.remove("ff-noto","ff-inter");
      if(f==="noto") document.body.classList.add("ff-noto");
      if(f==="inter") document.body.classList.add("ff-inter");
    }
    function setFs(sz){ localStorage.setItem("fs",sz); document.documentElement.style.setProperty("--fs", (sz||16)+"px"); }
    function toggleTheme(){ const light = document.documentElement.classList.toggle("light"); localStorage.setItem("theme", light?"light":"dark"); }

    // Ø±Ø¨Ø· Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯Ø±Ø¬
    document.getElementById("toggleTheme").onclick = toggleTheme;
    document.getElementById("langSelSettings").onchange = (e)=>setLang(e.target.value);
    document.getElementById("fontSel").onchange = (e)=>setFont(e.target.value);
    document.getElementById("fsSel").onchange   = (e)=>setFs(e.target.value);

    // ØªØ­Ù…ÙŠÙ„ ØªÙØ¶ÙŠÙ„Ø§Øª Ù…Ø­Ù„ÙŠØ©
    (function bootPrefs(){
      setLang(localStorage.getItem("lang")||"ar");
      setFont(localStorage.getItem("font")||"cairo");
      setFs(localStorage.getItem("fs")||"16");
      if((localStorage.getItem("theme")||"dark")==="light") document.documentElement.classList.add("light");
    })();

    // =============== Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===============
    async function showDashboard(user){
      window.__authed = true;

      // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ¥Ø®ÙØ§Ø¡ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø®ÙˆÙ„
      document.querySelector(".login-box")?.setAttribute("style","display:none");
      document.getElementById("app").style.display = "block";

      // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
      document.getElementById("helloEmail").textContent = user.email || "";
      document.getElementById("pfEmail").value = user.email || "";

      // Ø§Ø¬Ù„Ø¨/Ø£Ù†Ø´Ø¦ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø«Ù… Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„
      const ref = db.collection("users").doc(user.uid);
      const snap = await ref.get();
      const d = snap.exists ? snap.data() : {};
      const first = d.first || (user.displayName||"").split(" ")[0] || "";
      const last  = d.last  || (user.displayName||"").split(" ").slice(1).join(" ") || "";
      const role  = d.role  || "member";

      document.getElementById("pfFirst").value = first;
      document.getElementById("pfLast").value  = last;
      document.getElementById("pfPhone").value = d.phone || "";
      document.getElementById("pfBatch").value = d.batch || "";
      document.getElementById("pfPhoto").value = d.photoURL || "";
      document.getElementById("pfAvatar").src = d.photoURL || user.photoURL || "";

      document.getElementById("helloName").textContent = (first+" "+last).trim() || (user.displayName||"Ø¹Ø¶Ùˆ");
      document.getElementById("helloRole").textContent = role==="owner" ? "Owner ğŸ‘‘" : "Member";
      document.getElementById("roleTxt").textContent   = role==="owner" ? "Owner ğŸ‘‘" : "Member";
    }

    // =============== Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ===============
    document.getElementById("saveProfile").addEventListener("click", async () => {
      const u = auth.currentUser; if(!u) return;
      const first = document.getElementById("pfFirst").value.trim();
      const last  = document.getElementById("pfLast").value.trim();
      const phone = document.getElementById("pfPhone").value.trim();
      const batch = document.getElementById("pfBatch").value.trim();
      const photo = document.getElementById("pfPhoto").value.trim();

      if (!first || !last) { toast("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø§Ø³Ù….", "err"); return; }

      try{
        await db.collection("users").doc(u.uid).set({
          first, last, phone, batch, photoURL: photo,
          displayName: (first+" "+last).trim(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        document.getElementById("helloName").textContent = (first+" "+last).trim();
        document.getElementById("pfAvatar").src = photo || document.getElementById("pfAvatar").src;

        toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù âœ…");
      }catch(e){
        toast("ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸: "+(e.message||e), "err");
      }
    });

    // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ù…Ø­Ù„ÙŠ (Ø¹Ø±Ø¶ ÙÙ‚Ø·)
    document.getElementById("pfFile").addEventListener("change", (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const url = URL.createObjectURL(f);
      document.getElementById("pfAvatar").src = url; // Ø¹Ø±Ø¶ ÙÙˆØ±ÙŠ
      toast("ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© â€” Ø§Ø­ÙØ¸ Ø±Ø§Ø¨Ø·Ù‹Ø§ ÙÙŠ Ø®Ø§Ù†Ø© URL Ù„Ùˆ Ø­Ø§Ø¨Ø¨ ØªØ«Ø¨ØªÙ‡Ø§.");
    });

    // =============== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ===============
    document.getElementById("logoutBtn").addEventListener("click", async ()=>{
      await auth.signOut();
      closeDrawer();
      window.__authed = false;
      document.getElementById("app").style.display = "none";
      document.querySelector(".login-box")?.setAttribute("style","display:block");
      toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
    });

    // =============== ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ø±Ø¶ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„/PC ===============
    // ØªÙƒØ¨ÙŠØ± Ù…Ø­ØªÙˆÙ‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
    (function responsiveTuning(){
      const mq = window.matchMedia("(max-width: 480px)");
      function tune(){
        const box = document.querySelector(".login-box");
        if (!box) return;
        if (mq.matches){
          box.style.maxWidth = "98%";
          box.style.padding  = "14px";
        } else {
          box.style.maxWidth = "520px";
          box.style.padding  = "18px";
        }
      }
      mq.addEventListener?.("change", tune);
      tune();
    })();
  </script>
</body>
</html>
