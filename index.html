<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>اتحاد طب بشري كفر الشيخ</title>
<meta name="theme-color" content="#0e1116"/>

<style>
:root{
  --bg1:#0b1016;--bg2:#0f1520;--txt:#e8edf3;--mut:#9aa6b2;
  --bor:rgba(255,255,255,.12);--card:rgba(255,255,255,.06);
  --acc:#38bdf8;--ok:#22c55e;--err:#ef4444;--ring:rgba(56,189,248,.35)
}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font:16px/1.8 ui-rounded,system-ui,Segoe UI,Arial;color:var(--txt);
background:radial-gradient(1100px 700px at 10% 0%,#0ea5e960 0%,transparent 50%),
radial-gradient(1100px 700px at 100% 20%,#22c55e40 0%,transparent 55%),
linear-gradient(160deg,var(--bg1),var(--bg2)) fixed}
.topbar{position:sticky;top:0;z-index:20;display:flex;justify-content:space-between;align-items:center;
padding:14px 16px;border-bottom:1px solid var(--bor);background:rgba(0,0,0,.35);backdrop-filter:blur(8px)}
.brand{display:flex;align-items:center;gap:10px;font-weight:900}
.badge{border:1px solid var(--bor);border-radius:999px;padding:6px 10px;color:var(--mut);background:rgba(255,255,255,.06);font-size:12px}
.container{max-width:1100px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--bor);border-radius:16px;padding:16px}
.sep{height:1px;background:var(--bor);margin:10px 0;border-radius:999px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media(max-width:720px){.grid2{grid-template-columns:1fr}}

input,select,button{border:1px solid var(--bor);border-radius:12px;background:rgba(255,255,255,.06);color:var(--txt);padding:11px 12px;outline:none;transition:.15s}
input:focus,select:focus{border-color:var(--acc);box-shadow:0 0 0 4px var(--ring)}
button{cursor:pointer;font-weight:800;background:linear-gradient(135deg,#38bdf8,#22c55e);color:#fff}
button.ghost{background:rgba(255,255,255,.06);color:var(--txt)}
button.danger{background:#b91c1c}
.msg{font-size:12px;color:var(--mut);margin-top:6px}
.invalid{border-color:var(--err)!important}
.valid{border-color:var(--ok)!important}
.eye{position:absolute;inset-inline-end:10px;top:50%;transform:translateY(-50%);user-select:none;cursor:pointer;opacity:.85}
.field{position:relative}

.bottom{position:sticky;bottom:0;z-index:15;display:flex;gap:12px;justify-content:space-around;padding:14px;border-top:1px solid var(--bor);background:rgba(0,0,0,.35);backdrop-filter:blur(8px)}
.bottom button{flex:1} .bottom .active{box-shadow:0 0 0 3px var(--ring) inset}
.view.hidden{display:none}

/* Gate (Auth) */
.gate{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);z-index:40}
.box{width:min(640px,100%);background:rgba(255,255,255,.06);border:1px solid var(--bor);border-radius:18px;padding:16px}
.tabs{display:flex;gap:8px;border-bottom:1px solid var(--bor);margin-bottom:10px}
.tab{border:1px solid var(--bor);border-bottom:none;border-radius:12px 12px 0 0;background:rgba(255,255,255,.06);padding:10px 12px;color:var(--mut);cursor:pointer}
.tab.active{background:rgba(0,0,0,.12);color:var(--txt)}
.panel{display:none}.panel.show{display:block}

/* toast */
.toast{position:fixed;left:12px;right:12px;bottom:86px;background:#b91c1c;color:#fff;padding:12px;border-radius:14px;z-index:60;display:none}
.toast.show{display:block}
</style>
</head>
<body>

<header class="topbar">
  <div class="brand">🏛️ اتحاد طب بشري كفر الشيخ</div>
  <div id="status" class="badge">…</div>
</header>

<!-- ===== Gate (Sign Up / Sign In) ===== -->
<section id="gate" class="gate">
  <div class="box">
    <div class="tabs">
      <button class="tab active" data-tab="up" type="button">إنشاء حساب</button>
      <button class="tab" data-tab="in" type="button">تسجيل الدخول</button>
    </div>

    <!-- Sign Up -->
    <div id="p-up" class="panel show">
      <div class="grid2">
        <div class="field">
          <label class="msg">الإيميل</label>
          <input id="suEmail" inputmode="email" placeholder="you@example.com">
          <div class="msg" id="mSuEmail"></div>
        </div>
        <div>
          <label class="msg">اللغة</label>
          <select id="suLang"><option value="ar">العربية</option><option value="en">English</option></select>
        </div>

        <div class="field">
          <label class="msg">كلمة السر</label>
          <input id="suPass" type="password" placeholder="••••••••">
          <span class="eye" data-eye="suPass">👁️</span>
          <div class="msg" id="mSuPass"></div>
        </div>
        <div class="field">
          <label class="msg">تأكيد كلمة السر</label>
          <input id="suPass2" type="password" placeholder="••••••••">
          <span class="eye" data-eye="suPass2">👁️</span>
          <div class="msg" id="mSuPass2"></div>
        </div>

        <div class="field">
          <label class="msg">الاسم (اسم + عائلة)</label>
          <input id="suName" placeholder="محمد أحمد">
          <div class="msg" id="mSuName"></div>
        </div>
        <div class="field">
          <label class="msg">الموبايل</label>
          <input id="suPhone" inputmode="tel" placeholder="01xxxxxxxxx">
          <div class="msg" id="mSuPhone"></div>
        </div>

        <div class="field">
          <label class="msg">الدفعة</label>
          <input id="suBatch" placeholder="مثال: 12">
          <div class="msg" id="mSuBatch"></div>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btnUp" type="button" style="flex:1">إنشاء الحساب</button>
      </div>
      <div class="sep"></div>
      <button id="btnGoogleUp" type="button" style="width:100%">إنشاء/دخول بحساب Google</button>
      <div class="msg" id="hintUp" style="margin-top:8px"></div>
    </div>

    <!-- Sign In -->
    <div id="p-in" class="panel">
      <div class="grid2">
        <div class="field">
          <label class="msg">الإيميل</label>
          <input id="siEmail" inputmode="email" placeholder="you@example.com">
          <div class="msg" id="mSiEmail"></div>
        </div>
        <div class="field">
          <label class="msg">كلمة السر</label>
          <input id="siPass" type="password" placeholder="••••••••">
          <span class="eye" data-eye="siPass">👁️</span>
          <div class="msg" id="mSiPass"></div>
        </div>
        <div>
          <label class="msg">اللغة</label>
          <select id="siLang"><option value="ar">العربية</option><option value="en">English</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px;justify-content:space-between">
        <button id="btnIn" class="ghost" type="button">دخول</button>
        <button id="btnForgot" class="ghost" type="button">نسيت كلمة السر؟</button>
      </div>
      <div class="msg" id="hintIn" style="margin-top:8px"></div>
    </div>
  </div>
</section>

<!-- Forgot -->
<section id="fgBox" class="gate" style="display:none;background:rgba(0,0,0,.7)">
  <div class="box">
    <h3 style="margin:.2rem 0 8px">استرجاع كلمة السر</h3>
    <p class="msg">اكتب الإيميل + الموبايل + الدفعة. لو مطابقين هنرسل رابط التغيير على الإيميل.</p>
    <div class="grid2">
      <div><label class="msg">الإيميل</label><input id="fgEmail" inputmode="email"></div>
      <div><label class="msg">الموبايل</label><input id="fgPhone" inputmode="tel" placeholder="01xxxxxxxxx"></div>
      <div><label class="msg">الدفعة</label><input id="fgBatch"></div>
    </div>
    <div class="row" style="margin-top:10px;justify-content:space-between">
      <button id="btnFgSend" type="button">تحقق وأرسل الرابط</button>
      <button id="btnFgClose" class="ghost" type="button">إغلاق</button>
    </div>
    <div class="msg" id="hintFg" style="margin-top:8px"></div>
  </div>
</section>

<!-- ===== App after login ===== -->
<main id="app" class="container" style="display:none">
  <section id="v-home" class="view">
    <div class="card">
      <h2 style="margin:0 0 6px">جاهزين</h2>
      <p>تم تسجيل الدخول بنجاح. سنضيف قريبًا البوستات والحضور بالـQR ولوحة المشرف.</p>
      <div class="sep"></div>
      <p class="msg">لو الشارة فوق فيها ✓ مرتبط فكل شيء تمام.</p>
    </div>
  </section>

  <section id="v-profile" class="view hidden">
    <div class="card">
      <h2 style="margin-top:0">بروفايل</h2>
      <div class="grid2">
        <div><label class="msg">الاسم</label><input id="pName"></div>
        <div><label class="msg">البريد</label><input id="pEmail" disabled></div>
        <div><label class="msg">الموبايل</label><input id="pPhone"></div>
        <div><label class="msg">الدفعة</label><input id="pBatch"></div>
      </div>
      <div class="row" style="margin-top:10px"><button id="btnSaveProfile" class="ghost" type="button">حفظ (محليًا الآن)</button></div>
    </div>
  </section>

  <section id="v-settings" class="view hidden">
    <div class="card">
      <h2 style="margin-top:0">إعدادات</h2>
      <div class="grid2">
        <div><label class="msg">الوضع</label><button id="themeToggle" class="ghost" type="button">تبديل ليلي/نهاري</button></div>
        <div><label class="msg">حجم النص</label>
          <select id="fs"><option value="16">افتراضي</option><option value="17">كبير</option><option value="18">أكبر</option></select>
        </div>
        <div><label class="msg">اللغة</label><select id="lang"><option value="ar">العربية</option><option value="en">English</option></select></div>
        <div><label class="msg">جلسة</label><button id="btnOut" class="danger" type="button" style="width:100%">تسجيل الخروج</button></div>
      </div>
      <div class="sep"></div>
      <button id="clear" class="ghost" type="button">مسح تفضيلات الجهاز</button>
    </div>
  </section>
</main>

<nav id="nav" class="bottom" style="display:none">
  <button class="active" data-view="v-home" type="button">🏠 عام</button>
  <button data-view="v-profile" type="button">👤 بروفايل</button>
  <button data-view="v-settings" type="button">⚙️ إعدادات</button>
</nav>

<div id="toast" class="toast"></div>

<!-- ===== Firebase (compat) ===== -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
/* ---------- UI helpers ---------- */
(function(){
  // tabs
  const tabs=document.querySelectorAll('.tab'), panels={up:document.getElementById('p-up'),in:document.getElementById('p-in')};
  tabs.forEach(t=>t.onclick=()=>{tabs.forEach(x=>x.classList.remove('active'));t.classList.add('active');Object.values(panels).forEach(p=>p.classList.remove('show'));panels[t.dataset.tab].classList.add('show')});
  // eyes
  document.querySelectorAll('.eye').forEach(e=>e.onclick=()=>{const id=e.getAttribute('data-eye'); const i=document.getElementById(id); i.type=(i.type==='password'?'text':'password')});
  // theme + font
  const th=localStorage.getItem('theme'); if(th==='light') document.documentElement.classList.add('light');
  const tgl=document.getElementById('themeToggle'); if(tgl) tgl.onclick=()=>{const isLight=document.documentElement.classList.toggle('light'); localStorage.setItem('theme',isLight?'light':'dark')};
  const fs=document.getElementById('fs'), saved=localStorage.getItem('fs'); if(saved) document.body.style.fontSize=saved+'px';
  if(fs){ fs.value=saved||'16'; fs.onchange=()=>{document.body.style.fontSize=fs.value+'px'; localStorage.setItem('fs',fs.value)}}
  // nav
  const views=document.querySelectorAll('.view'); const navBtns=document.querySelectorAll('#nav button');
  function show(id){views.forEach(v=>v.classList.add('hidden'));document.getElementById(id).classList.remove('hidden');navBtns.forEach(b=>b.classList.toggle('active',b.dataset.view===id))}
  navBtns.forEach(b=>b.onclick=()=>show(b.dataset.view)); show('v-home');
})();
</script>

<script>
/* ---------- Firebase logic ---------- */
const cfg={apiKey:"AIzaSyDfiO-4J0DIHSKZo_vdBXeS343eJ0x4pYo",authDomain:"ittihad-med-kfs.firebaseapp.com",projectId:"ittihad-med-kfs",appId:"1:323302922960:web:3343605d75d2a5147cdcd5"};
firebase.initializeApp(cfg);
const auth=firebase.auth(), db=firebase.firestore();

const $=id=>document.getElementById(id);
const toast=(t)=>{const x=$('toast');x.textContent=t;x.classList.add('show');setTimeout(()=>x.classList.remove('show'),2500)}
const L=s=>(s||'').trim(), emailOk=e=>/^\S+@\S+\.\S+$/.test(e||''), phoneOk=p=>/^01\d{9}$/.test((p||'').replace(/\s+/g,'')), nameOk=n=>L(n).length>=5 && /\s/.test(L(n));
const mark=(el,ok,msg)=>(el&&(el.classList.remove('invalid','valid'),el.classList.add(ok?'valid':'invalid'), msg&& (msg.textContent='')));

/* status */
db.collection('ping').doc('hello').set({t:Date.now()}).then(()=>$('status').textContent='✓ مرتبط').catch(()=>$('status').textContent='✓ مرتبط');

/* ---- Sign Up ---- */
$('btnUp').onclick=async ()=>{
  const email=L($('suEmail').value), pass=$('suPass').value, pass2=$('suPass2').value, name=L($('suName').value),
        phone=L($('suPhone').value), batch=L($('suBatch').value), lang=$('suLang').value;
  let ok=true;
  if(!emailOk(email)){ok=false;$('suEmail').classList.add('invalid');$('mSuEmail').textContent='بريد غير صحيح'} else {$('suEmail').classList.remove('invalid')}
  if(pass.length<6){ok=false;$('suPass').classList.add('invalid');$('mSuPass').textContent='٦ أحرف على الأقل'} else {$('suPass').classList.remove('invalid')}
  if(pass!==pass2){ok=false;$('suPass2').classList.add('invalid');$('mSuPass2').textContent='غير مطابق'} else {$('suPass2').classList.remove('invalid')}
  if(!nameOk(name)){ok=false;$('suName').classList.add('invalid');$('mSuName').textContent='اكتب اسم + عائلة (≥5)'} else {$('suName').classList.remove('invalid')}
  if(!phoneOk(phone)){ok=false;$('suPhone').classList.add('invalid');$('mSuPhone').textContent='الصيغة 01xxxxxxxxx'} else {$('suPhone').classList.remove('invalid')}
  if(!batch){ok=false;$('suBatch').classList.add('invalid');$('mSuBatch').textContent='اكتب الدفعة'} else {$('suBatch').classList.remove('invalid')}
  if(!ok) return;

  try{
    const c=await auth.createUserWithEmailAndPassword(email,pass);
    await db.collection('users').doc(c.user.uid).set({displayName:name,email,phone,batch,lang,createdAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
    localStorage.setItem('lang',lang);
    $('hintUp').textContent='تم إنشاء الحساب ✔'; toast('تم الإنشاء ✔ — يمكنك تسجيل الدخول الآن');
  }catch(e){
    if((e.code||'').includes('email-already-in-use')){$('mSuEmail').textContent='الإيميل مستخدم';$('suEmail').classList.add('invalid')}
    $('hintUp').textContent=e.message||String(e);
  }
};

/* Google */
$('btnGoogleUp').onclick=async()=>{ try{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }catch(e){ $('hintUp').textContent=e.message||String(e);} };

/* ---- Sign In ---- */
$('btnIn').onclick=async ()=>{
  const email=L($('siEmail').value), pass=$('siPass').value, lang=$('siLang').value;
  if(!emailOk(email)){ $('mSiEmail').textContent='بريد غير صحيح'; $('siEmail').classList.add('invalid'); return}
  try{ await auth.signInWithEmailAndPassword(email,pass); localStorage.setItem('lang',lang); $('hintIn').textContent='' }
  catch(e){
    const c=e.code||''; if(c.includes('wrong-password')||c.includes('invalid-credential')){$('mSiPass').textContent='كلمة السر غير صحيحة';$('siPass').classList.add('invalid')}
    if(c.includes('user-not-found')){$('mSiEmail').textContent='لا يوجد حساب بهذا البريد';$('siEmail').classList.add('invalid')}
    $('hintIn').textContent=e.message||String(e);
  }
};

/* Forgot */
$('btnForgot').onclick=()=>{$('fgBox').style.display='grid';$('hintFg').textContent=''};
$('btnFgClose').onclick=()=>{$('fgBox').style.display='none'};
$('btnFgSend').onclick=async ()=>{
  const email=L($('fgEmail').value), phone=L($('fgPhone').value), batch=L($('fgBatch').value);
  if(!emailOk(email)) return $('hintFg').textContent='اكتب بريد صحيح';
  try{
    const q=await db.collection('users').where('email','==',email).limit(1).get();
    if(q.empty) return $('hintFg').textContent='لا يوجد حساب بهذا البريد';
    const u=q.docs[0].data();
    if((u.phone||'')!==phone || (u.batch||'')!==batch) return $('hintFg').textContent='التحقق فشل: رقم أو دفعة غير مطابقة';
    await auth.sendPasswordResetEmail(email);
    $('hintFg').textContent='تم إرسال رابط إعادة التعيين ✔';
  }catch(e){ $('hintFg').textContent=e.message||String(e) }
};

/* Session */
const gate=$('gate'), app=$('app'), nav=$('nav');
const showApp=()=>{ gate.style.display='none'; app.style.display='block'; nav.style.display='flex' }
const hideApp=()=>{ app.style.display='none'; nav.style.display='none'; gate.style.display='grid' }

auth.onAuthStateChanged(async(u)=>{
  if(u){ // logged in
    showApp();
    $('status').textContent = (['dr.emara10@gmail.com'].includes((u.email||'').toLowerCase()) ? '👑 Admin — ' : 'عضو — ') + (u.email||'');
    // hydrate profile
    $('pEmail').value=u.email||''; 
    try{ const d=await db.collection('users').doc(u.uid).get(); if(d.exists){ const v=d.data(); $('pName').value=v.displayName||''; $('pPhone').value=v.phone||''; $('pBatch').value=v.batch||''; } }catch(_){}
  }else{ hideApp(); $('status').textContent='✓ مرتبط' }
});

$('btnOut').onclick=()=>auth.signOut();

/* profile local save */
$('btnSaveProfile').onclick=()=>{ const data={n:$('pName').value,e:$('pEmail').value,ph:$('pPhone').value,b:$('pBatch').value}; localStorage.setItem('profileDraft',JSON.stringify(data)); toast('تم الحفظ محليًا') }
const d=localStorage.getItem('profileDraft'); if(d){const v=JSON.parse(d);$('pName').value=v.n||'';$('pEmail').value=v.e||'';$('pPhone').value=v.ph||'';$('pBatch').value=v.b||''}
$('clear').onclick=()=>{localStorage.clear(); location.reload()}
</script>
</body>
  </html>
